<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>河南省商务中等职业学校</title>
  
  
  <link href="https://www.hnswxx.cn/atom.xml" rel="self"/>
  
  <link href="https://www.hnswxx.cn/"/>
  <updated>2021-12-11T12:57:19.556Z</updated>
  <id>https://www.hnswxx.cn/</id>
  
  <author>
    <name>网络搭建竞赛组</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>ldap基础配置与案例</title>
    <link href="https://www.hnswxx.cn/2021/12/11/ldap-basic-configuration/"/>
    <id>https://www.hnswxx.cn/2021/12/11/ldap-basic-configuration/</id>
    <published>2021-12-11T12:35:16.000Z</published>
    <updated>2021-12-11T12:57:19.556Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h4 id="ldap案例"><a href="#ldap案例" class="headerlink" title="ldap案例"></a>ldap案例</h4><p>配置 ldc 为 Linux 端的域控制器，使用 LDAP 作为统一认证服务，启用 SSL 模式，只允许 使用域名的方式访问 LDAP，集成 Kerberos 的方式作为认证中心，域名为 bigone.com， 并且建立用户 linuxadmin 作为管理用户；</p><p>在 ldc 的 LDAP 上创建组织单位和用户组，采用对应部门名称的中文全拼命名，每个组创 建 2 个用户，人力部用户：hr1~hr2、营销部用户：sale1 sale2、财务部用户：fin1 fin2； 技术部用户：te1 te2。</p><h4 id="服务端配置"><a href="#服务端配置" class="headerlink" title="服务端配置"></a>服务端配置</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">安装关于openldap相关的软件包</span></span><br><span class="line">yum install -y openldap openldap-clients openldap-servers migrationtools</span><br><span class="line"><span class="meta">#</span><span class="bash">创建管理用户linuxadmin</span> </span><br><span class="line">useradd linuxadmin</span><br><span class="line"><span class="meta">#</span><span class="bash">生成密钥文件（记下生成出的值，后面要用）：</span></span><br><span class="line">slappasswd -s linuxadmin -n &gt; /etc/openldap/passwd</span><br><span class="line">cat /etc/openldap/passwd </span><br><span class="line">&#123;SSHA&#125;+J7U5ufZH/nm4Svs/VMMWmabVPNoi5ll</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">根据题目创建证书文件</span></span><br><span class="line"><span class="meta">#</span><span class="bash">因为LDAP目录服务是以明文的方式在网络中传输数据的（包括密码），这样真的很不安全，所以我们采用TLS加密机制来解决这个问题，使用openssl工具生成X509格式的证书文件：</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">进入ldap证书文件夹</span></span><br><span class="line">cd /etc/openldap/certs/</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">创建自签名证书</span></span><br><span class="line">openssl req -new -x509 -nodes -out /etc/openldap/certs/cert.pem -keyout /etc/openldap/certs/priv.pem -days 365</span><br><span class="line">Generating a 2048 bit RSA private key</span><br><span class="line">..........................................+++</span><br><span class="line">..............................................................+++</span><br><span class="line">writing new private key to &#x27;/etc/openldap/certs/priv.pem&#x27;</span><br><span class="line">-----</span><br><span class="line">You are about to be asked to enter information that will be incorporated</span><br><span class="line">into your certificate request.</span><br><span class="line">What you are about to enter is what is called a Distinguished Name or a DN.</span><br><span class="line">There are quite a few fields but you can leave some blank</span><br><span class="line">For some fields there will be a default value,</span><br><span class="line">If you enter &#x27;.&#x27;, the field will be left blank.</span><br><span class="line">-----</span><br><span class="line">Country Name (2 letter code) [XX]:CN</span><br><span class="line">State or Province Name (full name) []:GuangDong</span><br><span class="line">Locality Name (eg, city) [Default City]:GuangZhou</span><br><span class="line">Organization Name (eg, company) [Default Company Ltd]:skillsjnds</span><br><span class="line">Organizational Unit Name (eg, section) []:system</span><br><span class="line">Common Name (eg, your name or your server hostname) []:ldc.bigone.com</span><br><span class="line">Email Address []:敲击回车</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">修改证书的所属与权限</span></span><br><span class="line">chown ldap:ldap *</span><br><span class="line">chmod 600 *</span><br><span class="line">total 100</span><br><span class="line">-rw-------. 1 ldap ldap  1021 Dec  3 08:20 ca.csr</span><br><span class="line">-rw-------. 1 ldap ldap 65536 Dec  3 08:14 cert8.db</span><br><span class="line">-rw-------. 1 ldap ldap  4478 Dec  3 08:20 cert.pem</span><br><span class="line">-rw-------. 1 ldap ldap 16384 Dec  3 08:14 key3.db</span><br><span class="line">-rw-------. 1 ldap ldap    45 Dec  2 21:29 password</span><br><span class="line">-rw-------. 1 ldap ldap  1675 Dec  3 08:17 priv.pem</span><br><span class="line">-rw-------. 1 ldap ldap 16384 Dec  2 21:29 secmod.db</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">复制一份LDAP的配置模板</span></span><br><span class="line">cp /usr/share/openldap-servers/DB_CONFIG.example /var/lib/ldap/DB_CONFIG</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">生成数据库文件（不用担心报错信息）：</span></span><br><span class="line">slaptest </span><br><span class="line">61a96371 hdb_db_open: database &quot;dc=my-domain,dc=com&quot;: db_open(/var/lib/ldap/id2entry.bdb) failed: No.</span><br><span class="line">61a96371 backend_startup_one (type=hdb, suffix=&quot;dc=my-domain,dc=com&quot;): bi_db_open failed! (2)</span><br><span class="line">slap_startup failed (test would succeed using the -u switch)</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">修改LDAP数据库的所属主与组：</span></span><br><span class="line">chown ldap:ldap /var/lib/ldap/*</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">启动sladp服务程序并设置为开机启动</span></span><br><span class="line">systemctl restart slapd.service</span><br><span class="line">systemctl enable slapd.service </span><br><span class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/slapd.service to /usr/lib/systemd/s.</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>在LDAP目录服务中使用<strong>LDIF</strong>(LDAP <strong>I</strong>nterchange <strong>F</strong>ormat)格式来保存信息，而LDIF是一种标准的文本文件且可以随意的导入导出，所以我们需要有一种“格式”标准化LDIF文件的写法，这中格式叫做“schema”，schema用于指定一个目录中所包含对象的类型，以及每一个类型中的可选属性，我们可以将schema理解为面向对象程序设计中的“类”，通过“类”定义出具体的对象，因此其实LDIF数据条目则都是通过schema数据模型创建出来的具体对象：</p><p><strong>ldapadd<a href="https://www.linuxcool.com/">命令</a>用于将LDIF文件导入到目录服务数据库中，格式为：“ldapadd [参数] LDIF文件”。</strong></p><table><thead><tr><th>参数</th><th>作用</th></tr></thead><tbody><tr><td>-x</td><td>进行简单认证。</td></tr><tr><td>-D</td><td>用于绑定服务器的dn。</td></tr><tr><td>-h：</td><td>目录服务的地址。</td></tr><tr><td>-w：</td><td>绑定dn的密码。</td></tr><tr><td>-f：</td><td>使用LDIF文件进行条目添加的文件。</td></tr></tbody></table><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#添加cosine和nis模块：</span></span><br><span class="line"><span class="built_in">cd</span> /etc/openldap/schema/</span><br><span class="line">ldapadd -Y EXTERNAL -H ldapi:/// -D <span class="string">&quot;cn=config&quot;</span> -f cosine.ldif</span><br><span class="line">SASL/EXTERNAL authentication started</span><br><span class="line">SASL username: gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth</span><br><span class="line">SASL SSF: 0</span><br><span class="line">adding new entry <span class="string">&quot;cn=cosine,cn=schema,cn=config&quot;</span></span><br><span class="line"></span><br><span class="line">ldapadd -Y EXTERNAL -H ldapi:/// -D <span class="string">&quot;cn=config&quot;</span> -f nis.ldif</span><br><span class="line">SASL/EXTERNAL authentication started</span><br><span class="line">SASL username: gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth</span><br><span class="line">SASL SSF: 0</span><br><span class="line">adding new entry <span class="string">&quot;cn=nis,cn=schema,cn=config&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#创建/etc/openldap/changes.ldif文件，并将下面的信息复制进去：（注意有一处要修改的地方）</span></span><br><span class="line">dn: olcDatabase=&#123;2&#125;hdb,cn=config</span><br><span class="line">changetype: modify</span><br><span class="line">replace: olcSuffix</span><br><span class="line">olcSuffix: dc=bigone,dc=com</span><br><span class="line"></span><br><span class="line">dn: olcDatabase=&#123;2&#125;hdb,cn=config</span><br><span class="line">changetype: modify</span><br><span class="line">replace: olcRootDN</span><br><span class="line">olcRootDN: cn=linuxadmin,dc=bigone,dc=com</span><br><span class="line"></span><br><span class="line">dn: olcDatabase=&#123;2&#125;hdb,cn=config</span><br><span class="line">changetype: modify</span><br><span class="line">replace: olcRootPW</span><br><span class="line">olcRootPW: 此处输入之前生成的密码（如&#123;SSHA&#125;v/GJvGG8SbIuCxhfTDVhkmWEuz2afNIR）</span><br><span class="line"></span><br><span class="line">dn: cn=config</span><br><span class="line">changetype: modify</span><br><span class="line">replace: olcTLSCertificateFile</span><br><span class="line">olcTLSCertificateFile: /etc/openldap/certs/cert.pem</span><br><span class="line"></span><br><span class="line">dn: cn=config</span><br><span class="line">changetype: modify</span><br><span class="line">replace: olcTLSCertificateKeyFile</span><br><span class="line">olcTLSCertificateKeyFile: /etc/openldap/certs/priv.pem</span><br><span class="line"></span><br><span class="line">dn: cn=config</span><br><span class="line">changetype: modify</span><br><span class="line">replace: olcLogLevel</span><br><span class="line">olcLogLevel: -1</span><br><span class="line"></span><br><span class="line">dn: olcDatabase=&#123;1&#125;monitor,cn=config</span><br><span class="line">changetype: modify</span><br><span class="line">replace: olcAccess</span><br><span class="line">olcAccess: &#123;0&#125;to * by dn.base=<span class="string">&quot;gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth&quot;</span> <span class="built_in">read</span> by dn.base=<span class="string">&quot;cn=linuxadmin,dc=bigone,dc=com&quot;</span> <span class="built_in">read</span> by * none</span><br><span class="line"></span><br><span class="line"><span class="comment">#将新的配置文件更新到slapd服务程序：</span></span><br><span class="line">ldapmodify -Y EXTERNAL -H ldapi:/// -f /etc/openldap/changes.ldif</span><br><span class="line">SASL/EXTERNAL authentication started</span><br><span class="line">SASL username: gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth</span><br><span class="line">SASL SSF: 0</span><br><span class="line">modifying entry <span class="string">&quot;olcDatabase=&#123;2&#125;hdb,cn=config&quot;</span></span><br><span class="line">modifying entry <span class="string">&quot;olcDatabase=&#123;2&#125;hdb,cn=config&quot;</span></span><br><span class="line">modifying entry <span class="string">&quot;olcDatabase=&#123;2&#125;hdb,cn=config&quot;</span></span><br><span class="line">modifying entry <span class="string">&quot;cn=config&quot;</span></span><br><span class="line">modifying entry <span class="string">&quot;cn=config&quot;</span></span><br><span class="line">modifying entry <span class="string">&quot;cn=config&quot;</span></span><br><span class="line">modifying entry <span class="string">&quot;olcDatabase=&#123;1&#125;monitor,cn=config&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#创建/etc/openldap/base.ldif文件，并将下面的信息复制进去：</span></span><br><span class="line">dn: dc=bigone,dc=com</span><br><span class="line">dc: bigone</span><br><span class="line">objectClass: top</span><br><span class="line">objectClass: domain</span><br><span class="line"></span><br><span class="line">dn: ou=renlibu,dc=bigone,dc=com</span><br><span class="line">ou: renlibu</span><br><span class="line">objectClass: top</span><br><span class="line">objectClass: organizationalUnit</span><br><span class="line"></span><br><span class="line">dn: ou=yingxiaobu,dc=bigone,dc=com</span><br><span class="line">ou: yingxiaobu</span><br><span class="line">objectClass: top</span><br><span class="line">objectClass: organizationalUnit</span><br><span class="line"></span><br><span class="line">dn: ou=caiwubu,dc=bigone,dc=com</span><br><span class="line">ou: caiwubu</span><br><span class="line">objectClass: top</span><br><span class="line">objectClass: organizationalUnit</span><br><span class="line"></span><br><span class="line">dn: ou=jishubu,dc=bigone,dc=com</span><br><span class="line">ou: jishubu</span><br><span class="line">objectClass: top</span><br><span class="line">objectClass: organizationalUnit</span><br><span class="line"></span><br><span class="line"><span class="comment">#创建目录的结构服务：</span></span><br><span class="line"><span class="comment">#创建组织单元</span></span><br><span class="line"></span><br><span class="line">ldapadd -x -w linuxadmin -D cn=linuxadmin,dc=bigone,dc=com -f /etc/openldap/base.ldif</span><br><span class="line">adding new entry <span class="string">&quot;dc=bigone,dc=com&quot;</span></span><br><span class="line"></span><br><span class="line">adding new entry <span class="string">&quot;ou=renlibu,dc=bigone,dc=com&quot;</span></span><br><span class="line"></span><br><span class="line">adding new entry <span class="string">&quot;ou=yingxiaobu,dc=bigone,dc=com&quot;</span></span><br><span class="line"></span><br><span class="line">adding new entry <span class="string">&quot;ou=caiwubu,dc=bigone,dc=com&quot;</span></span><br><span class="line"></span><br><span class="line">adding new entry <span class="string">&quot;ou=jishubu,dc=bigone,dc=com&quot;</span></span><br><span class="line"></span><br><span class="line">adding new entry <span class="string">&quot;ou=admin,dc=bigone,dc=com&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#在本机上创建对应的用户和组</span></span><br><span class="line">groupadd renlibu;groupadd yingxiaobu;groupadd caiwubu;groupadd jishubu;groupadd admin</span><br><span class="line"><span class="comment">#创建对应的用户并且设置到组</span></span><br><span class="line">useradd hr1 -g renlibu;useradd hr2 -g renlibu</span><br><span class="line">useradd sale1 -g yingxiaobu;useradd sale2 -g yingxiaobu</span><br><span class="line">useradd fin1 -g caiwubu;useradd fin2 -g caiwubu</span><br><span class="line">useradd te1 -g jishubu;useradd te2 -g jishubu</span><br><span class="line"></span><br><span class="line"><span class="comment">#更改linuxadmin的组为admin</span></span><br><span class="line">usermod linuxadmin -g admin</span><br><span class="line"></span><br><span class="line"><span class="comment">#设置帐户的迁移（修改第71与74行）：</span></span><br><span class="line">/usr/share/migrationtools/migrate_common.ph</span><br><span class="line"><span class="variable">$DEFAULT_MAIL_DOMAIN</span> = <span class="string">&quot;bigone.com&quot;</span>;</span><br><span class="line"><span class="variable">$DEFAULT_BASE</span> = <span class="string">&quot;dc=bigone,dc=com&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">#将当前系统中的用户迁移至目录服务：只演示财务部的</span></span><br><span class="line"> <span class="built_in">cd</span> /usr/share/migrationtools/</span><br><span class="line"><span class="comment">#过略出renlibu部的用户</span></span><br><span class="line">cat /etc/passwd | grep hr | grep home</span><br><span class="line"><span class="comment">#将这些用户导出到caiwuuser下</span></span><br><span class="line">cat /etc/passwd | grep hr | grep home &gt; caiwuuser</span><br><span class="line"><span class="comment">#将财务部的用户变成ldif格式</span></span><br><span class="line">./migrate_passwd.pl caiwuuser caiwuuser.ldif</span><br><span class="line"><span class="comment">#修改该ldif文件里面的用户组织单元为caiwubu ou组织单元</span></span><br><span class="line">dn: uid=hr1,ou=caiwubu,dc=bigone,dc=com <span class="comment">#修改</span></span><br><span class="line">uid: hr1 </span><br><span class="line">cn: hr1 </span><br><span class="line">objectClass: account</span><br><span class="line">objectClass: posixAccount</span><br><span class="line">objectClass: top </span><br><span class="line">objectClass: shadowAccount</span><br><span class="line">userPassword: &#123;crypt&#125;!!</span><br><span class="line">shadowLastChange: 18964</span><br><span class="line">shadowMin: 0</span><br><span class="line">shadowMax: 99999</span><br><span class="line">shadowWarning: 7</span><br><span class="line">loginShell: /bin/bash</span><br><span class="line">uidNumber: 1001</span><br><span class="line">gidNumber: 1001</span><br><span class="line">homeDirectory: /home/hr1</span><br><span class="line"></span><br><span class="line">dn: uid=hr2,ou=caiwubu,dc=bigone,dc=com <span class="comment">#修改</span></span><br><span class="line">uid: hr2 </span><br><span class="line">cn: hr2 </span><br><span class="line">objectClass: account</span><br><span class="line">objectClass: posixAccount</span><br><span class="line">objectClass: top </span><br><span class="line">objectClass: shadowAccount</span><br><span class="line">userPassword: &#123;crypt&#125;!!</span><br><span class="line">shadowLastChange: 18964</span><br><span class="line">shadowMin: 0</span><br><span class="line">shadowMax: 99999</span><br><span class="line">shadowWarning: 7</span><br><span class="line">loginShell: /bin/bash</span><br><span class="line">uidNumber: 1002</span><br><span class="line">gidNumber: 1001</span><br><span class="line">homeDirectory: /home/hr2</span><br><span class="line"></span><br><span class="line"><span class="comment">#导入到目录里</span></span><br><span class="line">ldapadd -x -w linuxadmin -D cn=linuxadmin,dc=bigone,dc=com -f caiwuuser.ldif </span><br><span class="line">adding new entry <span class="string">&quot;uid=hr1,ou=caiwubu,dc=bigone,dc=com&quot;</span></span><br><span class="line"></span><br><span class="line">adding new entry <span class="string">&quot;uid=hr2,ou=caiwubu,dc=bigone,dc=com&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#过略出财务部组</span></span><br><span class="line">cat /etc/group | grep caiwubu &gt; caiwugroup</span><br><span class="line"><span class="comment">#将财务部组用户变成ldif格式</span></span><br><span class="line">./migrate_group.pl caiwugroup caiwugroup.ldif</span><br><span class="line"><span class="comment">#修改该ldif文件里面的组的组织单元为caiwubu ou组织单元 ou=caiwubu</span></span><br><span class="line">dn: cn=caiwubu,ou=caiwubu,dc=bigone,dc=com <span class="comment">#修改</span></span><br><span class="line">objectClass: posixGroup</span><br><span class="line">objectClass: top </span><br><span class="line">cn: caiwubu</span><br><span class="line">userPassword: &#123;crypt&#125;x</span><br><span class="line">gidNumber: 1003</span><br><span class="line"><span class="comment">#导入到目录中</span></span><br><span class="line">ldapadd -x -w linuxadmin -D cn=linuxadmin,dc=bigone,dc=com -f caiwugroup.ldif </span><br><span class="line">adding new entry <span class="string">&quot;cn=caiwubu,ou=caiwubu,dc=bigone,dc=com&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#查询用户</span></span><br><span class="line">ldapsearch -x cn=fin1 -b dc=bigone,dc=com</span><br><span class="line"><span class="comment"># extended LDIF</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># LDAPv3</span></span><br><span class="line"><span class="comment"># base &lt;dc=bigone,dc=com&gt; with scope subtree</span></span><br><span class="line"><span class="comment"># filter: cn=fin1</span></span><br><span class="line"><span class="comment"># requesting: ALL</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># fin1, caiwubu, bigone.com</span></span><br><span class="line">dn: uid=fin1,ou=caiwubu,dc=bigone,dc=com</span><br><span class="line">uid: fin1</span><br><span class="line">cn: fin1</span><br><span class="line">objectClass: account</span><br><span class="line">objectClass: posixAccount</span><br><span class="line">objectClass: top</span><br><span class="line">objectClass: shadowAccount</span><br><span class="line">userPassword:: e2NyeXB0fSEh</span><br><span class="line">shadowLastChange: 18964</span><br><span class="line">shadowMin: 0</span><br><span class="line">shadowMax: 99999</span><br><span class="line">shadowWarning: 7</span><br><span class="line">loginShell: /bin/bash</span><br><span class="line">uidNumber: 1005</span><br><span class="line">gidNumber: 1003</span><br><span class="line">homeDirectory: /home/fin1</span><br><span class="line"></span><br><span class="line"><span class="comment"># search result</span></span><br><span class="line">search: 2</span><br><span class="line">result: 0 Success</span><br><span class="line"></span><br><span class="line"><span class="comment"># numResponses: 2</span></span><br><span class="line"><span class="comment"># numEntries: 1</span></span><br></pre></td></tr></table></figure><h4 id="客户端配置"><a href="#客户端配置" class="headerlink" title="客户端配置"></a>客户端配置</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#安装ldap客户端软件</span></span><br><span class="line">yum install openldap-clients nss-pam-ldapd authconfig-gtk pam_krb5 -y</span><br><span class="line"><span class="comment">#把证书考入ldap客户端的证书存放目录</span></span><br><span class="line">/etc/openldap/cacerts</span><br><span class="line">-rw-r--r--. 1 root root 1285 Dec  3 14:25 cert.pem</span><br><span class="line"><span class="comment">#然后打开authconfig-tui</span></span><br><span class="line">authconfig-tui</span><br></pre></td></tr></table></figure><p>选择使用LDAP</p><p><a href="https://imgtu.com/i/o7bmUP"><img src="https://s4.ax1x.com/2021/12/11/o7bmUP.png" alt="o7bmUP.png"></a></p><p>点击下一步 NEXT</p><p>选择Use TLS 输入ldap服务器信息 点击ok过后就完成客户端配置了</p><p><a href="https://imgtu.com/i/o7btU0"><img src="https://s4.ax1x.com/2021/12/11/o7btU0.png" alt="o7btU0.png"></a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;/assets/css/APlayer.min.css&quot;&gt;&lt;script src=&quot;/assets/js/APlayer.min.js&quot; cla</summary>
      
    
    
    
    <category term="Linux" scheme="https://www.hnswxx.cn/categories/Linux/"/>
    
    
    <category term="Centos7" scheme="https://www.hnswxx.cn/tags/Centos7/"/>
    
    <category term="ldap" scheme="https://www.hnswxx.cn/tags/ldap/"/>
    
  </entry>
  
  <entry>
    <title>掌握Windows Server 2012 网卡聚合（NIC Teaming）</title>
    <link href="https://www.hnswxx.cn/2021/12/11/nic-teaming/"/>
    <id>https://www.hnswxx.cn/2021/12/11/nic-teaming/</id>
    <published>2021-12-11T01:08:37.000Z</published>
    <updated>2021-12-11T01:21:02.000Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>Windows Server 2012的推出被称为“云操作系统“，想必这个操作系统在虚拟化领域，在网络和存储层面，在接入和安全层面都会有很有实力的功能体现。今天给大家介绍的网卡聚合能力就是充分利用汇总方式提高服务器整体网络性能，进而实现在高密度业务负载环境，高可用网络环境下的需求，当然除了网卡聚合功能单方面提升消除CPU的瓶颈也是重点，例如Offload卡，SRIOV, RSS，VMQ队列等等技术在Server 2012中你都能找到配套的核心技术支撑。今天这篇博客重点介绍一下Windows Server 2012中网卡聚合的功能。</p><p>说到网卡聚合，可能大家并不陌生，而且这个在”虚拟化世界“里尤为重要的功能，原来Windows Server 2008 R2中并不能提供支持，而是需要依靠HP，DELL，Intel，Broadcom等公司自己提供的软件进行设置和支持，但是这是不够的，要知道通过一个硬件厂商提供的聚合功能软件仅能对同种品牌的网卡进行统一的支持，这对于一个要求具有更多选择权和灵活性的数据中心而言是不够好的。当然你知道的，在Windows Server 2012中我们苦等的内置的，虚拟化环境所依赖的功能终于实现了在操作系统中的预置；因此充分了解合理利用这个功能是十分有益的。</p><p>那么什么是网络聚合或者Windows Server 2012中定义的网络聚合？在Server 2012中网络聚合有种称谓叫做LBOF（Load Balance and failover)字面上也很好理解，就是负载均衡同时实现故障切换功能的网络通道，熟悉这个LBOF灰常有意义，因为实现和查看网卡聚合状态需要用到的Powershell CMDLET就涉及了这个词汇；有了这个操作系统层面的功能，就可以将不同品牌的同质的网卡进行组合实现：</p><ol><li><p>网络带宽捆绑</p></li><li><p>当网络组件出现故障时可以被检测到并自动进行故障转移</p></li></ol><p>举例来说如果你不是配置成“主备”模式而是“双活”模式的网卡聚合，那么两个1GbE的千兆网卡可以实现2Gb的总吞吐，如果是两个万兆网卡就可以实现20Gb的总吞吐以此类推。<strong>Windows Server 2012支持多少个网卡进行捆绑呢？答案是32个！这是个绝对足够大的带宽：</strong></p><p> <a href="https://imgtu.com/i/oTpAiR"><img src="https://s1.ax1x.com/2021/12/11/oTpAiR.png" alt="oTpAiR.png"></a></p><p>Server 2012支持两种网络聚合模式，在配置网络聚合的时候默认的是选择第一种模式：</p><ol><li><p>交换机独立模式<br>这种模式最为通用，因为不要求交换机参与网络聚合，因此交换机并不知道在聚合网络中的网卡属于主机中一个网卡聚合组，所以网卡可以连接不同的交换机不过交换机独立模式并不要求聚合组中的网卡连接到不同的交换机。而且在连接不同交换机时采用的是主备模式，只有在连接在同一交换机时才可以实现负载均衡聚。</p></li><li><p>交换机依赖模式<br>这种模式需要交换机参与网络聚合，并且要求所有网络聚合组网卡连接到同一个物理交换机或者以级联多交换机方式实现的对外显示为单一物理交换机的方式；根据交换机支持的模式可以有两种模式选择：</p></li></ol><ul><li><p>通用的静态聚合模式即IEEE 802.3ad<br>这种模式需要在交换机上静态设置指定汇聚组中的网卡连接。由于这种方式需要静态指定，因此没有动态协商协议机制帮助交换机判断线缆连接的正确与否或是否有其他错误导致聚合失败。</p></li><li><p>动态聚合模式即IEEE 802.1ax或LACP（Link Aggregation Control Protocol 链路汇聚控制协议）<br>这种模式由于有了LACP协议的支持，可以动态的识别服务器和交换机的连接，进而实现动态地创建聚合组，添加和移除组成员等工作，现在多数交换机都支持LACP即802.1ax协议，不过也大多需要在服务器连接的交换机端口中手工启用此功能。</p></li></ul><p>通过图形方法配置，如果在Server 2012中启用了图形界面管理功能，可以利用服务器管理器简单的创建网络聚合。</p><p><a href="https://imgtu.com/i/oTp2OU"><img src="https://s1.ax1x.com/2021/12/11/oTp2OU.png" alt="oTp2OU.png"></a></p><p>当然，通过Powershell命令行是个很好的方式，先看看可以针对LBFO进行哪些操作：</p><p><a href="https://imgtu.com/i/oTphTJ"><img src="https://s1.ax1x.com/2021/12/11/oTphTJ.png" alt="oTphTJ.png"></a></p><p>创建一个网卡聚合组“NIC Teaming”，将所有本机物理网卡添加到这个组中，并且设置模式为交换机独立模式，负载均衡模式为默认哈希：</p><p><a href="https://imgtu.com/i/oTpof1"><img src="https://s1.ax1x.com/2021/12/11/oTpof1.png" alt="oTpof1.png"></a></p><p>看看创建之后的网络设备，是不是多了一个NIC Teaming网卡？</p><p><a href="https://imgtu.com/i/oTp7Sx"><img src="https://s1.ax1x.com/2021/12/11/oTp7Sx.png" alt="oTp7Sx.png"></a></p><p>当然，你也可以通过Powershell看到这个网络聚合网卡的状态：</p><p><a href="https://imgtu.com/i/oTpHl6"><img src="https://s1.ax1x.com/2021/12/11/oTpHl6.png" alt="oTpHl6.png"></a></p><p>本博客至此，你可能觉得还不过瘾啊，毕竟涉及类似负载均衡策略等很多方面都没涉及到，没关系；我在网上看到一个涉及网卡聚合方方面面的详尽文档，不敢独享这里分享给大家，感兴趣的别忘了收集哦：）</p><p><a href="http://www.microsoft.com/en-us/download/details.aspx?id=30160"> Windows Server 2012 NIC Teaming (LBFO) Deployment and Management</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;/assets/css/APlayer.min.css&quot;&gt;&lt;script src=&quot;/assets/js/APlayer.min.js&quot; cla</summary>
      
    
    
    
    <category term="Windows" scheme="https://www.hnswxx.cn/categories/Windows/"/>
    
    
    <category term="WindowServer2019" scheme="https://www.hnswxx.cn/tags/WindowServer2019/"/>
    
    <category term="nic" scheme="https://www.hnswxx.cn/tags/nic/"/>
    
  </entry>
  
  <entry>
    <title>centos8网关服务器（防火墙的nat转换）</title>
    <link href="https://www.hnswxx.cn/2021/12/10/centos8-gateway-server/"/>
    <id>https://www.hnswxx.cn/2021/12/10/centos8-gateway-server/</id>
    <published>2021-12-10T07:53:39.000Z</published>
    <updated>2021-12-10T09:00:53.000Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h3 id="环境介绍"><a href="#环境介绍" class="headerlink" title="环境介绍"></a>环境介绍</h3><table><thead><tr><th>主机名</th><th>网卡信息</th><th>角色</th></tr></thead><tbody><tr><td>client</td><td>IP1：10.10.80.102/24（仅主机）<br/> 网关：10.10.80.101<br/>DNS：114.114.114.114</td><td>客户端</td></tr><tr><td>gateway</td><td>IP1：10.10.80.101/24（仅主机）<br>IP2：10.10.70.101/24 （NAT）<br/> 网关：10.10.70.254<br/>DNS：114.114.114.114</td><td>网关</td></tr></tbody></table><h3 id="服务配置"><a href="#服务配置" class="headerlink" title="服务配置"></a>服务配置</h3><p><strong>gateway</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 开启转发</span></span><br><span class="line">echo &quot;net.ipv4.ip_forward = 1&quot; &gt;&gt; /etc/sysctl.conf</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 使转发生效</span></span><br><span class="line">sysctl -p</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">开启伪装IP</span></span><br><span class="line">firewall-cmd --add-masquerade --permanent</span><br><span class="line">success</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">配置NAT规则、</span></span><br><span class="line"><span class="meta">#</span><span class="bash">ens34是外网网卡</span></span><br><span class="line"><span class="meta">#</span><span class="bash">10.10.80.0/24 内网网段</span></span><br><span class="line">firewall-cmd --permanent --direct --passthrough ipv4 -t nat -I POSTROUTING -o ens34 -j MASQUERADE -s 10.10.80.0/24 </span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">防火墙重载</span></span><br><span class="line">firewall-cmd --reload </span><br><span class="line">success</span><br></pre></td></tr></table></figure><p><strong>client</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">客户端把网关与DNS配置好</span></span><br><span class="line">nmcli device show </span><br><span class="line">GENERAL.DEVICE:                         ens32</span><br><span class="line">GENERAL.TYPE:                           ethernet</span><br><span class="line">GENERAL.HWADDR:                         00:0C:29:09:74:CF</span><br><span class="line">GENERAL.MTU:                            1500</span><br><span class="line">GENERAL.STATE:                          100 (connected)</span><br><span class="line">GENERAL.CONNECTION:                     ens32</span><br><span class="line">GENERAL.CON-PATH:                       /org/freedesktop/NetworkManager/ActiveConnection/2</span><br><span class="line">WIRED-PROPERTIES.CARRIER:               on</span><br><span class="line">IP4.ADDRESS[1]:                         10.10.80.102/24</span><br><span class="line">IP4.GATEWAY:                            10.10.80.101</span><br><span class="line">IP4.ROUTE[1]:                           dst = 10.10.80.0/24, nh = 0.0.0.0, mt = 100</span><br><span class="line">IP4.ROUTE[2]:                           dst = 0.0.0.0/0, nh = 10.10.80.101, mt = 100</span><br><span class="line">IP4.DNS[1]:                             114.114.114.114</span><br><span class="line">IP6.ADDRESS[1]:                         fe80::219a:a6bc:daab:1943/64</span><br><span class="line">IP6.GATEWAY:                            --</span><br><span class="line">IP6.ROUTE[1]:                           dst = fe80::/64, nh = ::, mt = 100</span><br><span class="line">IP6.ROUTE[2]:                           dst = ff00::/8, nh = ::, mt = 256, table=255</span><br><span class="line"></span><br><span class="line">GENERAL.DEVICE:                         lo</span><br><span class="line">GENERAL.TYPE:                           loopback</span><br><span class="line">GENERAL.HWADDR:                         00:00:00:00:00:00</span><br><span class="line">GENERAL.MTU:                            65536</span><br><span class="line">GENERAL.STATE:                          10 (unmanaged)</span><br><span class="line">GENERAL.CONNECTION:                     --</span><br><span class="line">GENERAL.CON-PATH:                       --</span><br><span class="line">IP4.ADDRESS[1]:                         127.0.0.1/8</span><br><span class="line">IP4.GATEWAY:                            --</span><br><span class="line">IP6.ADDRESS[1]:                         ::1/128</span><br><span class="line">IP6.GATEWAY:                            --</span><br><span class="line">IP6.ROUTE[1]:                           dst = ::1/128, nh = ::, mt = 256</span><br><span class="line"><span class="meta">#</span><span class="bash">使用ping命令测试 是否能使用</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;/assets/css/APlayer.min.css&quot;&gt;&lt;script src=&quot;/assets/js/APlayer.min.js&quot; cla</summary>
      
    
    
    
    <category term="Linux" scheme="https://www.hnswxx.cn/categories/Linux/"/>
    
    
    <category term="Centos8" scheme="https://www.hnswxx.cn/tags/Centos8/"/>
    
    <category term="网关" scheme="https://www.hnswxx.cn/tags/%E7%BD%91%E5%85%B3/"/>
    
  </entry>
  
  <entry>
    <title>MariaDB 主从复制</title>
    <link href="https://www.hnswxx.cn/2021/12/10/mariadb-master-slave-replication/"/>
    <id>https://www.hnswxx.cn/2021/12/10/mariadb-master-slave-replication/</id>
    <published>2021-12-10T00:44:38.000Z</published>
    <updated>2021-12-10T01:01:47.000Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h3 id="MySQL-Replication"><a href="#MySQL-Replication" class="headerlink" title="MySQL Replication"></a>MySQL Replication</h3><p>MySQL复制，MySQL的复制默认为异步工作模式，mysql的复制功能是mysql内置的，装上它之后就具备了这个功能，而mysql复制是mysql实现大规模高性能应用的一个基本工具，是 mysql完成水平扩展的基本架构，为了能够应付更多的访问请求，通常情况下我们需要对服务器进行扩展，而扩展通常有两种方式：向上扩展和向外扩展；</p><p><strong>向上扩展：</strong>scale on，也称为垂直扩展，一般是扩充服务器的内存或CPU颗数的这种就是向上扩展。</p><p><strong>向外扩展：</strong>scale out，也称为水平扩展，比较一台服务器不够，再加一台服务器，再不够再加，这种情况就是向外扩展。</p><p>其实MySQL的的复制功能就是使用MySQL向外扩展的能力，也就是水平扩展的功能。</p><p><strong>所谓同步的复制：</strong>首先主服务器每更新一条数据先写到磁盘文件中，同时还要写一个到二进制日志文件中，从服务器就会到主服务器请求二进制信息保存在中继日志中，保存好后由本地 的SQL thread从中继日志应用到从服务器的本地有磁盘文件中，当这个过程完成之后再由从服务器返回确认结果给主服务器，主服务器才返回结果给客户端的。<br><strong>所谓异步复制：</strong>当主服务器要写数据时，先写到本地的磁盘，同时写到二进制文件日志中，写好二进制日志文件后就把结果返回给客户端，至于从服务有没有来主服务器同步二进制日志他不关心。<br>注意：在做复制时双方的的MySQL要一致，如果不一致，主的要低于从的。</p><p>  MySQL主从服务的工作原理图：</p><p><a href="https://imgtu.com/i/o4qZfH"><img src="https://s1.ax1x.com/2021/12/10/o4qZfH.png" alt="o4qZfH.png"></a></p><p>  这里还要注意，如果从服务器不断的到主服务器来请求数据，发现这些数据已经是最新的数据了，那从服务器的I/O thread将会转为睡眠状态，因为主服务器会通知，而I/O线程不会做轮循，从服务器的二进制日志文件通常是被关闭状态的，从服务器是不允许执行写操作 的</p><p>下面来完成主从复制的基本操作步骤:</p><ol><li>这里我们要有两台主机、我这里使用克隆主服务器的主机当做从服务器、首先要把虚拟主机关机才可以克隆的：</li></ol><p><a href="https://imgtu.com/i/o4LFvn"><img src="https://s1.ax1x.com/2021/12/10/o4LFvn.png" alt="o4LFvn.png"></a></p><p><a href="https://imgtu.com/i/o4LED0"><img src="https://s1.ax1x.com/2021/12/10/o4LED0.png" alt="o4LED0.png"></a></p><p><a href="https://imgtu.com/i/o4LVbV"><img src="https://s1.ax1x.com/2021/12/10/o4LVbV.png" alt="o4LVbV.png"></a></p><p>  克隆完之后我们就开机登录、确保主从服务器都正常运行了即可：</p><p><a href="https://imgtu.com/i/o4Ln5F"><img src="https://s1.ax1x.com/2021/12/10/o4Ln5F.png" alt="o4Ln5F.png"></a></p><p><a href="https://imgtu.com/i/o4LM8J"><img src="https://s1.ax1x.com/2021/12/10/o4LM8J.png" alt="o4LM8J.png"></a></p><p><a href="https://imgtu.com/i/o4LQ29"><img src="https://s1.ax1x.com/2021/12/10/o4LQ29.png" alt="o4LQ29.png"></a></p><p><a href="https://imgtu.com/i/o4LlvR"><img src="https://s1.ax1x.com/2021/12/10/o4LlvR.png" alt="o4LlvR.png"></a></p><ol start="2"><li><p>做主从复制最重要的一点就是双方的server-id不能相同；然而<strong>在主服务器上只需要三步</strong>：</p><ol><li><p>就是改server-id</p></li><li><p>启用二进制日志</p></li><li><p>创建有复制权限的帐号</p></li></ol></li></ol><p><a href="https://imgtu.com/i/o4Ld8H"><img src="https://s1.ax1x.com/2021/12/10/o4Ld8H.png" alt="o4Ld8H.png"></a></p><p>  改好之后保存退出即可，再重启服务器，创建二进制目录：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mkdir /data/binlogs</span><br><span class="line">chown -R mysql.mysql /data/binlogs</span><br><span class="line"><span class="meta">#</span><span class="bash">重启主服务器的mysql服务;</span></span><br><span class="line">service mysqld restart　</span><br></pre></td></tr></table></figure><p>  而后连接到主服务器上授权一个有复制权限的帐号：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot -hlocalhost -p    </span><br><span class="line">MariaDB [hellodb]&gt; GRANT REPLICATION SLAVE,REPLICATION CLIENT ON *.* TO &#x27;repluser&#x27;@&#x27;172.16.251.156&#x27; IDENTIFIED BY &#x27;replpass&#x27;;</span><br><span class="line">MariaDB [hellodb]&gt; FLUSH PRIVILEGES;</span><br></pre></td></tr></table></figure><ol start="3"><li><p><strong>在从服务器上有以下几步</strong>：</p><ol><li><p>改server-id</p></li><li><p>启用中继日志</p></li><li><p>连接主服务器</p></li><li><p>启动复制线程</p></li></ol></li></ol><p><a href="https://imgtu.com/i/o4LWGQ"><img src="https://s1.ax1x.com/2021/12/10/o4LWGQ.png" alt="o4LWGQ.png"></a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mkdir /data/relaylogs/</span><br><span class="line">chown -R mysql.mysql /data/relaylogs</span><br><span class="line">重启mysql服务：</span><br><span class="line">service mysqld restart</span><br><span class="line">再连到从服务器的mysql服务器上：</span><br><span class="line">mysql -uroot -hlocalhost -p</span><br><span class="line">查看一下从服务器的中继日志是否在启动状态：</span><br><span class="line">MariaDB [(none)]&gt; SHOW GLOBAL VARIABLES LIKE &#x27;%relay%&#x27;;</span><br></pre></td></tr></table></figure><p><a href="https://imgtu.com/i/o4Lhxs"><img src="https://s1.ax1x.com/2021/12/10/o4Lhxs.png" alt="o4Lhxs.png"></a></p><p>  按照上面的步骤再连接主服务器：   </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> MASTER_HOST=<span class="string">&#x27;172.16.251.244&#x27;</span> --主服务器的IP地址</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> MASTER_USER=<span class="string">&#x27;repluser&#x27;</span> --主服务器上授权复制的用户名</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> MASTER_PASSWORD=<span class="string">&#x27;replpass&#x27;</span> --主服务器上授权用名的密码</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> MASTER_LOG_FILE=<span class="string">&#x27;mysql-bin.000006&#x27;</span> --主服务器上的日志文件</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> MASTER_LOG_POS=245 --主服务器上日志文件的位置</span></span><br><span class="line">MariaDB [hellodb]&gt; CHANGE MASTER TO MASTER_HOST=&#x27;172.16.251.244&#x27;,MASTER_USER=&#x27;repluser&#x27;,MASTER_PASSWORD=&#x27;replpass&#x27;,MASTER_LOG_FILE=&#x27;master-bin.000006&#x27;,MASTER_LOG_POS=245; #指定日志从哪个位置开始复制</span><br></pre></td></tr></table></figure><p>  但是此时的从服务器还没有工作起来，要使从服务器工作起来还要手动启动复制线程，我们上面的步骤写得很明白：<br>  MariaDB [(none)]&gt; START SLAVE;</p><p><a href="https://imgtu.com/i/o4LIrq"><img src="https://s1.ax1x.com/2021/12/10/o4LIrq.png" alt="o4LIrq.png"></a></p><p><a href="https://imgtu.com/i/o4Loq0"><img src="https://s1.ax1x.com/2021/12/10/o4Loq0.png" alt="o4Loq0.png"></a></p><p><a href="https://imgtu.com/i/o4LHaT"><img src="https://s1.ax1x.com/2021/12/10/o4LHaT.png" alt="o4LHaT.png"></a></p><p><a href="https://imgtu.com/i/o4LOG4"><img src="https://s1.ax1x.com/2021/12/10/o4LOG4.png" alt="o4LOG4.png"></a></p><p>  OK、到这里主服务器算是配置完成了</p>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;/assets/css/APlayer.min.css&quot;&gt;&lt;script src=&quot;/assets/js/APlayer.min.js&quot; cla</summary>
      
    
    
    
    <category term="Linux" scheme="https://www.hnswxx.cn/categories/Linux/"/>
    
    
    <category term="Centos8" scheme="https://www.hnswxx.cn/tags/Centos8/"/>
    
    <category term="MariaDB" scheme="https://www.hnswxx.cn/tags/MariaDB/"/>
    
  </entry>
  
  <entry>
    <title>从属证书颁发机构</title>
    <link href="https://www.hnswxx.cn/2021/12/09/secondary-certification-authority/"/>
    <id>https://www.hnswxx.cn/2021/12/09/secondary-certification-authority/</id>
    <published>2021-12-09T14:11:54.000Z</published>
    <updated>2021-12-09T15:07:17.000Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h3 id="环境介绍"><a href="#环境介绍" class="headerlink" title="环境介绍"></a>环境介绍</h3><table><thead><tr><th>主机名</th><th>IP地址</th><th>角色</th></tr></thead><tbody><tr><td>master.skills.com</td><td>10.10.70.101</td><td>主证书颁发机构</td></tr><tr><td>slave.skills.com</td><td>10.10.70.102</td><td>从属证书颁发机构</td></tr></tbody></table><h3 id="配置操作"><a href="#配置操作" class="headerlink" title="配置操作"></a>配置操作</h3><h4 id="master配置"><a href="#master配置" class="headerlink" title="master配置"></a>master配置</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">首先在这个配置文件里面查看CA证书需要哪些文件和哪些目录</span></span><br><span class="line"><span class="meta">#</span><span class="bash">/etc/pki/tls/openssl.cnf</span> </span><br><span class="line"><span class="meta">#</span><span class="bash">从第55行开始看</span></span><br><span class="line"> 55 [ ca ]</span><br><span class="line"> 56 default_ca      = CA_default            # The default ca secn</span><br><span class="line"> 57 </span><br><span class="line"> 58 #############################################################</span><br><span class="line"> 59 [ CA_default ]</span><br><span class="line"> 60 </span><br><span class="line"> 61 dir             = /etc/pki/CA           # Where everything i里</span><br><span class="line"> 62 certs           = $dir/certs            # Where the issued c处</span><br><span class="line"> 63 crl_dir         = $dir/crl              # Where the issued c处</span><br><span class="line"> 64 database        = $dir/index.txt        # database index fil。</span><br><span class="line"> 65 #unique_subject = no                    # Set to &#x27;no&#x27; to all建</span><br><span class="line"> 66                                         # several certs with。</span><br><span class="line"> 67 new_certs_dir   = $dir/newcerts         # default place for 。</span><br><span class="line"> 68 </span><br><span class="line"> 69 certificate     = $dir/cacert.pem       # The CA certificate书</span><br><span class="line"> 70 serial          = $dir/serial           # The current serial号</span><br><span class="line"> 71 crlnumber       = $dir/crlnumber        # the current crl nu号</span><br><span class="line"> 72                                         # must be commented L </span><br><span class="line"> 73 crl             = $dir/crl.pem          # The current CRL 当L </span><br><span class="line"> 74 private_key     = $dir/private/cakey.pem# The private key 私钥</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">查看了以上文件以后发现需要在 /etc/pki 下创建CA文件夹</span></span><br><span class="line"><span class="meta">#</span><span class="bash">在CA 文件夹下创建 certs crl private 这三个重要的文件夹其余的可 建</span></span><br><span class="line">mkdir -p /etc/pki/CA/&#123;certs,crl,newcerts,private&#125;</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">在private 文件夹下创建一个私钥 cakey.pem</span></span><br><span class="line">openssl genrsa -out cakey.pem 4096</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">在CA 文件夹下创建 ca根证书</span></span><br><span class="line">openssl req -new -x509 -key private/cakey.pem -out cacert.pem -days #根证书年份</span><br><span class="line">You are about to be asked to enter information that will be incod</span><br><span class="line">into your certificate request.</span><br><span class="line">What you are about to enter is what is called a Distinguished Na.</span><br><span class="line">There are quite a few fields but you can leave some blank</span><br><span class="line">For some fields there will be a default value,</span><br><span class="line">If you enter &#x27;.&#x27;, the field will be left blank.</span><br><span class="line">-----</span><br><span class="line">Country Name (2 letter code) [XX]:CN</span><br><span class="line">State or Province Name (full name) []:Shenzhen</span><br><span class="line">Locality Name (eg, city) [Default City]:Shenzhen  </span><br><span class="line">Organization Name (eg, company) [Default Company Ltd]:DCN</span><br><span class="line">Organizational Unit Name (eg, section) []:skills  </span><br><span class="line">Common Name (eg, your name or your server&#x27;s hostname) []:CA</span><br><span class="line">Email Address []:</span><br><span class="line"><span class="meta">#</span><span class="bash">在CA 文件夹下创建 数据库索引文件 和 当前序列号</span></span><br><span class="line">touch /etc/pki/CA/index.txt</span><br><span class="line">echo 01 &gt; /etc/pki/CA/serial #证书序列号写01从1开始</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">证书颁发机构设置好了</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">查看根证书信息</span></span><br><span class="line">openssl x509 -in cacert.pem -noout -text</span><br><span class="line">Certificate:</span><br><span class="line">    Data:</span><br><span class="line">        Version: 3 (0x2)</span><br><span class="line">        Serial Number:</span><br><span class="line">            08:ea:f3:13:84:1f:9e:8a:00:18:4c:1f:ad:81:62:b8:22:06:90:51</span><br><span class="line">        Signature Algorithm: sha256WithRSAEncryption</span><br><span class="line">        Issuer: C = CN, ST = Shenzhen, L = Shenzhen, O = DCN, OU = skills, CN = CA</span><br><span class="line">        Validity</span><br><span class="line">            Not Before: Dec  9 22:46:36 2021 GMT</span><br><span class="line">            Not After : Jan  8 22:46:36 2022 GMT</span><br><span class="line">        Subject: C = CN, ST = Shenzhen, L = Shenzhen, O = DCN, OU = skills, CN = CA</span><br><span class="line">        Subject Public Key Info:</span><br><span class="line">            Public Key Algorithm: rsaEncryption</span><br><span class="line">                RSA Public-Key: (4096 bit)</span><br><span class="line">                Modulus:</span><br><span class="line">                    00:ba:3f:61:2c:92:83:64:7e:cf:38:21:3c:35:51:</span><br><span class="line">                    25:c4:3a:d4:09:c6:dd:38:2f:a4:a8:57:9b:d6:5e:</span><br><span class="line">                    84:30:34:c2:cd:4c:9e:3f:7d:8e:72:78:08:8b:35:</span><br><span class="line">                    80:bb:3d:b6:8a:89:23:c9:91:8c:ed:91:d6:e7:44:</span><br><span class="line">                    45:4c:48:26:42:83:dc:57:f8:c7:a4:6c:8f:bf:50:</span><br><span class="line">                    55:98:f1:36:1e:6b:8b:70:79:7a:05:75:15:6d:cb:</span><br><span class="line">                    f2:6e:25:ad:91:71:f9:b5:db:2a:ec:e3:5f:12:e8:</span><br><span class="line">                    7a:87:b8:83:ca:8c:fb:2b:e9:6d:d7:a1:6e:cc:b6:</span><br><span class="line">                    c1:0b:26:7e:9b:3e:64:e9:87:8c:7f:30:1f:ea:cb:</span><br><span class="line">                    30:6e:79:79:fb:7a:d2:4c:71:55:f0:a6:30:f5:ba:</span><br><span class="line">                    fc:a5:3f:cf:2f:e4:71:1d:f6:17:e1:27:47:21:b9:</span><br><span class="line">                    fb:5d:74:2a:00:86:e7:f3:b9:74:e4:cb:63:f4:8f:</span><br><span class="line">                    c0:b1:6a:9c:f6:f6:09:80:2f:c8:c0:d8:97:23:28:</span><br><span class="line">                    a5:81:6c:93:02:5e:8f:eb:7b:46:cc:20:61:d5:02:</span><br><span class="line">                    dd:69:7a:ed:91:c7:1d:c3:42:b9:36:4c:47:09:49:</span><br><span class="line">                    c7:ea:eb:bc:33:cc:c9:c5:e7:56:69:c6:6e:c4:a0:</span><br><span class="line">                    16:65:cf:6b:8a:73:fb:b3:59:02:d5:ae:37:f3:b5:</span><br><span class="line">                    ec:70:d8:99:73:3e:5e:fc:96:06:f9:b3:d2:5a:b2:</span><br><span class="line">                    71:36:ef:c9:6b:aa:f5:44:07:94:0a:a7:44:dc:ea:</span><br><span class="line">                    0d:dd:29:e1:7b:7a:5d:07:27:cf:a3:11:c3:97:44:</span><br><span class="line">                    bc:74:aa:ce:92:64:1e:96:f4:1e:85:fc:de:f6:2a:</span><br><span class="line">                    e8:62:12:63:fb:63:78:99:6b:8c:61:88:4e:02:85:</span><br><span class="line">                    74:34:b4:88:0d:7e:e8:fa:4d:3a:c3:21:ef:76:ea:</span><br><span class="line">                    9a:f7:fc:96:ec:07:a4:e6:ff:0c:ab:4b:95:85:72:</span><br><span class="line">                    f3:66:e8:99:f8:da:40:7b:03:5a:bf:da:6d:1a:ea:</span><br><span class="line">                    fa:d2:0a:23:75:08:5d:74:b9:80:07:8c:5a:ac:b4:</span><br><span class="line">                    87:e8:84:ba:7c:c3:4c:e1:42:ca:8c:e2:93:aa:ff:</span><br><span class="line">                    72:8b:1a:66:2b:21:c3:e5:63:8f:62:c8:93:e2:68:</span><br><span class="line">                    a7:76:e3:05:07:31:3a:ee:68:09:e2:10:83:6e:91:</span><br><span class="line">                    7f:89:7c:03:44:f5:c6:50:fe:7b:1b:06:94:b0:23:</span><br><span class="line">                    3c:85:81:5a:23:a6:95:48:cc:bc:93:10:80:0a:5e:</span><br><span class="line">                    76:89:09:40:24:a2:39:15:f2:d4:e7:3c:74:58:74:</span><br><span class="line">                    5b:33:ab:53:49:fe:63:e8:1e:ea:dd:26:74:47:37:</span><br><span class="line">                    3a:2c:59:4b:6f:7f:a0:80:3d:87:c0:d3:17:15:e5:</span><br><span class="line">                    65:45:39</span><br><span class="line">                Exponent: 65537 (0x10001)</span><br><span class="line">        X509v3 extensions:</span><br><span class="line">            X509v3 Subject Key Identifier: </span><br><span class="line">                17:0E:67:EC:6D:4D:99:1B:23:B9:4B:17:16:05:18:06:9A:07:CF:F7</span><br><span class="line">            X509v3 Authority Key Identifier: </span><br><span class="line">                keyid:17:0E:67:EC:6D:4D:99:1B:23:B9:4B:17:16:05:18:06:9A:07:CF:F7</span><br><span class="line"></span><br><span class="line">            X509v3 Basic Constraints: critical</span><br><span class="line">                CA:TRUE</span><br><span class="line">    Signature Algorithm: sha256WithRSAEncryption</span><br><span class="line">         34:68:81:ef:51:37:11:97:7a:2a:32:09:14:be:8c:dc:bf:58:</span><br><span class="line">         10:37:3c:8b:64:cd:b9:18:71:d0:17:8b:cd:79:40:bb:3c:dc:</span><br><span class="line">         72:27:a1:61:4b:d2:d9:70:8c:ca:64:3e:27:98:9b:32:0b:9e:</span><br><span class="line">         7d:08:48:d6:12:8c:1e:4b:2d:ff:78:ad:20:16:df:b7:6a:b4:</span><br><span class="line">         fd:a8:2c:92:f1:6d:a6:dd:c8:67:7c:43:ba:e5:ee:b9:ee:d8:</span><br><span class="line">         57:a3:7a:f5:bc:8f:e6:12:25:ab:18:de:a1:be:36:4b:fd:84:</span><br><span class="line">         9d:31:39:c9:53:22:b2:9d:da:58:bb:ba:44:13:a7:f2:ad:ca:</span><br><span class="line">         e4:7e:ac:9c:29:4c:87:91:79:89:a6:a1:6f:6e:7e:91:43:38:</span><br><span class="line">         a4:d7:8d:1c:71:65:d6:b9:2a:0a:b8:f2:53:48:83:1f:ed:85:</span><br><span class="line">         70:ea:c4:8a:bc:bd:04:80:51:91:87:80:ee:ca:78:62:7d:5a:</span><br><span class="line">         9c:3e:6d:fd:54:31:e2:1d:64:76:9f:d8:f6:47:6f:cd:e8:75:</span><br><span class="line">         b8:a9:2c:2c:bb:48:4e:68:53:96:e2:9d:77:07:ae:f2:d2:04:</span><br><span class="line">         5c:c5:ac:b9:34:22:aa:3b:d7:cc:ef:fe:19:94:12:a0:ed:98:</span><br><span class="line">         78:93:25:c2:19:ae:c5:bc:bd:57:39:99:93:28:90:0a:fc:d7:</span><br><span class="line">         b7:67:b5:8a:fe:7f:3b:41:5d:cc:ef:d6:90:c6:27:5f:f2:39:</span><br><span class="line">         53:c5:7e:a3:9f:99:3c:4d:8c:ff:0c:ba:0d:64:64:d9:4f:9d:</span><br><span class="line">         fb:99:0f:b5:40:51:50:2a:60:62:a5:b3:79:3b:22:0b:2f:f1:</span><br><span class="line">         fc:0f:27:11:96:3c:68:62:6f:e6:83:84:f8:4b:c2:26:12:82:</span><br><span class="line">         14:fb:f5:81:a3:47:b2:a5:8e:8a:6e:0f:f2:bf:80:36:f7:63:</span><br><span class="line">         22:87:91:b0:d9:bc:6b:c5:c7:3c:84:d6:97:67:e4:c1:1a:37:</span><br><span class="line">         06:fa:5b:d1:80:42:78:cd:41:7a:79:72:a9:dd:0d:c2:5b:f0:</span><br><span class="line">         a3:75:be:7c:4c:20:0b:7b:91:05:84:49:9c:4d:f1:ff:f7:04:</span><br><span class="line">         32:e0:92:d3:36:17:bd:b7:27:9a:89:67:45:6d:16:4d:6e:1e:</span><br><span class="line">         35:1b:d5:cf:34:4d:b9:85:69:99:f2:68:64:91:d8:e9:8d:b7:</span><br><span class="line">         c2:84:37:f7:4d:c9:b6:21:f0:8b:05:49:66:51:76:e3:f1:10:</span><br><span class="line">         d5:be:f1:83:7c:2e:3c:bb:57:a4:de:25:01:43:7a:8f:39:10:</span><br><span class="line">         c6:a5:3f:92:e8:5d:7e:9e:91:ab:35:75:c6:1c:c4:ce:78:88:</span><br><span class="line">         a4:e6:47:2a:51:2f:9a:6b:ff:50:9e:0b:92:15:fa:68:5c:2e:</span><br><span class="line">         e5:cc:b6:45:32:eb:90:13</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">创建一个私钥 再用证书颁发机构颁发一个子证书 这个证书作为从属证书颁发机构的根证书</span></span><br><span class="line">openssl genrsa -out cakey.pem</span><br><span class="line">Generating RSA private key, 2048 bit long modulus (2 primes)</span><br><span class="line">...................+++++</span><br><span class="line">............................................+++++</span><br><span class="line">e is 65537 (0x010001)</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">创建证书请求文件</span></span><br><span class="line">You are about to be asked to enter information that will be incorporated</span><br><span class="line">into your certificate request.</span><br><span class="line">What you are about to enter is what is called a Distinguished Name or a DN.</span><br><span class="line">There are quite a few fields but you can leave some blank</span><br><span class="line">For some fields there will be a default value,</span><br><span class="line">If you enter &#x27;.&#x27;, the field will be left blank.</span><br><span class="line">-----</span><br><span class="line">Country Name (2 letter code) [XX]:CN</span><br><span class="line">State or Province Name (full name) []:Shenzhen</span><br><span class="line">Locality Name (eg, city) [Default City]:Shenzhen</span><br><span class="line">Organization Name (eg, company) [Default Company Ltd]:DCN</span><br><span class="line">Organizational Unit Name (eg, section) []:skills</span><br><span class="line">Common Name (eg, your name or your server&#x27;s hostname) []:BCA</span><br><span class="line">Email Address []:</span><br><span class="line"></span><br><span class="line">Please enter the following &#x27;extra&#x27; attributes</span><br><span class="line">to be sent with your certificate request</span><br><span class="line">A challenge password []:</span><br><span class="line">An optional company name []:</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">签发证书</span></span><br><span class="line">openssl ca -in ca.csr -out cacert.pem</span><br><span class="line">Using configuration from /etc/pki/tls/openssl.cnf</span><br><span class="line">Check that the request matches the signature</span><br><span class="line">Signature ok</span><br><span class="line">Certificate Details:</span><br><span class="line">        Serial Number: 1 (0x1)</span><br><span class="line">        Validity</span><br><span class="line">            Not Before: Dec  9 22:50:26 2021 GMT</span><br><span class="line">            Not After : Dec  9 22:50:26 2022 GMT</span><br><span class="line">        Subject:</span><br><span class="line">            countryName               = CN</span><br><span class="line">            stateOrProvinceName       = Shenzhen</span><br><span class="line">            organizationName          = DCN</span><br><span class="line">            organizationalUnitName    = skills</span><br><span class="line">            commonName                = BCA</span><br><span class="line">        X509v3 extensions:</span><br><span class="line">            X509v3 Basic Constraints: </span><br><span class="line">                CA:FALSE</span><br><span class="line">            Netscape Comment: </span><br><span class="line">                OpenSSL Generated Certificate</span><br><span class="line">            X509v3 Subject Key Identifier: </span><br><span class="line">                0E:F7:63:9B:62:12:E7:0C:C0:92:20:92:6B:19:B3:25:28:F7:DD:7B</span><br><span class="line">            X509v3 Authority Key Identifier: </span><br><span class="line">                keyid:17:0E:67:EC:6D:4D:99:1B:23:B9:4B:17:16:05:18:06:9A:07:CF:F7</span><br><span class="line"></span><br><span class="line">Certificate is to be certified until Dec  9 22:50:26 2022 GMT (365 days)</span><br><span class="line">Sign the certificate? [y/n]:y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">1 out of 1 certificate requests certified, commit? [y/n]y</span><br><span class="line">Write out database with 1 new entries</span><br><span class="line">Data Base Updated</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">把证书和私钥传到从属证书服务器</span></span><br><span class="line">scp cacert.pem cakey.pem 10.10.70.102:/</span><br><span class="line">The authenticity of host &#x27;10.10.70.102 (10.10.70.102)&#x27; can&#x27;t be established.</span><br><span class="line">ECDSA key fingerprint is SHA256:rCfwMbGRzTJHEOwwrDDoeo77AzQVE+xJtfppiOeGgSU.</span><br><span class="line">Are you sure you want to continue connecting (yes/no/[fingerprint])? yes</span><br><span class="line">Warning: Permanently added &#x27;10.10.70.102&#x27; (ECDSA) to the list of known hosts.</span><br><span class="line">root@10.10.70.102&#x27;s password: </span><br><span class="line">cacert.pem                                                         100% 5675     3.5MB/s   00:00    </span><br><span class="line">cakey.pem                                                          100% 1679     1.4MB/s   00:00  </span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">主服务器配置结束</span></span><br></pre></td></tr></table></figure><h4 id="slave配置"><a href="#slave配置" class="headerlink" title="slave配置"></a>slave配置</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">创建基础文件夹</span></span><br><span class="line">mkdir -p /etc/pki/CA/&#123;certs,crl,newcerts,private&#125;</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">把私钥和证书移动到指定位置</span></span><br><span class="line">mv cakey.pem /etc/pki/CA/private/</span><br><span class="line">mv cacert.pem /etc/pki/CA/</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">在CA 文件夹下创建 数据库索引文件 和 当前序列号</span></span><br><span class="line">touch /etc/pki/CA/index.txt</span><br><span class="line">echo 01 &gt; /etc/pki/CA/serial #证书序列号写01从1开始</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">从属证书颁发机构创建完毕</span></span><br></pre></td></tr></table></figure><h4 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">私钥</span></span><br><span class="line">openssl genrsa -out ca.key</span><br><span class="line"><span class="meta">#</span><span class="bash">证书请求文件</span></span><br><span class="line">You are about to be asked to enter information that will be incorporated</span><br><span class="line">into your certificate request.</span><br><span class="line">What you are about to enter is what is called a Distinguished Name or a DN.</span><br><span class="line">There are quite a few fields but you can leave some blank</span><br><span class="line">For some fields there will be a default value,</span><br><span class="line">If you enter &#x27;.&#x27;, the field will be left blank.</span><br><span class="line">-----</span><br><span class="line">Country Name (2 letter code) [XX]:CN</span><br><span class="line">State or Province Name (full name) []:Shenzhen</span><br><span class="line">Locality Name (eg, city) [Default City]:Shenzhen</span><br><span class="line">Organization Name (eg, company) [Default Company Ltd]:DCN</span><br><span class="line">Organizational Unit Name (eg, section) []:skills</span><br><span class="line">Common Name (eg, your name or your server&#x27;s hostname) []:test              </span><br><span class="line">Email Address []:</span><br><span class="line"></span><br><span class="line">Please enter the following &#x27;extra&#x27; attributes</span><br><span class="line">to be sent with your certificate request</span><br><span class="line">A challenge password []:</span><br><span class="line">An optional company name []:</span><br><span class="line"><span class="meta">#</span><span class="bash">签发证书</span></span><br><span class="line">openssl ca -in ca.csr -out ca.crt</span><br><span class="line">Using configuration from /etc/pki/tls/openssl.cnf</span><br><span class="line">Check that the request matches the signature</span><br><span class="line">Signature ok</span><br><span class="line">Certificate Details:</span><br><span class="line">        Serial Number: 1 (0x1)</span><br><span class="line">        Validity</span><br><span class="line">            Not Before: Dec  9 15:01:17 2021 GMT</span><br><span class="line">            Not After : Dec  9 15:01:17 2022 GMT</span><br><span class="line">        Subject:</span><br><span class="line">            countryName               = CN</span><br><span class="line">            stateOrProvinceName       = Shenzhen</span><br><span class="line">            organizationName          = DCN</span><br><span class="line">            organizationalUnitName    = skills</span><br><span class="line">            commonName                = test</span><br><span class="line">        X509v3 extensions:</span><br><span class="line">            X509v3 Basic Constraints: </span><br><span class="line">                CA:FALSE</span><br><span class="line">            Netscape Comment: </span><br><span class="line">                OpenSSL Generated Certificate</span><br><span class="line">            X509v3 Subject Key Identifier: </span><br><span class="line">                15:50:E6:D4:69:46:06:3D:F4:C7:92:F4:11:83:54:9D:17:8B:41:0C</span><br><span class="line">            X509v3 Authority Key Identifier: </span><br><span class="line">                keyid:EC:0A:D9:AB:00:1B:5E:EC:00:BB:C7:30:6C:25:1D:55:7B:F5:3C:2D</span><br><span class="line"></span><br><span class="line">Certificate is to be certified until Dec  9 15:01:17 2022 GMT (365 days)</span><br><span class="line">Sign the certificate? [y/n]:y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">1 out of 1 certificate requests certified, commit? [y/n]y</span><br><span class="line">Write out database with 1 new entries</span><br><span class="line">Data Base Updated</span><br><span class="line"><span class="meta">#</span><span class="bash">证书信息</span></span><br><span class="line">openssl x509 -in ca.crt -noout -text</span><br><span class="line">Certificate:</span><br><span class="line">    Data:</span><br><span class="line">        Version: 3 (0x2)</span><br><span class="line">        Serial Number: 1 (0x1)</span><br><span class="line">        Signature Algorithm: sha256WithRSAEncryption</span><br><span class="line">        Issuer: C = CN, ST = Shenzhen, O = DCN, OU = skills, CN = BCA</span><br><span class="line">        Validity</span><br><span class="line">            Not Before: Dec  9 15:01:17 2021 GMT</span><br><span class="line">            Not After : Dec  9 15:01:17 2022 GMT</span><br><span class="line">        Subject: C = CN, ST = Shenzhen, O = DCN, OU = skills, CN = test</span><br><span class="line">        Subject Public Key Info:</span><br><span class="line">            Public Key Algorithm: rsaEncryption</span><br><span class="line">                RSA Public-Key: (2048 bit)</span><br><span class="line">                Modulus:</span><br><span class="line">                    00:da:c3:c4:b6:40:56:c9:65:29:3d:68:21:66:3e:</span><br><span class="line">                    76:8a:3c:d7:98:df:26:90:89:61:50:02:78:ce:ef:</span><br><span class="line">                    c9:70:cd:70:fe:10:85:71:64:73:df:0b:0a:85:7c:</span><br><span class="line">                    4a:52:6a:13:58:bd:18:4a:85:ba:de:43:c9:b0:ed:</span><br><span class="line">                    6b:c6:77:fc:11:5e:c4:41:b0:03:c9:c0:78:5d:aa:</span><br><span class="line">                    fc:6b:8e:aa:d1:78:59:df:fc:cd:3d:da:97:49:e0:</span><br><span class="line">                    7c:95:c6:52:76:90:79:8a:ff:99:ec:cb:02:66:21:</span><br><span class="line">                    d9:dd:04:7c:69:e4:37:1b:c2:78:f9:b2:46:ec:5f:</span><br><span class="line">                    e6:52:e0:46:25:07:69:d3:c9:80:c1:fd:31:56:d9:</span><br><span class="line">                    08:1c:7a:01:0b:6b:ad:fd:b0:d4:60:57:d0:c1:48:</span><br><span class="line">                    54:60:ce:48:29:69:64:32:82:08:4d:a6:9b:82:5a:</span><br><span class="line">                    9b:37:62:bd:fd:e4:26:e3:a0:c2:2c:7c:e4:32:b1:</span><br><span class="line">                    2b:60:25:af:f5:75:e0:c6:af:34:9b:c6:fe:8f:7d:</span><br><span class="line">                    dc:bb:95:b3:f8:ff:ca:fe:0d:fb:75:61:4a:c5:40:</span><br><span class="line">                    76:19:71:43:47:1d:1f:1f:74:d3:22:8a:dd:56:da:</span><br><span class="line">                    5d:13:44:78:e7:4e:48:7d:54:3e:b7:08:66:82:9d:</span><br><span class="line">                    42:92:84:e9:bc:7e:86:bf:2d:37:79:3a:34:d1:f5:</span><br><span class="line">                    90:6d</span><br><span class="line">                Exponent: 65537 (0x10001)</span><br><span class="line">        X509v3 extensions:</span><br><span class="line">            X509v3 Basic Constraints: </span><br><span class="line">                CA:FALSE</span><br><span class="line">            Netscape Comment: </span><br><span class="line">                OpenSSL Generated Certificate</span><br><span class="line">            X509v3 Subject Key Identifier: </span><br><span class="line">                15:50:E6:D4:69:46:06:3D:F4:C7:92:F4:11:83:54:9D:17:8B:41:0C</span><br><span class="line">            X509v3 Authority Key Identifier: </span><br><span class="line">                keyid:EC:0A:D9:AB:00:1B:5E:EC:00:BB:C7:30:6C:25:1D:55:7B:F5:3C:2D</span><br><span class="line"></span><br><span class="line">    Signature Algorithm: sha256WithRSAEncryption</span><br><span class="line">         09:3c:1e:54:cf:b3:5b:a9:e3:cb:e8:ef:6e:8c:c3:3c:3f:b0:</span><br><span class="line">         60:79:91:d9:61:f5:de:bc:c5:1c:eb:ea:3e:d9:99:21:ae:fb:</span><br><span class="line">         80:63:4e:75:e4:1e:40:74:69:87:da:5b:6b:f6:5f:40:2a:c7:</span><br><span class="line">         2e:52:3e:ce:50:46:e3:49:d5:0e:6f:f5:8a:22:a0:b4:93:d2:</span><br><span class="line">         15:ab:75:98:55:1f:86:f1:0b:18:ec:4a:d2:f1:49:40:df:47:</span><br><span class="line">         81:74:77:7b:ab:42:21:f7:5d:76:64:53:07:62:d5:9c:a2:66:</span><br><span class="line">         b6:56:ec:e7:a5:31:d2:8a:a5:4d:63:6f:f7:24:f9:65:33:58:</span><br><span class="line">         f2:d6:ab:7b:59:86:57:3b:cc:b6:21:4a:13:5c:77:f5:a9:e1:</span><br><span class="line">         53:4c:1e:12:aa:3b:05:34:ac:8e:2d:dd:31:57:32:83:2e:47:</span><br><span class="line">         e0:3b:21:58:f2:92:c2:d4:1c:bf:34:1e:13:f9:a9:74:89:a3:</span><br><span class="line">         a5:cc:7d:69:92:76:dc:75:0d:3c:9a:0b:98:81:65:86:e2:d1:</span><br><span class="line">         fe:e1:ae:60:73:21:e2:98:69:fe:b5:7f:15:e1:b5:cf:1a:39:</span><br><span class="line">         9f:87:e2:9b:e1:89:33:4f:53:b0:46:db:04:6a:42:ce:a5:6d:</span><br><span class="line">         b3:d8:5c:de:c6:f5:f1:a0:a0:82:ad:c1:eb:a0:63:51:df:f1:</span><br><span class="line">         b8:1a:51:13</span><br></pre></td></tr></table></figure><p><a href="https://imgtu.com/i/o4wpfs"><img src="https://s1.ax1x.com/2021/12/09/o4wpfs.md.png" alt="o4wpfs.md.png"></a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;/assets/css/APlayer.min.css&quot;&gt;&lt;script src=&quot;/assets/js/APlayer.min.js&quot; cla</summary>
      
    
    
    
    <category term="Linux" scheme="https://www.hnswxx.cn/categories/Linux/"/>
    
    
    <category term="证书" scheme="https://www.hnswxx.cn/tags/%E8%AF%81%E4%B9%A6/"/>
    
    <category term="Centos8" scheme="https://www.hnswxx.cn/tags/Centos8/"/>
    
  </entry>
  
  <entry>
    <title>从属LinuxDNS服务器</title>
    <link href="https://www.hnswxx.cn/2021/11/24/linux-dns-secondary-server/"/>
    <id>https://www.hnswxx.cn/2021/11/24/linux-dns-secondary-server/</id>
    <published>2021-11-24T12:24:50.000Z</published>
    <updated>2021-12-09T14:08:16.000Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h3 id="环境介绍"><a href="#环境介绍" class="headerlink" title="环境介绍"></a>环境介绍</h3><table><thead><tr><th>主机名</th><th>IP地址</th><th>角色</th></tr></thead><tbody><tr><td>master.skills.com</td><td>10.10.70.101</td><td>DNS主服务器</td></tr><tr><td>slave.skills.com</td><td>10.10.70.102</td><td>DNS辅服务器</td></tr></tbody></table><h3 id="服务器配置"><a href="#服务器配置" class="headerlink" title="服务器配置"></a>服务器配置</h3><h5 id="master服务器"><a href="#master服务器" class="headerlink" title="master服务器"></a>master服务器</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">安装DNS服务软件BIND与测试软件BIND-UTILS</span></span><br><span class="line">yum install bind bind-utils -y</span><br><span class="line"><span class="meta">#</span><span class="bash">修改主配置文件</span></span><br><span class="line">/etc/named.conf</span><br><span class="line">        listen-on port 53 &#123; any; &#125;; #11</span><br><span class="line">        allow-query     &#123; any; &#125;;#19</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">正反向解析</span></span><br><span class="line"><span class="meta">#</span><span class="bash">第一步：编辑区域配置文件</span></span><br><span class="line">/etc/named.rfc1912.zones</span><br><span class="line"><span class="meta">#</span><span class="bash">新增两行</span></span><br><span class="line">zone &quot;skills.com&quot; IN &#123;</span><br><span class="line">        type master;</span><br><span class="line">        file &quot;skills.com.zone&quot;;</span><br><span class="line">        allow-update &#123; none; &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">zone &quot;70.10.10.in-addr.arpa&quot; IN &#123;</span><br><span class="line">        type master;</span><br><span class="line">        file &quot;10.10.70.arpa&quot;;</span><br><span class="line">        allow-update &#123; none; &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">第二布，编写解析配置文件</span></span><br><span class="line">cp -p named.localhost skills.com.zone</span><br><span class="line"><span class="meta">#</span><span class="bash">修改正向解析文件</span></span><br><span class="line">cat skills.com.zone </span><br><span class="line"><span class="meta">$</span><span class="bash">TTL 1D</span></span><br><span class="line">@       IN SOA  @ rname.invalid. (</span><br><span class="line">                                        0       ; serial</span><br><span class="line">                                        1D      ; refresh</span><br><span class="line">                                        1H      ; retry</span><br><span class="line">                                        1W      ; expire</span><br><span class="line">                                        3H )    ; minimum</span><br><span class="line">        NS      @</span><br><span class="line">        A       127.0.0.1</span><br><span class="line">master  A       10.10.70.101</span><br><span class="line">slave   A       10.10.70.102</span><br><span class="line"><span class="meta">#</span><span class="bash">修改反向解析文件</span></span><br><span class="line">cp -p named.loopback 10.10.70.arpa</span><br><span class="line"><span class="meta">$</span><span class="bash">TTL 1D</span></span><br><span class="line">@       IN SOA  @ rname.invalid. (</span><br><span class="line">                                        0       ; serial</span><br><span class="line">                                        1D      ; refresh</span><br><span class="line">                                        1H      ; retry</span><br><span class="line">                                        1W      ; expire</span><br><span class="line">                                        3H )    ; minimum</span><br><span class="line">        NS      @</span><br><span class="line">        A       127.0.0.1</span><br><span class="line">101     PTR     master.skills.com.</span><br><span class="line">102     PTR     slave.skills.com.</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">启动DNS服务</span></span><br><span class="line">systemctl start named</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">使用nslookup进行解析测试</span></span><br><span class="line">nslookup master.skills.com</span><br><span class="line">Server:         10.10.70.101</span><br><span class="line">Address:        10.10.70.101#53</span><br><span class="line"></span><br><span class="line">Name:   master.skills.com</span><br><span class="line">Address: 10.10.70.101</span><br><span class="line"></span><br><span class="line">nslookup slave.skills.com</span><br><span class="line">Server:         10.10.70.101</span><br><span class="line">Address:        10.10.70.101#53</span><br><span class="line"></span><br><span class="line">Name:   slave.skills.com</span><br><span class="line">Address: 10.10.70.102</span><br><span class="line"></span><br><span class="line">nslookup 10.10.70.101</span><br><span class="line">101.70.10.10.in-addr.arpa       name = master.skills.com.</span><br><span class="line"></span><br><span class="line">nslookup 10.10.70.102</span><br><span class="line">102.70.10.10.in-addr.arpa       name = slave.skills.com.</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">防火墙开放DNS服务</span></span><br><span class="line">firewall-cmd --add-service=dns</span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="slave服务器"><a href="#slave服务器" class="headerlink" title="slave服务器"></a>slave服务器</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#安装DNS服务软件BIND与测试软件BIND-UTILS</span></span><br><span class="line">yum install <span class="built_in">bind</span> bind-utils -y</span><br><span class="line"><span class="comment">#修改主配置文件</span></span><br><span class="line">/etc/named.conf</span><br><span class="line">        listen-on port 53 &#123; any; &#125;; <span class="comment">#11</span></span><br><span class="line">        allow-query     &#123; any; &#125;;<span class="comment">#19</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#修改区域配置文件</span></span><br><span class="line">/etc/named.rfc1912.zones </span><br><span class="line"></span><br><span class="line">zone <span class="string">&quot;skills.com&quot;</span> IN &#123;</span><br><span class="line">        <span class="built_in">type</span> slave;</span><br><span class="line">        masters &#123;10.10.70.101;&#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">zone <span class="string">&quot;70.10.10.in-addr.arpa&quot;</span> IN &#123;</span><br><span class="line">        <span class="built_in">type</span> slave;</span><br><span class="line">        masters &#123;10.10.70.101;&#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">#启动DNS服务</span></span><br><span class="line">systemctl start named</span><br><span class="line"></span><br><span class="line"><span class="comment">#测试</span></span><br><span class="line">nslookup </span><br><span class="line">&gt; server localhost</span><br><span class="line">Default server: localhost</span><br><span class="line">Address: ::1<span class="comment">#53</span></span><br><span class="line">Default server: localhost</span><br><span class="line">Address: 127.0.0.1<span class="comment">#53</span></span><br><span class="line">&gt; master.skills.com</span><br><span class="line">Server:         localhost</span><br><span class="line">Address:        ::1<span class="comment">#53</span></span><br><span class="line"></span><br><span class="line">Name:   master.skills.com</span><br><span class="line">Address: 10.10.70.101</span><br><span class="line">&gt; slave.skills.com</span><br><span class="line">Server:         localhost</span><br><span class="line">Address:        ::1<span class="comment">#53</span></span><br><span class="line"></span><br><span class="line">Name:   slave.skills.com</span><br><span class="line">Address: 10.10.70.102</span><br><span class="line">&gt; 10.10.70.101</span><br><span class="line">101.70.10.10.in-addr.arpa       name = master.skills.com.</span><br><span class="line">&gt; 10.10.70.102</span><br><span class="line">102.70.10.10.in-addr.arpa       name = slave.skills.com.</span><br><span class="line"><span class="comment">#测试成功</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;/assets/css/APlayer.min.css&quot;&gt;&lt;script src=&quot;/assets/js/APlayer.min.js&quot; cla</summary>
      
    
    
    
    <category term="Linux" scheme="https://www.hnswxx.cn/categories/Linux/"/>
    
    
    <category term="Centos8" scheme="https://www.hnswxx.cn/tags/Centos8/"/>
    
    <category term="DNS" scheme="https://www.hnswxx.cn/tags/DNS/"/>
    
  </entry>
  
  <entry>
    <title>Linux-DNS正反向解析</title>
    <link href="https://www.hnswxx.cn/2021/11/23/dns-forward-and-reverse-resolution/"/>
    <id>https://www.hnswxx.cn/2021/11/23/dns-forward-and-reverse-resolution/</id>
    <published>2021-11-23T07:37:27.000Z</published>
    <updated>2021-12-11T04:37:10.437Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h3 id="DNS介绍"><a href="#DNS介绍" class="headerlink" title="DNS介绍"></a>DNS介绍</h3><h4 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h4><hr><p><strong>域名系统</strong>（英文：<strong>D</strong>omain <strong>N</strong>ame <strong>S</strong>ystem，缩写：<strong>DNS</strong>）是互联网的一项服务。它作为将域名和IP地址 相互映射的一个分布式数据库，能够使人更方便地访问互联网。DNS使用UDP端口53。当前，对于每一 级域名长度的限制是63个字符，域名总长度则不能超过253个字符。</p><h4 id="形式"><a href="#形式" class="headerlink" title="形式"></a>形式</h4><hr><p><a href="https://baike.baidu.com/item/%E5%9F%9F%E5%90%8D%E6%9C%8D%E5%8A%A1%E5%99%A8">域名服务器</a>通常会有两种形式：权威域名服务器，以及缓存域名服务器。 权威域名服务器 下列情况需要有权威域名服务器：想要向全世界提供DNS信息，并对请求给出权威应答。注册了类似 example org的域，而需要将IP指定到其下的<a href="https://baike.baidu.com/item/%E4%B8%BB%E6%9C%BA%E5%90%8D">主机名</a>上。某个IP地址块需要反向DNS项(IP 到主机名)。备 份服务器，或常说的从(slave) 服务器，会在主服务器出现问题或无法访问时来应答查询请求。 </p><h4 id="缓存域名服务器"><a href="#缓存域名服务器" class="headerlink" title="缓存域名服务器"></a>缓存域名服务器</h4><hr><p>下列情况需要有缓存域名服务器： 本地的DNS服务器能够缓存，并比直接向外界的域名服务器请求更快 地得到应答。 当有人查询 <strong><a href="http://www.freebsd.org/">www.FreeBSD.org</a></strong> 时，解析器通常会向上级ISP的域名服务器发出请求，并获得回应。如果有 本地的缓存DNS服务器，查询只有在第一次被缓存DNS服务器发到外部世界。其他的查询不会发向局域 网外，因为它们已经有在本地的缓存了。 </p><h4 id="解析过程"><a href="#解析过程" class="headerlink" title="解析过程"></a>解析过程</h4><hr><p>当一台机器a向其域名服务器A发出域名解析请求时，如果A可以解析，则将解析结果发给a，否则，A将 向其上级域名服务器B发出解析请求，如果B能解析，则将解析结果发给a，如果B无法解析，则将请求发 给再上一级域名服务器C，如此下去，直至解析到为止。</p><h3 id="DNS配置简介"><a href="#DNS配置简介" class="headerlink" title="DNS配置简介"></a>DNS配置简介</h3><h4 id="DNS软件包"><a href="#DNS软件包" class="headerlink" title="DNS软件包"></a>DNS软件包</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@dns /]<span class="comment"># yum install bind bind-utils -y</span></span><br></pre></td></tr></table></figure><h4 id="DNS的主配置文件"><a href="#DNS的主配置文件" class="headerlink" title="DNS的主配置文件"></a>DNS的主配置文件</h4><p>Bind的主配置文件是etc/name.conf,该文件是文本文件，除了主配置文件外，/var/named目录下的所有文件都是DNS服务器的相关配置文件，下面详细讲述这些文件的配置。</p><ol><li>name.conf文件详解</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">options &#123;</span><br><span class="line">    listen-on port 53 &#123; 127.0.0.1; &#125;;      //设置named服务器监听端口及IP地址</span><br><span class="line">    listen-on-v6 port 53 &#123; ::1; &#125;;</span><br><span class="line">    directory       <span class="string">&quot;/var/named&quot;</span>;    //设置区域数据库文件的默认存放地址</span><br><span class="line">    dump-file       <span class="string">&quot;/var/named/data/cache_dump.db&quot;</span>;</span><br><span class="line">    statistics-file <span class="string">&quot;/var/named/data/named_stats.txt&quot;</span>;</span><br><span class="line">    memstatistics-file <span class="string">&quot;/var/named/data/named_mem_stats.txt&quot;</span>;</span><br><span class="line"></span><br><span class="line">    allow-query     &#123; localhost; &#125;;   //允许DNS查询客户端</span><br><span class="line">    allow-query-cache &#123; any; &#125;;</span><br><span class="line">&#125;;</span><br><span class="line">logging &#123;</span><br><span class="line">    channel default_debug &#123;</span><br><span class="line">    file <span class="string">&quot;data/named.run&quot;</span>;</span><br><span class="line">    severity dynamic;</span><br><span class="line">&#125;;</span><br><span class="line">&#125;;</span><br><span class="line">view localhost_resolver &#123;</span><br><span class="line">    match-clients      &#123; any; &#125;;</span><br><span class="line">    match-destinations &#123; any; &#125;;</span><br><span class="line">    recursion yes;                  //设置允许递归查询</span><br><span class="line">    include <span class="string">&quot;/etc/named.rfc1912.zones&quot;</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ol start="2"><li>区域配置文件/etc/named.rfc1912.zones</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">zone <span class="string">&quot;.&quot;</span> IN &#123;    //定义了根域</span><br><span class="line">    <span class="built_in">type</span> hint;       //定义服务器类型为hint</span><br><span class="line">    file <span class="string">&quot;named.ca&quot;</span>;  //定义根域的配置文件名</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">zone <span class="string">&quot;localdomain&quot;</span> IN &#123;   //定义正向DNS区域</span><br><span class="line">    <span class="built_in">type</span> master;              //定义区域类型</span><br><span class="line">    file <span class="string">&quot;localdomain.zone&quot;</span>;  //设置对应的正向区域地址数据库文件</span><br><span class="line">    allow-update &#123; none; &#125;;   //设置允许动态更新的客户端地址（none为禁止）</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">zone <span class="string">&quot;localhost&quot;</span> IN &#123;</span><br><span class="line">    <span class="built_in">type</span> master;</span><br><span class="line">    file <span class="string">&quot;localhost.zone&quot;</span>;</span><br><span class="line">    allow-update &#123; none; &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">zone <span class="string">&quot;0.0.127.in-addr.arpa&quot;</span> IN &#123;   //设置反向DNS区域</span><br><span class="line">    <span class="built_in">type</span> master;</span><br><span class="line">    file <span class="string">&quot;named.local&quot;</span>;</span><br><span class="line">    allow-update &#123; none; &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ol start="3"><li><p>根域配置文件named.ca</p><p>根域配置文件设定根域的域名数据库，包括根域中13台DNS服务器的信息。几乎所有系统的这个文件都是一样的，用户不需要进行修改。</p></li><li><p>正向域名解析数据库文件</p></li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$TTL</span> 600</span><br><span class="line">@        IN   SOA    dns.cwlinux.com   dnsadmin.cwlinux.com. (//SOA字段</span><br><span class="line">                          2015031288   //版本号    同步一次  +1</span><br><span class="line">                             1H        //更新时间</span><br><span class="line">                             2M        // 更新失败，重试更新时间</span><br><span class="line">                             2D        // 更新失败多长时间后此DNS失效时间</span><br><span class="line">                             1D        //解析不到请求不予回复时间</span><br><span class="line">)</span><br><span class="line">         IN    NS   dns            //有两域名服务器</span><br><span class="line">         IN    NS   ns2</span><br><span class="line">         IN    MX  10 mial        // 定义邮件服务器，10指优先级  0-99 数字越小优先级越高</span><br><span class="line">ns2      IN    A    192.168.1.113  //ns2域名服务器的ip地址</span><br><span class="line">dns      IN    A    192.168.1.10   //dns域名服务器的ip地址</span><br><span class="line">mail     IN    A    192.168.1.111   //邮件服务器的ip地址</span><br><span class="line">www      IN    A    192.168.1.112   //www.cwlinux.com的ip地址</span><br><span class="line">pop      IN   CNAME  mail         //pop的正式名字是mail</span><br><span class="line">ftp      IN   CNAME  www         //ftp的正式名字是www</span><br></pre></td></tr></table></figure><ol start="5"><li>反向域名解析数据库文件</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$TTL</span> 600</span><br><span class="line">@         IN   SOA    dns.cwlinux.com.   dnsadmin.cwlinux.com. (</span><br><span class="line">                             2014031224</span><br><span class="line">                             1H</span><br><span class="line">                             2M</span><br><span class="line">                             2D</span><br><span class="line">                             1D</span><br><span class="line">)</span><br><span class="line">         IN   NS      dns.cwlinux.com.</span><br><span class="line">10       IN   PTR     dns.cwlinux.com.     //反向解析PTR格式</span><br><span class="line">111       IN   PTR     mail.cwlinux.com.</span><br><span class="line">112       IN   PTR     www.cwlinux.com.</span><br><span class="line">// 声明域的时候已经有了，192.168.1 所以我们只需要输入10既代表192.168.1.10jc</span><br></pre></td></tr></table></figure><h3 id="DNS配置示例"><a href="#DNS配置示例" class="headerlink" title="DNS配置示例"></a>DNS配置示例</h3><h4 id="环境介绍"><a href="#环境介绍" class="headerlink" title="环境介绍"></a>环境介绍</h4><table><thead><tr><th align="center">IP</th><th align="center">主机名</th><th>角色</th></tr></thead><tbody><tr><td align="center">192.168.10.102</td><td align="center">dns.skills.com</td><td>DNS服务器</td></tr></tbody></table><h4 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#修改/etc/named.conf </span></span><br><span class="line">//</span><br><span class="line">// named.conf</span><br><span class="line">//</span><br><span class="line">// Provided by Red Hat <span class="built_in">bind</span> package to configure the ISC BIND named(8) DNS</span><br><span class="line">// server as a caching only nameserver (as a localhost DNS resolver only).</span><br><span class="line">//</span><br><span class="line">// See /usr/share/doc/<span class="built_in">bind</span>*/sample/ <span class="keyword">for</span> example named configuration files.</span><br><span class="line">//</span><br><span class="line"></span><br><span class="line">options &#123;</span><br><span class="line">        listen-on port 53 &#123; any; &#125;; <span class="comment">#设置named服务器监听端口及IP地址 为any</span></span><br><span class="line">        listen-on-v6 port 53 &#123; ::1; &#125;;</span><br><span class="line">        directory       <span class="string">&quot;/var/named&quot;</span>;</span><br><span class="line">        dump-file       <span class="string">&quot;/var/named/data/cache_dump.db&quot;</span>;</span><br><span class="line">        statistics-file <span class="string">&quot;/var/named/data/named_stats.txt&quot;</span>;</span><br><span class="line">        memstatistics-file <span class="string">&quot;/var/named/data/named_mem_stats.txt&quot;</span>;</span><br><span class="line">        secroots-file   <span class="string">&quot;/var/named/data/named.secroots&quot;</span>;</span><br><span class="line">        recursing-file  <span class="string">&quot;/var/named/data/named.recursing&quot;</span>;</span><br><span class="line">        allow-query     &#123; any; &#125;; <span class="comment">#允许DNS查询客户端</span></span><br><span class="line"></span><br><span class="line">        /* </span><br><span class="line">         - If you are building an AUTHORITATIVE DNS server, <span class="keyword">do</span> NOT <span class="built_in">enable</span> recursion.</span><br><span class="line">         - If you are building a RECURSIVE (caching) DNS server, you need to <span class="built_in">enable</span> </span><br><span class="line">           recursion. </span><br><span class="line">         - If your recursive DNS server has a public IP address, you MUST <span class="built_in">enable</span> access </span><br><span class="line">           control to <span class="built_in">limit</span> queries to your legitimate users. Failing to <span class="keyword">do</span> so will</span><br><span class="line">           cause your server to become part of large scale DNS amplification </span><br><span class="line">           attacks. Implementing BCP38 within your network would greatly</span><br><span class="line">           reduce such attack surface </span><br><span class="line">        */</span><br><span class="line">        recursion yes;</span><br><span class="line"></span><br><span class="line">        dnssec-enable yes;</span><br><span class="line">        dnssec-validation yes;</span><br><span class="line"></span><br><span class="line">        managed-keys-directory <span class="string">&quot;/var/named/dynamic&quot;</span>;</span><br><span class="line"></span><br><span class="line">        pid-file <span class="string">&quot;/run/named/named.pid&quot;</span>;</span><br><span class="line">        session-keyfile <span class="string">&quot;/run/named/session.key&quot;</span>;</span><br><span class="line"></span><br><span class="line">        /* https://fedoraproject.org/wiki/Changes/CryptoPolicy */</span><br><span class="line">        include <span class="string">&quot;/etc/crypto-policies/back-ends/bind.config&quot;</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">logging &#123;</span><br><span class="line">        channel default_debug &#123;</span><br><span class="line">                file <span class="string">&quot;data/named.run&quot;</span>;</span><br><span class="line">                severity dynamic;</span><br><span class="line">        &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">zone <span class="string">&quot;.&quot;</span> IN &#123;</span><br><span class="line">        <span class="built_in">type</span> hint;</span><br><span class="line">        file <span class="string">&quot;named.ca&quot;</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">include <span class="string">&quot;/etc/named.rfc1912.zones&quot;</span>;</span><br><span class="line">include <span class="string">&quot;/etc/named.root.key&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">#修改/etc/named.rfc1912.zones </span></span><br><span class="line"><span class="comment">#定义正反向区域</span></span><br><span class="line">zone <span class="string">&quot;skills.com&quot;</span> IN &#123;</span><br><span class="line">        <span class="built_in">type</span> master;</span><br><span class="line">        file <span class="string">&quot;skills.com.zone&quot;</span>;</span><br><span class="line">        allow-update &#123; none; &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">zone <span class="string">&quot;10.168.192.in-addr.arpa&quot;</span> IN &#123;</span><br><span class="line">        <span class="built_in">type</span> master;</span><br><span class="line">        file <span class="string">&quot;192.168.10.arpa&quot;</span>;</span><br><span class="line">        allow-update &#123; none; &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">#增加正反向解析数据库文件</span></span><br><span class="line"><span class="built_in">cd</span> /var/named/</span><br><span class="line">cp -p named.localhost skills.com.zone</span><br><span class="line">cp -p named.loopback 192.168.10.arpa</span><br><span class="line"></span><br><span class="line"><span class="comment">#修改正反向数据库文件</span></span><br><span class="line"><span class="comment">#skills.com.zone 正向解析</span></span><br><span class="line"><span class="variable">$TTL</span> 1D</span><br><span class="line">@       IN SOA  @ rname.invalid. (</span><br><span class="line">                                        0       ; serial</span><br><span class="line">                                        1D      ; refresh</span><br><span class="line">                                        1H      ; retry</span><br><span class="line">                                        1W      ; expire</span><br><span class="line">                                        3H )    ; minimum</span><br><span class="line">        NS      @</span><br><span class="line">        A       127.0.0.1</span><br><span class="line">dns     A       192.168.10.102</span><br><span class="line">abc     A       192.168.10.103</span><br><span class="line">bcd     A       192.168.10.104</span><br><span class="line"></span><br><span class="line"><span class="comment">#192.168.10.arpa 反向解析</span></span><br><span class="line"><span class="variable">$TTL</span> 1D</span><br><span class="line">@       IN SOA  @ rname.invalid. (</span><br><span class="line">                                        0       ; serial</span><br><span class="line">                                        1D      ; refresh</span><br><span class="line">                                        1H      ; retry</span><br><span class="line">                                        1W      ; expire</span><br><span class="line">                                        3H )    ; minimum</span><br><span class="line">        NS      @</span><br><span class="line">        A       127.0.0.1</span><br><span class="line">102     PTR     dns.skills.com.</span><br><span class="line">103     PTR     abc.skills.com.</span><br><span class="line">104     PTR     bcd.skills.com.</span><br><span class="line"></span><br><span class="line"><span class="comment">#nslookup 测试 （本机DNS设置为本机IP自测）</span></span><br><span class="line"><span class="comment">#正向测试</span></span><br><span class="line">nslookup </span><br><span class="line">&gt; dns.skills.com</span><br><span class="line">Server:         192.168.10.102</span><br><span class="line">Address:        192.168.10.102<span class="comment">#53</span></span><br><span class="line"></span><br><span class="line">Name:   dns.skills.com</span><br><span class="line">Address: 192.168.10.102</span><br><span class="line">&gt; abc.skills.com</span><br><span class="line">Server:         192.168.10.102</span><br><span class="line">Address:        192.168.10.102<span class="comment">#53</span></span><br><span class="line"></span><br><span class="line">Name:   abc.skills.com</span><br><span class="line">Address: 192.168.10.103</span><br><span class="line">&gt; bcd.skills.com</span><br><span class="line">Server:         192.168.10.102</span><br><span class="line">Address:        192.168.10.102<span class="comment">#53</span></span><br><span class="line"></span><br><span class="line">Name:   bcd.skills.com</span><br><span class="line">Address: 192.168.10.104</span><br><span class="line">&gt; </span><br><span class="line"></span><br><span class="line"><span class="comment">#反向测试</span></span><br><span class="line">nslookup </span><br><span class="line">&gt; 192.168.10.102</span><br><span class="line">102.10.168.192.in-addr.arpa     name = dns.skills.com.</span><br><span class="line">&gt; 192.168.10.103</span><br><span class="line">103.10.168.192.in-addr.arpa     name = abc.skills.com.</span><br><span class="line">&gt; 192.168.10.104</span><br><span class="line">104.10.168.192.in-addr.arpa     name = bcd.skills.com.</span><br><span class="line">&gt; </span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;/assets/css/APlayer.min.css&quot;&gt;&lt;script src=&quot;/assets/js/APlayer.min.js&quot; cla</summary>
      
    
    
    
    <category term="Linux" scheme="https://www.hnswxx.cn/categories/Linux/"/>
    
    
    <category term="Centos8" scheme="https://www.hnswxx.cn/tags/Centos8/"/>
    
    <category term="DNS" scheme="https://www.hnswxx.cn/tags/DNS/"/>
    
  </entry>
  
  <entry>
    <title>Centos7&amp;Centos8本地yum源配置（VMware）</title>
    <link href="https://www.hnswxx.cn/2021/11/22/yum-local-source-configuration/"/>
    <id>https://www.hnswxx.cn/2021/11/22/yum-local-source-configuration/</id>
    <published>2021-11-22T02:01:49.000Z</published>
    <updated>2021-11-22T04:02:08.467Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><div class="note red icon simple"><i class="note-icon fas fa-fan"></i><h4 id="yum介绍"><a href="#yum介绍" class="headerlink" title="yum介绍"></a>yum介绍</h4></div><p>​    Yum（全称为 Yellow dog Updater, Modified/黄狗更新程序，修改）是一个在Fedora和RedHat以及CentOS中的Shell前端软件包管理器。基于RPM包管理，能够从指定的服务器自动下载RPM包并且安装，可以自动处理依赖性关系，并且一次安装所有依赖的软件包，无须繁琐地一次次下载、安装。</p><div class="note red icon simple"><i class="note-icon fas fa-fan"></i><h4 id="常用命令详解"><a href="#常用命令详解" class="headerlink" title="常用命令详解"></a>常用命令详解</h4></div><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#使用 yum 查找软件包： </span></span><br><span class="line">yum search PACKAGE_NAME</span><br><span class="line"><span class="comment">#列出所有可安装的软件包： </span></span><br><span class="line">yum list PACKAGE_NAME</span><br><span class="line"><span class="comment">#列出所有可更新的软件包： </span></span><br><span class="line">yum list updates</span><br><span class="line"><span class="comment">#列出所有已安装的软件包： </span></span><br><span class="line">yum list installed</span><br><span class="line"><span class="comment">#列出所有已安装但不在 </span></span><br><span class="line">Yum Repository 内的软件包： yum list extras</span><br><span class="line"><span class="comment">#列出所指定的软件包： </span></span><br><span class="line">yum list PACKAGE_NAME</span><br><span class="line"><span class="comment">#使用 yum 获取软件包信息： </span></span><br><span class="line">yum info PACKAGE_NAME</span><br><span class="line"><span class="comment">#列出软件包提供哪些文件：</span></span><br><span class="line">yum provides PACKAGE_NAME</span><br><span class="line"><span class="comment">#找出某个文件所对应的软件包：</span></span><br><span class="line">yum whatprovides FILE_NAME      <span class="comment"># 常常用于查找某个命令所对应的软件包</span></span><br><span class="line"><span class="comment">#更新具体的yum包： </span></span><br><span class="line">yum update PACKAGE_NAME</span><br><span class="line"><span class="comment">#显示已启用的YUM仓库列表：</span></span><br><span class="line">yum repolist</span><br><span class="line"><span class="comment">#清除YUM缓存：</span></span><br><span class="line">yum clean all</span><br><span class="line"><span class="comment">#卸载yum包： </span></span><br><span class="line">yum remove PACKAGE_NAME</span><br><span class="line"><span class="comment">#取出yum包： </span></span><br><span class="line">yum downloader PACKAGE_NAME</span><br><span class="line"><span class="comment">#重新安装一个yum包： </span></span><br><span class="line">yum reinstall  PACKAGE_NAME</span><br><span class="line"><span class="comment">#安装一个yum包：</span></span><br><span class="line">yum install  PACKAGE_NAME</span><br></pre></td></tr></table></figure><div class="note red icon simple"><i class="note-icon fas fa-fan"></i><h4 id="配置文件详解"><a href="#配置文件详解" class="headerlink" title="配置文件详解"></a>配置文件详解</h4></div><p><strong>repo文件的格式</strong></p><p>所有repository 服务器设置都应该遵循如下格式：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[serverid]</span><br><span class="line">name=Some name <span class="keyword">for</span> this server</span><br><span class="line">baseurl=url://path/to/repository/</span><br></pre></td></tr></table></figure><ul><li><strong>serverid</strong> 是用于区别各个不同的repository，必须有一个独一无二的名称；</li><li><strong>name</strong> 是对repository 的描述，支持像releaseverreleaseverbasearch这样的变量；</li><li><strong>baseurl</strong> 是服务器设置中最重要的部分，只有设置正确，才能从上面获取软件。它的格式是</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">baseurl=url://server1/path/to/repository/</span><br><span class="line">　　　　 url://server2/path/to/repository/</span><br><span class="line">　　　　 url://server3/path/to/repository/</span><br></pre></td></tr></table></figure><p>其中url 支持的协议有 http:// ftp:// file:// 三种。baseurl 后可以跟多个url，你可以自己改为速度比较快的镜像站，但baseurl 只能有一个，也就是说不能像如下格式：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">baseurl=url://server1/path/to/repository/</span><br><span class="line">baseurl=url://server2/path/to/repository/</span><br><span class="line">baseurl=url://server3/path/to/repository/</span><br></pre></td></tr></table></figure><p>其中url 指向的目录必须是这个repository header 目录的上一级，它也支持$releasever $basearch 这样的变量。<br>url 之后可以加上多个选项，如gpgcheck、exclude、failovermethod 等，比如：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[updates-released]</span><br><span class="line">name=Fedora Core <span class="variable">$releasever</span> - <span class="variable">$basearch</span> - Released Updates</span><br><span class="line">baseurl=http://download.atrpms.net/mirrors/fedoracore/updates/<span class="variable">$releasever</span>/<span class="variable">$basearch</span></span><br><span class="line">　　　　 http://redhat.linux.ee/pub/fedora/linux/core/updates/<span class="variable">$releasever</span>/<span class="variable">$basearch</span></span><br><span class="line">　　　　 http://fr2.rpmfind.net/linux/fedora/core/updates/<span class="variable">$releasever</span>/<span class="variable">$basearch</span></span><br><span class="line">gpgcheck=1</span><br><span class="line">exclude=gaim</span><br><span class="line">failovermethod=priority</span><br></pre></td></tr></table></figure><p>其中gpgcheck，exclude 的含义和[main] 部分相同，但只对此服务器起作用，failovermethode 有两个选项roundrobin 和priority，意思分别是有多个url可供选择时，yum 选择的次序，roundrobin 是随机选择，如果连接失败则使用下一个，依次循环，priority 则根据url 的次序从第一个开始。如果不指明，默认是roundrobin。</p><p>关于变量</p><ul><li><strong>$releasever</strong>：代表发行版的版本，从[main]部分的distroverpkg获取，如果没有，则根据redhat-release包进行判断。</li><li><strong>$arch</strong>：cpu体系，如i686,athlon等</li><li><strong>$basearch</strong>：cpu的基本体系组，如i686和athlon同属i386，alpha和alphaev6同属alpha。</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[main]</span><br><span class="line">cachedir=/var/cache/yum     <span class="comment">#yum下载的RPM包的缓存目录</span></span><br><span class="line">keepcache=0             <span class="comment">#缓存是否保存，1保存，0不保存。</span></span><br><span class="line">logfile=/var/<span class="built_in">log</span>/yum.log    <span class="comment">#yum的日志文件所在的位置</span></span><br><span class="line">exactarch=1             <span class="comment">#在更新的时候，是否允许更新不同版本的RPM包，比如是否在i386上更新i686的RPM包。</span></span><br><span class="line">obsoletes=1             <span class="comment">#这是一个update的参数，简单的说就是相当于upgrade，允许更新陈旧的RPM包。</span></span><br><span class="line">gpgcheck=1             <span class="comment">#是否检查GPG(GNU Private Guard)，一种密钥方式签名。</span></span><br><span class="line">plugins=1              <span class="comment">#是否允许使用插件，默认是0不允许，但是我们一般会用yum-fastestmirror这个插件。</span></span><br><span class="line">installonly_limit=3       <span class="comment">#允许保留多少个内核包。</span></span><br><span class="line">exclude=selinux*         <span class="comment">#屏蔽不想更新的RPM包，可用通配符，多个RPM包之间使用空格分离。</span></span><br></pre></td></tr></table></figure><h4 id="操作步骤"><a href="#操作步骤" class="headerlink" title="操作步骤"></a>操作步骤</h4><div class="tabs" id="yum"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#yum-1">Centos7</button></li><li class="tab"><button type="button" data-href="#yum-2">Centos8</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="yum-1"><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># cd /etc/yum.repos.d/ #进入yum仓库配置文件夹</span></span><br><span class="line">[root@localhost yum.repos.d]<span class="comment"># ll</span></span><br><span class="line">total 40</span><br><span class="line">-rw-r--r--. 1 root root 1664 Oct 23  2020 CentOS-Base.repo</span><br><span class="line">-rw-r--r--. 1 root root 1309 Oct 23  2020 CentOS-CR.repo</span><br><span class="line">-rw-r--r--. 1 root root  649 Oct 23  2020 CentOS-Debuginfo.repo</span><br><span class="line">-rw-r--r--. 1 root root  314 Oct 23  2020 CentOS-fasttrack.repo</span><br><span class="line">-rw-r--r--. 1 root root  630 Oct 23  2020 CentOS-Media.repo</span><br><span class="line">-rw-r--r--. 1 root root 1331 Oct 23  2020 CentOS-Sources.repo</span><br><span class="line">-rw-r--r--. 1 root root 8515 Oct 23  2020 CentOS-Vault.repo</span><br><span class="line">-rw-r--r--. 1 root root  616 Oct 23  2020 CentOS-x86_64-kernel.repo</span><br><span class="line">[root@localhost yum.repos.d]<span class="comment"># mkdir bak #创建bak文件夹</span></span><br><span class="line">[root@localhost yum.repos.d]<span class="comment"># mv * bak/ #把不用的文件移动进去</span></span><br><span class="line">mv: cannot move ‘bak’ to a subdirectory of itself, ‘bak/bak’</span><br><span class="line">[root@localhost yum.repos.d]<span class="comment"># mv bak/CentOS-Media.repo . #把要用的CentOS-Media.repo移动出来</span></span><br><span class="line">[root@localhost yum.repos.d]<span class="comment"># vi CentOS-Media.repo #编辑该文件</span></span><br><span class="line"><span class="comment"># CentOS-Media.repo</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  This repo can be used with mounted DVD media, verify the mount point for</span></span><br><span class="line"><span class="comment">#  CentOS-7.  You can use this repo and yum to install items directly off the</span></span><br><span class="line"><span class="comment">#  DVD ISO that we release.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># To use this repo, put in your DVD and use it with the other repos too:</span></span><br><span class="line"><span class="comment">#  yum --enablerepo=c7-media [command]</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># or for ONLY the media repo, do this:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  yum --disablerepo=\* --enablerepo=c7-media [command]</span></span><br><span class="line"></span><br><span class="line">[c7-media]</span><br><span class="line">name=CentOS-<span class="variable">$releasever</span> - Media </span><br><span class="line">baseurl=file:///media/</span><br><span class="line">gpgcheck=0</span><br><span class="line">enabled=1</span><br><span class="line">gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-7</span><br><span class="line">[root@localhost yum.repos.d]<span class="comment"># mount /dev/cdrom /media/ #把镜像挂载到指定的media目录</span></span><br><span class="line">mount: /dev/sr0 is write-protected, mounting read-only</span><br><span class="line">[root@localhost ~]<span class="comment"># yum repolist #查看启用的仓库</span></span><br><span class="line">Loaded plugins: fastestmirror</span><br><span class="line">Loading mirror speeds from cached hostfile</span><br><span class="line">repo id                                     repo name                                           status</span><br><span class="line">c7-media                                    CentOS-7 - Media                                    4,070</span><br><span class="line">repolist: 4,070</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="yum-2"><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># cd /etc/yum.repos.d/</span></span><br><span class="line">[root@localhost yum.repos.d]<span class="comment"># ll</span></span><br><span class="line">total 48</span><br><span class="line">-rw-r--r--. 1 root root  719 Nov  9  2020 CentOS-Linux-AppStream.repo</span><br><span class="line">-rw-r--r--. 1 root root  704 Nov  9  2020 CentOS-Linux-BaseOS.repo</span><br><span class="line">-rw-r--r--. 1 root root 1130 Nov  9  2020 CentOS-Linux-ContinuousRelease.repo</span><br><span class="line">-rw-r--r--. 1 root root  318 Nov  9  2020 CentOS-Linux-Debuginfo.repo</span><br><span class="line">-rw-r--r--. 1 root root  732 Nov  9  2020 CentOS-Linux-Devel.repo</span><br><span class="line">-rw-r--r--. 1 root root  704 Nov  9  2020 CentOS-Linux-Extras.repo</span><br><span class="line">-rw-r--r--. 1 root root  719 Nov  9  2020 CentOS-Linux-FastTrack.repo</span><br><span class="line">-rw-r--r--. 1 root root  740 Nov  9  2020 CentOS-Linux-HighAvailability.repo</span><br><span class="line">-rw-r--r--. 1 root root  693 Nov  9  2020 CentOS-Linux-Media.repo</span><br><span class="line">-rw-r--r--. 1 root root  706 Nov  9  2020 CentOS-Linux-Plus.repo</span><br><span class="line">-rw-r--r--. 1 root root  724 Nov  9  2020 CentOS-Linux-PowerTools.repo</span><br><span class="line">-rw-r--r--. 1 root root  898 Nov  9  2020 CentOS-Linux-Sources.repo</span><br><span class="line">[root@localhost yum.repos.d]<span class="comment"># mkdir bak</span></span><br><span class="line">[root@localhost yum.repos.d]<span class="comment"># mv * bak/</span></span><br><span class="line">mv: cannot move <span class="string">&#x27;bak&#x27;</span> to a subdirectory of itself, <span class="string">&#x27;bak/bak&#x27;</span></span><br><span class="line">[root@localhost yum.repos.d]<span class="comment"># mv bak/CentOS-Linux-Media.repo .</span></span><br><span class="line">[root@localhost yum.repos.d]<span class="comment"># vi CentOS-Linux-Media.repo </span></span><br><span class="line"><span class="comment"># CentOS-Linux-Media.repo</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># You can use this repo to install items directly off the installation media.</span></span><br><span class="line"><span class="comment"># Verify your mount point matches one of the below file:// paths.</span></span><br><span class="line"></span><br><span class="line">[media-baseos]</span><br><span class="line">name=CentOS Linux <span class="variable">$releasever</span> - Media - BaseOS</span><br><span class="line">baseurl=file:///media/CentOS/BaseOS</span><br><span class="line">gpgcheck=0</span><br><span class="line">enabled=1</span><br><span class="line">gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-centosofficial</span><br><span class="line"></span><br><span class="line">[media-appstream]</span><br><span class="line">name=CentOS Linux <span class="variable">$releasever</span> - Media - AppStream</span><br><span class="line">baseurl=file:///media/CentOS/AppStream</span><br><span class="line">gpgcheck=0</span><br><span class="line">enabled=1</span><br><span class="line">gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-centosofficial</span><br><span class="line">[root@localhost yum.repos.d]<span class="comment"># mkdir /media/CentOS</span></span><br><span class="line">[root@localhost yum.repos.d]<span class="comment"># mount /dev/cdrom /media/CentOS/</span></span><br><span class="line">mount: /media/CentOS: WARNING: device write-protected, mounted read-only.</span><br><span class="line">[root@localhost ~]<span class="comment"># yum repolist </span></span><br><span class="line">repo id                                   repo name</span><br><span class="line">media-appstream                           CentOS Linux 8 - Media - AppStream</span><br><span class="line">media-baseos                              CentOS Linux 8 - Media - BaseOS</span><br></pre></td></tr></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;/assets/css/APlayer.min.css&quot;&gt;&lt;script src=&quot;/assets/js/APlayer.min.js&quot; cla</summary>
      
    
    
    
    <category term="Linux" scheme="https://www.hnswxx.cn/categories/Linux/"/>
    
    
    <category term="Centos8" scheme="https://www.hnswxx.cn/tags/Centos8/"/>
    
    <category term="YUM" scheme="https://www.hnswxx.cn/tags/YUM/"/>
    
  </entry>
  
  <entry>
    <title>Windows域迁移</title>
    <link href="https://www.hnswxx.cn/2021/11/21/domain-migration/"/>
    <id>https://www.hnswxx.cn/2021/11/21/domain-migration/</id>
    <published>2021-11-21T08:01:20.000Z</published>
    <updated>2021-11-21T09:39:02.096Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h3 id="环境介绍"><a href="#环境介绍" class="headerlink" title="环境介绍"></a>环境介绍</h3><table><thead><tr><th align="center">主机名</th><th align="center">IP</th><th align="center">角色</th></tr></thead><tbody><tr><td align="center">dc.skills.com</td><td align="center">10.10.70.101/24</td><td align="center">域控制器</td></tr><tr><td align="center">client1.skills.com</td><td align="center">10.10.70.102/24</td><td align="center">辅域控制器</td></tr></tbody></table><p><a href="https://imgtu.com/i/IjtU6x"><img src="https://z3.ax1x.com/2021/11/21/IjtU6x.md.png" alt="IjtU6x.md.png"></a></p><p><a href="https://imgtu.com/i/Ijt8k4"><img src="https://z3.ax1x.com/2021/11/21/Ijt8k4.png" alt="Ijt8k4.png"></a></p><h3 id="操作步骤-命令版"><a href="#操作步骤-命令版" class="headerlink" title="操作步骤(命令版)"></a>操作步骤(命令版)</h3><blockquote><p>步骤详解</p></blockquote><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\Users\Administrator&gt; ntdsutil.exe</span><br><span class="line">C:\Windows\system32\ntdsutil.exe: ?</span><br><span class="line"></span><br><span class="line"> ?                             - 显示这个帮助信息</span><br><span class="line"> Activate Instance %s          - 设置“NTDS”或特定的 AD LDS 实例</span><br><span class="line">                                作为活动实例。</span><br><span class="line"> Authoritative restore         - 授权还原 DIT 数据库</span><br><span class="line"> Change Service Account %s1 %s2 - 将 AD DS/LDS 服务帐户更改为</span><br><span class="line">                                 用户名为 %s1，密码为 %s2。</span><br><span class="line">                                 使用“NULL”表示空密码，* 表示</span><br><span class="line">                                 从控制台输入密码。</span><br><span class="line"> Configurable Settings         - 管理可配置的设置</span><br><span class="line"> DS Behavior                   - 查看和修改 AD DS/LDS 行为</span><br><span class="line"> Files                         - 管理 AD DS/LDS 数据库文件</span><br><span class="line"> <span class="built_in">Group</span> Membership Evaluation   - 评估给定用户或</span><br><span class="line">                                组的令牌中的 SID。</span><br><span class="line"> Help                          - 显示这个帮助信息</span><br><span class="line"> IFM                           - IFM 媒体创建</span><br><span class="line"> LDAP policies                 - 管理 LDAP 协议策略</span><br><span class="line"> LDAP Port %d                  - 为 AD LDS 实例配置 LDAP 端口。</span><br><span class="line"> List Instances                - 列出该计算机上安装的</span><br><span class="line">                                所有 AD LDS 实例。</span><br><span class="line"> Local Roles                   - 本地 RODC 角色管理</span><br><span class="line"> Metadata cleanup              - 清理不使用的服务器的对象</span><br><span class="line"> Partition management          - 管理目录分区</span><br><span class="line"> Popups off                    - 禁用弹出</span><br><span class="line"> Popups on                     - 启用弹出</span><br><span class="line"> Quit                          - 退出实用工具</span><br><span class="line"> Roles                         - 管理 NTDS 角色所有者令牌</span><br><span class="line"> Security account management   - 管理安全帐户数据库 - 复制</span><br><span class="line">                                 SID 清理</span><br><span class="line"> Semantic database analysis    - 语法检查器</span><br><span class="line"> <span class="built_in">Set</span> DSRM Password             - 重置目录服务还原模式</span><br><span class="line">                                Administrator</span><br><span class="line">帐户密码</span><br><span class="line"></span><br><span class="line"> Snapshot                      - 快照管理</span><br><span class="line"> SSL Port %d                   - 为 AD LDS 实例配置 SSL 端口。</span><br><span class="line"></span><br><span class="line">C:\Windows\system32\ntdsutil.exe: roles</span><br><span class="line">fsmo maintenance: ?</span><br><span class="line"></span><br><span class="line"> ?                             - 显示这个帮助信息</span><br><span class="line"> Connections                   - 连接到一个特定 AD DC/LDS 实例</span><br><span class="line"> Help                          - 显示这个帮助信息</span><br><span class="line"> Quit                          - 返回到上一个菜单</span><br><span class="line"> Seize infrastructure master   - 在已连接的服务器上覆盖结构角色</span><br><span class="line"> Seize naming master           - 覆盖已连接的服务器上的命名主机角色</span><br><span class="line"> Seize PDC                     - 在已连接的服务器上覆盖 PDC 角色</span><br><span class="line"> Seize RID master              - 在已连接的服务器上覆盖 RID 角色</span><br><span class="line"> Seize schema master           - 在已连接的服务器上覆盖架构角色</span><br><span class="line"> <span class="built_in">Select</span> operation target       - 选择的站点，服务器，域，角色和命名上下文</span><br><span class="line"> Transfer infrastructure master - 将已连接的服务器定为结构主机</span><br><span class="line"> Transfer naming master        - 使已连接的服务器成为命名主机</span><br><span class="line"> Transfer PDC                  - 将已连接的服务器定为 PDC</span><br><span class="line"> Transfer RID master           - 将已连接的服务器定为 RID 主机</span><br><span class="line"> Transfer schema master        - 将已连接的服务器定为架构主机</span><br><span class="line"></span><br><span class="line">fsmo maintenance: Connections</span><br><span class="line">server connections: ?</span><br><span class="line"></span><br><span class="line"> ?                             - 显示这个帮助信息</span><br><span class="line"> <span class="built_in">Clear</span> creds                   - 清除以前的连接凭据</span><br><span class="line"> Connect to domain %s          - 连接到 DNS 域名称</span><br><span class="line"> Connect to server %s          - 连接到服务器、DNS 名称[:端口号]</span><br><span class="line"> Help                          - 显示这个帮助信息</span><br><span class="line"> Info                          - 显示连接信息</span><br><span class="line"> Quit                          - 返回到上一个菜单</span><br><span class="line"> <span class="built_in">Set</span> creds %s1 %s2 %s3         - 将连接凭据设置为域 %s1、用户 %s2、密码 %s3。</span><br><span class="line">                                空密码使用<span class="string">&quot;NULL&quot;</span>,</span><br><span class="line">                                从控制台输入密码使用 *。</span><br><span class="line"></span><br><span class="line">server connections: Connect to server client1.skills.com</span><br><span class="line">绑定到 client1.skills.com ...</span><br><span class="line">用本登录的用户的凭证连接 client1.skills.com。</span><br><span class="line">server connections: quit</span><br><span class="line">fsmo maintenance: ?</span><br><span class="line"></span><br><span class="line"> ?                             - 显示这个帮助信息</span><br><span class="line"> Connections                   - 连接到一个特定 AD DC/LDS 实例</span><br><span class="line"> Help                          - 显示这个帮助信息</span><br><span class="line"> Quit                          - 返回到上一个菜单</span><br><span class="line"> Seize infrastructure master   - 在已连接的服务器上覆盖结构角色</span><br><span class="line"> Seize naming master           - 覆盖已连接的服务器上的命名主机角色</span><br><span class="line"> Seize PDC                     - 在已连接的服务器上覆盖 PDC 角色</span><br><span class="line"> Seize RID master              - 在已连接的服务器上覆盖 RID 角色</span><br><span class="line"> Seize schema master           - 在已连接的服务器上覆盖架构角色</span><br><span class="line"> <span class="built_in">Select</span> operation target       - 选择的站点，服务器，域，角色和命名上下文</span><br><span class="line"> Transfer infrastructure master - 将已连接的服务器定为结构主机</span><br><span class="line"> Transfer naming master        - 使已连接的服务器成为命名主机</span><br><span class="line"> Transfer PDC                  - 将已连接的服务器定为 PDC</span><br><span class="line"> Transfer RID master           - 将已连接的服务器定为 RID 主机</span><br><span class="line"> Transfer schema master        - 将已连接的服务器定为架构主机</span><br><span class="line"></span><br><span class="line">fsmo maintenance: Transfer infrastructure master</span><br><span class="line">服务器 <span class="string">&quot;client1.skills.com&quot;</span> 知道有关 <span class="number">5</span> 作用</span><br><span class="line">架构 - CN=NTDS Settings,CN=DC,CN=Servers,CN=Default<span class="literal">-First</span><span class="literal">-Site</span><span class="literal">-Name</span>,CN=Sites,CN=Configuration,DC=skills,DC=com</span><br><span class="line">命名主机 - CN=NTDS Settings,CN=DC,CN=Servers,CN=Default<span class="literal">-First</span><span class="literal">-Site</span><span class="literal">-Name</span>,CN=Sites,CN=Configuration,DC=skills,DC=com</span><br><span class="line">PDC - CN=NTDS Settings,CN=DC,CN=Servers,CN=Default<span class="literal">-First</span><span class="literal">-Site</span><span class="literal">-Name</span>,CN=Sites,CN=Configuration,DC=skills,DC=com</span><br><span class="line">RID - CN=NTDS Settings,CN=DC,CN=Servers,CN=Default<span class="literal">-First</span><span class="literal">-Site</span><span class="literal">-Name</span>,CN=Sites,CN=Configuration,DC=skills,DC=com</span><br><span class="line">结构 - CN=NTDS Settings,CN=CLIENT1,CN=Servers,CN=Default<span class="literal">-First</span><span class="literal">-Site</span><span class="literal">-Name</span>,CN=Sites,CN=Configuration,DC=skills,DC=com</span><br><span class="line">fsmo maintenance: Transfer naming master</span><br><span class="line">服务器 <span class="string">&quot;client1.skills.com&quot;</span> 知道有关 <span class="number">5</span> 作用</span><br><span class="line">架构 - CN=NTDS Settings,CN=DC,CN=Servers,CN=Default<span class="literal">-First</span><span class="literal">-Site</span><span class="literal">-Name</span>,CN=Sites,CN=Configuration,DC=skills,DC=com</span><br><span class="line">命名主机 - CN=NTDS Settings,CN=CLIENT1,CN=Servers,CN=Default<span class="literal">-First</span><span class="literal">-Site</span><span class="literal">-Name</span>,CN=Sites,CN=Configuration,DC=skills,DC=com</span><br><span class="line">PDC - CN=NTDS Settings,CN=DC,CN=Servers,CN=Default<span class="literal">-First</span><span class="literal">-Site</span><span class="literal">-Name</span>,CN=Sites,CN=Configuration,DC=skills,DC=com</span><br><span class="line">RID - CN=NTDS Settings,CN=DC,CN=Servers,CN=Default<span class="literal">-First</span><span class="literal">-Site</span><span class="literal">-Name</span>,CN=Sites,CN=Configuration,DC=skills,DC=com</span><br><span class="line">结构 - CN=NTDS Settings,CN=CLIENT1,CN=Servers,CN=Default<span class="literal">-First</span><span class="literal">-Site</span><span class="literal">-Name</span>,CN=Sites,CN=Configuration,DC=skills,DC=com</span><br><span class="line">fsmo maintenance: Transfer PDC</span><br><span class="line">服务器 <span class="string">&quot;client1.skills.com&quot;</span> 知道有关 <span class="number">5</span> 作用</span><br><span class="line">架构 - CN=NTDS Settings,CN=DC,CN=Servers,CN=Default<span class="literal">-First</span><span class="literal">-Site</span><span class="literal">-Name</span>,CN=Sites,CN=Configuration,DC=skills,DC=com</span><br><span class="line">命名主机 - CN=NTDS Settings,CN=CLIENT1,CN=Servers,CN=Default<span class="literal">-First</span><span class="literal">-Site</span><span class="literal">-Name</span>,CN=Sites,CN=Configuration,DC=skills,DC=com</span><br><span class="line">PDC - CN=NTDS Settings,CN=CLIENT1,CN=Servers,CN=Default<span class="literal">-First</span><span class="literal">-Site</span><span class="literal">-Name</span>,CN=Sites,CN=Configuration,DC=skills,DC=com</span><br><span class="line">RID - CN=NTDS Settings,CN=DC,CN=Servers,CN=Default<span class="literal">-First</span><span class="literal">-Site</span><span class="literal">-Name</span>,CN=Sites,CN=Configuration,DC=skills,DC=com</span><br><span class="line">结构 - CN=NTDS Settings,CN=CLIENT1,CN=Servers,CN=Default<span class="literal">-First</span><span class="literal">-Site</span><span class="literal">-Name</span>,CN=Sites,CN=Configuration,DC=skills,DC=com</span><br><span class="line">fsmo maintenance: Transfer RID master</span><br><span class="line">服务器 <span class="string">&quot;client1.skills.com&quot;</span> 知道有关 <span class="number">5</span> 作用</span><br><span class="line">架构 - CN=NTDS Settings,CN=DC,CN=Servers,CN=Default<span class="literal">-First</span><span class="literal">-Site</span><span class="literal">-Name</span>,CN=Sites,CN=Configuration,DC=skills,DC=com</span><br><span class="line">命名主机 - CN=NTDS Settings,CN=CLIENT1,CN=Servers,CN=Default<span class="literal">-First</span><span class="literal">-Site</span><span class="literal">-Name</span>,CN=Sites,CN=Configuration,DC=skills,DC=com</span><br><span class="line">PDC - CN=NTDS Settings,CN=CLIENT1,CN=Servers,CN=Default<span class="literal">-First</span><span class="literal">-Site</span><span class="literal">-Name</span>,CN=Sites,CN=Configuration,DC=skills,DC=com</span><br><span class="line">RID - CN=NTDS Settings,CN=CLIENT1,CN=Servers,CN=Default<span class="literal">-First</span><span class="literal">-Site</span><span class="literal">-Name</span>,CN=Sites,CN=Configuration,DC=skills,DC=com</span><br><span class="line">结构 - CN=NTDS Settings,CN=CLIENT1,CN=Servers,CN=Default<span class="literal">-First</span><span class="literal">-Site</span><span class="literal">-Name</span>,CN=Sites,CN=Configuration,DC=skills,DC=com</span><br><span class="line">fsmo maintenance:  Transfer schema master</span><br><span class="line">服务器 <span class="string">&quot;client1.skills.com&quot;</span> 知道有关 <span class="number">5</span> 作用</span><br><span class="line">架构 - CN=NTDS Settings,CN=CLIENT1,CN=Servers,CN=Default<span class="literal">-First</span><span class="literal">-Site</span><span class="literal">-Name</span>,CN=Sites,CN=Configuration,DC=skills,DC=com</span><br><span class="line">命名主机 - CN=NTDS Settings,CN=CLIENT1,CN=Servers,CN=Default<span class="literal">-First</span><span class="literal">-Site</span><span class="literal">-Name</span>,CN=Sites,CN=Configuration,DC=skills,DC=com</span><br><span class="line">PDC - CN=NTDS Settings,CN=CLIENT1,CN=Servers,CN=Default<span class="literal">-First</span><span class="literal">-Site</span><span class="literal">-Name</span>,CN=Sites,CN=Configuration,DC=skills,DC=com</span><br><span class="line">RID - CN=NTDS Settings,CN=CLIENT1,CN=Servers,CN=Default<span class="literal">-First</span><span class="literal">-Site</span><span class="literal">-Name</span>,CN=Sites,CN=Configuration,DC=skills,DC=com</span><br><span class="line">结构 - CN=NTDS Settings,CN=CLIENT1,CN=Servers,CN=Default<span class="literal">-First</span><span class="literal">-Site</span><span class="literal">-Name</span>,CN=Sites,CN=Configuration,DC=skills,DC=com</span><br><span class="line">fsmo maintenance: quit</span><br><span class="line">C:\Windows\system32\ntdsutil.exe: quit</span><br><span class="line"><span class="built_in">PS</span> C:\Users\Administrator&gt;</span><br></pre></td></tr></table></figure><blockquote><p>纯步骤</p></blockquote><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\Users\Administrator&gt; ntdsutil.exe</span><br><span class="line">C:\Windows\system32\ntdsutil.exe: roles</span><br><span class="line">fsmo maintenance: Connections</span><br><span class="line">server connections: Connect to server client1.skills.com</span><br><span class="line">绑定到 client1.skills.com ...</span><br><span class="line">用本登录的用户的凭证连接 client1.skills.com。</span><br><span class="line">server connections: quit</span><br><span class="line">fsmo maintenance: Transfer infrastructure master</span><br><span class="line">服务器 <span class="string">&quot;client1.skills.com&quot;</span> 知道有关 <span class="number">5</span> 作用</span><br><span class="line">架构 - CN=NTDS Settings,CN=DC,CN=Servers,CN=Default<span class="literal">-First</span><span class="literal">-Site</span><span class="literal">-Name</span>,CN=Sites,CN=Configuration,DC=skills,DC=com</span><br><span class="line">命名主机 - CN=NTDS Settings,CN=DC,CN=Servers,CN=Default<span class="literal">-First</span><span class="literal">-Site</span><span class="literal">-Name</span>,CN=Sites,CN=Configuration,DC=skills,DC=com</span><br><span class="line">PDC - CN=NTDS Settings,CN=DC,CN=Servers,CN=Default<span class="literal">-First</span><span class="literal">-Site</span><span class="literal">-Name</span>,CN=Sites,CN=Configuration,DC=skills,DC=com</span><br><span class="line">RID - CN=NTDS Settings,CN=DC,CN=Servers,CN=Default<span class="literal">-First</span><span class="literal">-Site</span><span class="literal">-Name</span>,CN=Sites,CN=Configuration,DC=skills,DC=com</span><br><span class="line">结构 - CN=NTDS Settings,CN=CLIENT1,CN=Servers,CN=Default<span class="literal">-First</span><span class="literal">-Site</span><span class="literal">-Name</span>,CN=Sites,CN=Configuration,DC=skills,DC=com</span><br><span class="line">fsmo maintenance: Transfer naming master</span><br><span class="line">服务器 <span class="string">&quot;client1.skills.com&quot;</span> 知道有关 <span class="number">5</span> 作用</span><br><span class="line">架构 - CN=NTDS Settings,CN=DC,CN=Servers,CN=Default<span class="literal">-First</span><span class="literal">-Site</span><span class="literal">-Name</span>,CN=Sites,CN=Configuration,DC=skills,DC=com</span><br><span class="line">命名主机 - CN=NTDS Settings,CN=CLIENT1,CN=Servers,CN=Default<span class="literal">-First</span><span class="literal">-Site</span><span class="literal">-Name</span>,CN=Sites,CN=Configuration,DC=skills,DC=com</span><br><span class="line">PDC - CN=NTDS Settings,CN=DC,CN=Servers,CN=Default<span class="literal">-First</span><span class="literal">-Site</span><span class="literal">-Name</span>,CN=Sites,CN=Configuration,DC=skills,DC=com</span><br><span class="line">RID - CN=NTDS Settings,CN=DC,CN=Servers,CN=Default<span class="literal">-First</span><span class="literal">-Site</span><span class="literal">-Name</span>,CN=Sites,CN=Configuration,DC=skills,DC=com</span><br><span class="line">结构 - CN=NTDS Settings,CN=CLIENT1,CN=Servers,CN=Default<span class="literal">-First</span><span class="literal">-Site</span><span class="literal">-Name</span>,CN=Sites,CN=Configuration,DC=skills,DC=com</span><br><span class="line">fsmo maintenance: Transfer PDC</span><br><span class="line">服务器 <span class="string">&quot;client1.skills.com&quot;</span> 知道有关 <span class="number">5</span> 作用</span><br><span class="line">架构 - CN=NTDS Settings,CN=DC,CN=Servers,CN=Default<span class="literal">-First</span><span class="literal">-Site</span><span class="literal">-Name</span>,CN=Sites,CN=Configuration,DC=skills,DC=com</span><br><span class="line">命名主机 - CN=NTDS Settings,CN=CLIENT1,CN=Servers,CN=Default<span class="literal">-First</span><span class="literal">-Site</span><span class="literal">-Name</span>,CN=Sites,CN=Configuration,DC=skills,DC=com</span><br><span class="line">PDC - CN=NTDS Settings,CN=CLIENT1,CN=Servers,CN=Default<span class="literal">-First</span><span class="literal">-Site</span><span class="literal">-Name</span>,CN=Sites,CN=Configuration,DC=skills,DC=com</span><br><span class="line">RID - CN=NTDS Settings,CN=DC,CN=Servers,CN=Default<span class="literal">-First</span><span class="literal">-Site</span><span class="literal">-Name</span>,CN=Sites,CN=Configuration,DC=skills,DC=com</span><br><span class="line">结构 - CN=NTDS Settings,CN=CLIENT1,CN=Servers,CN=Default<span class="literal">-First</span><span class="literal">-Site</span><span class="literal">-Name</span>,CN=Sites,CN=Configuration,DC=skills,DC=com</span><br><span class="line">fsmo maintenance: Transfer RID master</span><br><span class="line">服务器 <span class="string">&quot;client1.skills.com&quot;</span> 知道有关 <span class="number">5</span> 作用</span><br><span class="line">架构 - CN=NTDS Settings,CN=DC,CN=Servers,CN=Default<span class="literal">-First</span><span class="literal">-Site</span><span class="literal">-Name</span>,CN=Sites,CN=Configuration,DC=skills,DC=com</span><br><span class="line">命名主机 - CN=NTDS Settings,CN=CLIENT1,CN=Servers,CN=Default<span class="literal">-First</span><span class="literal">-Site</span><span class="literal">-Name</span>,CN=Sites,CN=Configuration,DC=skills,DC=com</span><br><span class="line">PDC - CN=NTDS Settings,CN=CLIENT1,CN=Servers,CN=Default<span class="literal">-First</span><span class="literal">-Site</span><span class="literal">-Name</span>,CN=Sites,CN=Configuration,DC=skills,DC=com</span><br><span class="line">RID - CN=NTDS Settings,CN=CLIENT1,CN=Servers,CN=Default<span class="literal">-First</span><span class="literal">-Site</span><span class="literal">-Name</span>,CN=Sites,CN=Configuration,DC=skills,DC=com</span><br><span class="line">结构 - CN=NTDS Settings,CN=CLIENT1,CN=Servers,CN=Default<span class="literal">-First</span><span class="literal">-Site</span><span class="literal">-Name</span>,CN=Sites,CN=Configuration,DC=skills,DC=com</span><br><span class="line">fsmo maintenance:  Transfer schema master</span><br><span class="line">服务器 <span class="string">&quot;client1.skills.com&quot;</span> 知道有关 <span class="number">5</span> 作用</span><br><span class="line">架构 - CN=NTDS Settings,CN=CLIENT1,CN=Servers,CN=Default<span class="literal">-First</span><span class="literal">-Site</span><span class="literal">-Name</span>,CN=Sites,CN=Configuration,DC=skills,DC=com</span><br><span class="line">命名主机 - CN=NTDS Settings,CN=CLIENT1,CN=Servers,CN=Default<span class="literal">-First</span><span class="literal">-Site</span><span class="literal">-Name</span>,CN=Sites,CN=Configuration,DC=skills,DC=com</span><br><span class="line">PDC - CN=NTDS Settings,CN=CLIENT1,CN=Servers,CN=Default<span class="literal">-First</span><span class="literal">-Site</span><span class="literal">-Name</span>,CN=Sites,CN=Configuration,DC=skills,DC=com</span><br><span class="line">RID - CN=NTDS Settings,CN=CLIENT1,CN=Servers,CN=Default<span class="literal">-First</span><span class="literal">-Site</span><span class="literal">-Name</span>,CN=Sites,CN=Configuration,DC=skills,DC=com</span><br><span class="line">结构 - CN=NTDS Settings,CN=CLIENT1,CN=Servers,CN=Default<span class="literal">-First</span><span class="literal">-Site</span><span class="literal">-Name</span>,CN=Sites,CN=Configuration,DC=skills,DC=com</span><br><span class="line">fsmo maintenance: quit</span><br><span class="line">C:\Windows\system32\ntdsutil.exe: quit</span><br><span class="line"><span class="built_in">PS</span> C:\Users\Administrator&gt;</span><br></pre></td></tr></table></figure><h3 id="结果输出"><a href="#结果输出" class="headerlink" title="结果输出"></a>结果输出</h3><blockquote><p>dc.skills.com</p></blockquote><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\Users\Administrator&gt; systeminfo</span><br><span class="line"></span><br><span class="line">主机名:           DC</span><br><span class="line">OS 名称:          Microsoft Windows Server <span class="number">2019</span> Datacenter</span><br><span class="line">OS 版本:          <span class="number">10.0</span>.<span class="number">17763</span> 暂缺 Build <span class="number">17763</span></span><br><span class="line">OS 制造商:        Microsoft Corporation</span><br><span class="line">OS 配置:          额外/备份域控制器</span><br><span class="line">OS 构件类型:      Multiprocessor Free</span><br><span class="line">注册的所有人:     Windows 用户</span><br><span class="line">注册的组织:</span><br><span class="line">产品 ID:          <span class="number">00430</span><span class="literal">-70000</span><span class="literal">-00001</span><span class="literal">-AA289</span></span><br><span class="line">初始安装日期:     <span class="number">2021</span>/<span class="number">11</span>/<span class="number">21</span>, <span class="number">16</span>:<span class="number">55</span>:<span class="number">22</span></span><br><span class="line">系统启动时间:     <span class="number">2021</span>/<span class="number">11</span>/<span class="number">21</span>, <span class="number">17</span>:<span class="number">00</span>:<span class="number">11</span></span><br><span class="line">系统制造商:       VMware, Inc.</span><br><span class="line">系统型号:         VMware7,<span class="number">1</span></span><br><span class="line">系统类型:         x64<span class="literal">-based</span> PC</span><br><span class="line">处理器:           安装了 <span class="number">2</span> 个处理器。</span><br><span class="line">                  [<span class="number">01</span>]: Intel64 Family <span class="number">6</span> Model <span class="number">158</span> Stepping <span class="number">9</span> GenuineIntel ~<span class="number">3600</span> Mhz</span><br><span class="line">                  [<span class="number">02</span>]: Intel64 Family <span class="number">6</span> Model <span class="number">158</span> Stepping <span class="number">9</span> GenuineIntel ~<span class="number">3600</span> Mhz</span><br><span class="line">BIOS 版本:        VMware, Inc. VMW71.<span class="number">00</span>V.<span class="number">16722896</span>.B64.<span class="number">2008100651</span>, <span class="number">2020</span>/<span class="number">8</span>/<span class="number">10</span></span><br><span class="line">Windows 目录:     C:\Windows</span><br><span class="line">系统目录:         C:\Windows\system32</span><br><span class="line">启动设备:         \Device\HarddiskVolume2</span><br><span class="line">系统区域设置:     zh<span class="literal">-cn</span>;中文(中国)</span><br><span class="line">输入法区域设置:   zh<span class="literal">-cn</span>;中文(中国)</span><br><span class="line">时区:             (UTC+<span class="number">08</span>:<span class="number">00</span>) 北京，重庆，香港特别行政区，乌鲁木齐</span><br><span class="line">物理内存总量:     <span class="number">2</span>,<span class="number">047</span> MB</span><br><span class="line">可用的物理内存:   <span class="number">625</span> MB</span><br><span class="line">虚拟内存: 最大值: <span class="number">3</span>,<span class="number">199</span> MB</span><br><span class="line">虚拟内存: 可用:   <span class="number">1</span>,<span class="number">648</span> MB</span><br><span class="line">虚拟内存: 使用中: <span class="number">1</span>,<span class="number">551</span> MB</span><br><span class="line">页面文件位置:     C:\pagefile.sys</span><br><span class="line">域:               skills.com</span><br><span class="line">登录服务器:       \\DC</span><br><span class="line">修补程序:         安装了 <span class="number">1</span> 个修补程序。</span><br><span class="line">                  [<span class="number">01</span>]: KB4464455</span><br><span class="line">网卡:             安装了 <span class="number">1</span> 个 NIC。</span><br><span class="line">                  [<span class="number">01</span>]: Intel(<span class="built_in">R</span>) <span class="number">82574</span>L Gigabit Network Connection</span><br><span class="line">                      连接名:      Ethernet0</span><br><span class="line">                      启用 DHCP:   否</span><br><span class="line">                      IP 地址</span><br><span class="line">                        [<span class="number">01</span>]: <span class="number">10.10</span>.<span class="number">70.101</span></span><br><span class="line">                        [<span class="number">02</span>]: fe80::<span class="number">2145</span>:f5f:fdae:de21</span><br><span class="line">Hyper<span class="literal">-V</span> 要求:     已检测到虚拟机监控程序。将不显示 Hyper<span class="literal">-V</span> 所需的功能。</span><br><span class="line"><span class="built_in">PS</span> C:\Users\Administrator&gt;</span><br></pre></td></tr></table></figure><blockquote><p>client1.skills.com</p></blockquote><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\Users\Administrator.SKILLS&gt; systeminfo</span><br><span class="line"></span><br><span class="line">主机名:           CLIENT1</span><br><span class="line">OS 名称:          Microsoft Windows Server <span class="number">2019</span> Datacenter</span><br><span class="line">OS 版本:          <span class="number">10.0</span>.<span class="number">17763</span> 暂缺 Build <span class="number">17763</span></span><br><span class="line">OS 制造商:        Microsoft Corporation</span><br><span class="line">OS 配置:          主域控制器</span><br><span class="line">OS 构件类型:      Multiprocessor Free</span><br><span class="line">注册的所有人:     Windows 用户</span><br><span class="line">注册的组织:</span><br><span class="line">产品 ID:          <span class="number">00430</span><span class="literal">-70000</span><span class="literal">-00001</span><span class="literal">-AA289</span></span><br><span class="line">初始安装日期:     <span class="number">2021</span>/<span class="number">11</span>/<span class="number">21</span>, <span class="number">16</span>:<span class="number">48</span>:<span class="number">57</span></span><br><span class="line">系统启动时间:     <span class="number">2021</span>/<span class="number">11</span>/<span class="number">21</span>, <span class="number">17</span>:<span class="number">05</span>:<span class="number">28</span></span><br><span class="line">系统制造商:       VMware, Inc.</span><br><span class="line">系统型号:         VMware7,<span class="number">1</span></span><br><span class="line">系统类型:         x64<span class="literal">-based</span> PC</span><br><span class="line">处理器:           安装了 <span class="number">2</span> 个处理器。</span><br><span class="line">                  [<span class="number">01</span>]: Intel64 Family <span class="number">6</span> Model <span class="number">158</span> Stepping <span class="number">9</span> GenuineIntel ~<span class="number">3600</span> Mhz</span><br><span class="line">                  [<span class="number">02</span>]: Intel64 Family <span class="number">6</span> Model <span class="number">158</span> Stepping <span class="number">9</span> GenuineIntel ~<span class="number">3600</span> Mhz</span><br><span class="line">BIOS 版本:        VMware, Inc. VMW71.<span class="number">00</span>V.<span class="number">16722896</span>.B64.<span class="number">2008100651</span>, <span class="number">2020</span>/<span class="number">8</span>/<span class="number">10</span></span><br><span class="line">Windows 目录:     C:\Windows</span><br><span class="line">系统目录:         C:\Windows\system32</span><br><span class="line">启动设备:         \Device\HarddiskVolume2</span><br><span class="line">系统区域设置:     zh<span class="literal">-cn</span>;中文(中国)</span><br><span class="line">输入法区域设置:   zh<span class="literal">-cn</span>;中文(中国)</span><br><span class="line">时区:             (UTC+<span class="number">08</span>:<span class="number">00</span>) 北京，重庆，香港特别行政区，乌鲁木齐</span><br><span class="line">物理内存总量:     <span class="number">2</span>,<span class="number">047</span> MB</span><br><span class="line">可用的物理内存:   <span class="number">591</span> MB</span><br><span class="line">虚拟内存: 最大值: <span class="number">3</span>,<span class="number">199</span> MB</span><br><span class="line">虚拟内存: 可用:   <span class="number">1</span>,<span class="number">586</span> MB</span><br><span class="line">虚拟内存: 使用中: <span class="number">1</span>,<span class="number">613</span> MB</span><br><span class="line">页面文件位置:     C:\pagefile.sys</span><br><span class="line">域:               skills.com</span><br><span class="line">登录服务器:       \\CLIENT1</span><br><span class="line">修补程序:         安装了 <span class="number">1</span> 个修补程序。</span><br><span class="line">                  [<span class="number">01</span>]: KB4464455</span><br><span class="line">网卡:             安装了 <span class="number">1</span> 个 NIC。</span><br><span class="line">                  [<span class="number">01</span>]: Intel(<span class="built_in">R</span>) <span class="number">82574</span>L Gigabit Network Connection</span><br><span class="line">                      连接名:      Ethernet0</span><br><span class="line">                      启用 DHCP:   否</span><br><span class="line">                      IP 地址</span><br><span class="line">                        [<span class="number">01</span>]: <span class="number">10.10</span>.<span class="number">70.102</span></span><br><span class="line">                        [<span class="number">02</span>]: fe80::b036:<span class="number">15</span>a0:<span class="number">51</span>db:a236</span><br><span class="line">Hyper<span class="literal">-V</span> 要求:     已检测到虚拟机监控程序。将不显示 Hyper<span class="literal">-V</span> 所需的功能。</span><br><span class="line"><span class="built_in">PS</span> C:\Users\Administrator.SKILLS&gt;</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;/assets/css/APlayer.min.css&quot;&gt;&lt;script src=&quot;/assets/js/APlayer.min.js&quot; cla</summary>
      
    
    
    
    <category term="Windows" scheme="https://www.hnswxx.cn/categories/Windows/"/>
    
    
    <category term="WindowServer2019" scheme="https://www.hnswxx.cn/tags/WindowServer2019/"/>
    
  </entry>
  
  <entry>
    <title>Kerberos与NFS联动</title>
    <link href="https://www.hnswxx.cn/2021/11/19/kdc-nfs-linkage/"/>
    <id>https://www.hnswxx.cn/2021/11/19/kdc-nfs-linkage/</id>
    <published>2021-11-19T03:19:39.000Z</published>
    <updated>2021-11-22T02:04:00.004Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h3 id="Kerberos单点登录"><a href="#Kerberos单点登录" class="headerlink" title="Kerberos单点登录"></a>Kerberos单点登录</h3><p>原理图</p><p><a href="https://imgtu.com/i/IHSCo8"><img src="https://z3.ax1x.com/2021/11/19/IHSCo8.png" alt="IHSCo8.png"></a></p><blockquote><p>Kerberos提供了一个集中式的认证服务器结构，认证服务器的功能式实现用户与其访问的服务器间的相互鉴别。（采用的是对称密钥加密技术）</p></blockquote><ul><li><p>AS：认证服务器AS（authenticator server）</p></li><li><p>TGS：票据许可服务器TGS（ticket granting server）</p></li><li><p>Client：客户端</p></li><li><p>Server：服务器</p></li></ul><h4 id="Kerberos凭证"><a href="#Kerberos凭证" class="headerlink" title="Kerberos凭证"></a>Kerberos凭证</h4><h5 id="票据（ticket）："><a href="#票据（ticket）：" class="headerlink" title="票据（ticket）："></a>票据（ticket）：</h5><p>ticket用来安全的在认证服务器和用户请求的服务器之间传递用户的身份，同时也传递附加信息。用来保证使用ticket的用户必须是ticket中指定用户。ticket一旦生产，在生存时间指定的时间内可以被client多次使用，并申请同一个server服务。</p><h5 id="鉴别码（authenticator）："><a href="#鉴别码（authenticator）：" class="headerlink" title="鉴别码（authenticator）："></a>鉴别码（authenticator）：</h5><p>提供信息与ticket中的信息进行比较，一起保证发出ticket的用户信息就是ticket中指定的用户。authenticator只能在一次服务请求中使用，每当client向server申请服务时，必须重新生成authenticator</p><h4 id="Kerberos票据："><a href="#Kerberos票据：" class="headerlink" title="Kerberos票据："></a>Kerberos票据：</h4><p>两种票据：</p><h5 id="服务许可票据（server-granting-ticket）："><a href="#服务许可票据（server-granting-ticket）：" class="headerlink" title="服务许可票据（server granting ticket）："></a>服务许可票据（server granting ticket）：</h5><p> 是客户端请求服务时需要提供的票据</p><p> 用ticket-A表示访问应用服务器X的票据，通过TGS发放</p><h5 id="票据许可票据（ticket-granting-ticket）："><a href="#票据许可票据（ticket-granting-ticket）：" class="headerlink" title="票据许可票据（ticket granting ticket）："></a>票据许可票据（ticket granting ticket）：</h5><p> 客户端访问TGS服务器需要提供的票据，目的是为了申请某一个应用服务器（如nfs，ftp，nis，pcs等）的“服务许可票据”</p><p> 票据由AS发放 用ticket-B表示访问TGS服务器票据 ticket-B在用户登录时向AS申请一次，可以多次重复使用</p><h4 id="Kerberos域（realm）"><a href="#Kerberos域（realm）" class="headerlink" title="Kerberos域（realm）"></a>Kerberos域（realm）</h4><p>构成：一个完整的Kerberos环境包含一个Kerberos服务器，一组工作站和一组应用服务器</p><p>Kerberos服务器数据库中拥有所有参与用户的UID和口令列表</p><p>Kerberos服务器必须与每一个服务器之间共享一个保密密钥（keytab文件）</p><p>所有用户均在Kerberos服务器上注册</p><p>所有服务器均在Kerberos服务器上注册</p><p>领域划分是根据网络的管理边界来划分（网段）</p><h4 id="服务端配置"><a href="#服务端配置" class="headerlink" title="服务端配置"></a>服务端配置</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#安装时间同步 kdc服务端 nfs服务端 </span></span><br><span class="line">yum install krb5-server krb5-libs nfs-utils -y</span><br><span class="line"><span class="comment">#设置hosts</span></span><br><span class="line">10.10.70.101 kdc.skills.com</span><br><span class="line">10.10.70.102 client.skills.com</span><br><span class="line"></span><br><span class="line"><span class="comment">#修改kdc配置文件</span></span><br><span class="line"><span class="comment">#/etc/krb5.conf</span></span><br><span class="line"><span class="comment"># To opt out of the system crypto-policies configuration of krb5, remove the</span></span><br><span class="line"><span class="comment"># symlink at /etc/krb5.conf.d/crypto-policies which will not be recreated.</span></span><br><span class="line">includedir /etc/krb5.conf.d/</span><br><span class="line"></span><br><span class="line">[logging]</span><br><span class="line">    default = FILE:/var/<span class="built_in">log</span>/krb5libs.log</span><br><span class="line">    kdc = FILE:/var/<span class="built_in">log</span>/krb5kdc.log</span><br><span class="line">    admin_server = FILE:/var/<span class="built_in">log</span>/kadmind.log</span><br><span class="line"></span><br><span class="line">[libdefaults]</span><br><span class="line">    dns_lookup_realm = <span class="literal">false</span></span><br><span class="line">    ticket_lifetime = 24h</span><br><span class="line">    renew_lifetime = 7d</span><br><span class="line">    forwardable = <span class="literal">true</span></span><br><span class="line">    rdns = <span class="literal">false</span></span><br><span class="line">    default_realm = SKILLS.COM</span><br><span class="line"></span><br><span class="line">[realms]</span><br><span class="line"> SKILLS.COM = &#123;</span><br><span class="line">     kdc = kdc.skills.com</span><br><span class="line">     admin_server = kdc.skills.com</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">[domain_realm]</span><br><span class="line"> .skills.com = SKILLS.COM</span><br><span class="line"> skills.com = SKILLS.COM</span><br><span class="line"></span><br><span class="line"><span class="comment">#/var/kerberos/krb5kdc</span></span><br><span class="line"><span class="comment"># kadm5.acl</span></span><br><span class="line">*/admin@SKILLS.COM      *</span><br><span class="line"><span class="comment"># kdc.conf</span></span><br><span class="line">[kdcdefaults]</span><br><span class="line">    kdc_ports = 88</span><br><span class="line">    kdc_tcp_ports = 88</span><br><span class="line">    spake_preauth_kdc_challenge = edwards25519</span><br><span class="line"></span><br><span class="line">[realms]</span><br><span class="line">SKILLS.COM = &#123;</span><br><span class="line">     <span class="comment">#master_key_type = aes256-cts</span></span><br><span class="line">     acl_file = /var/kerberos/krb5kdc/kadm5.acl</span><br><span class="line">     dict_file = /usr/share/dict/words</span><br><span class="line">     admin_keytab = /var/kerberos/krb5kdc/kadm5.keytab</span><br><span class="line">     supported_enctypes = aes256-cts:normal aes128-cts:normal arcfour-hmac:normal camellia256-cts:normal camellia128-cts:normal</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#初始化kdc数据库</span></span><br><span class="line">kdb5_util create -s</span><br><span class="line"></span><br><span class="line"><span class="comment">#进入kdc数据库</span></span><br><span class="line">kadmin.local </span><br><span class="line">Authenticating as principal nfs/admin@SKILLS.COM with password.</span><br><span class="line"><span class="comment">#创建kdc本机凭据</span></span><br><span class="line">kadmin.local:  addprinc -randkey nfs/kdc.skills.com</span><br><span class="line"><span class="comment">#创建客户端凭据</span></span><br><span class="line">kadmin.local:  addprinc -randkey nfs/client.skills.com</span><br><span class="line"><span class="comment">#导出凭据</span></span><br><span class="line"><span class="comment">#第一个直导出到本地</span></span><br><span class="line">ktadd -kt /etc/krb5.keytab nfs/kdc.skills.com</span><br><span class="line"><span class="comment">#第二个先导出到本地tmp下，再导出到另一台服务器</span></span><br><span class="line">ktadd -kt /tmp/client nfs/client.skills.com</span><br><span class="line"><span class="comment">#把客户端凭据传给客户端</span></span><br><span class="line">scp /tmp/client client.skills.com:/etc/krb5.keytab</span><br><span class="line"><span class="comment">#把kdc主配置文件传送给客户端</span></span><br><span class="line">scp /etc/krb5.conf client.skills.com:/etc/krb5.conf</span><br><span class="line"></span><br><span class="line"><span class="comment">#配置nfs /etc/exports</span></span><br><span class="line">/mnt *(rw,sec=krb5p)</span><br><span class="line"></span><br><span class="line"><span class="comment">#修改hosts文件</span></span><br><span class="line">127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4</span><br><span class="line">::1         localhost localhost.localdomain localhost6 localhost6.localdomain6</span><br><span class="line">10.10.70.101 kdc.skills.com</span><br><span class="line">10.10.70.102 client.skills.com</span><br><span class="line"></span><br><span class="line"><span class="comment">#把hosts穿给客户端服务器</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#把 kadmin.service krb5kdc.service nfs-server.service 服务启动</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#安装凭据</span></span><br><span class="line">kinit -kt /etc/krb5.keytab </span><br></pre></td></tr></table></figure><h4 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#配置/etc/chrony.conf</span></span><br><span class="line">server 10.10.70.101 iburst</span><br><span class="line"></span><br><span class="line"><span class="comment">#安装kdc工作站 nfs </span></span><br><span class="line">yum install krb5-workstation.x86_64  krb5-libs nfs-utils -y</span><br><span class="line"></span><br><span class="line"><span class="comment">#安装凭据</span></span><br><span class="line">kinit -kt /etc/krb5.keytab </span><br><span class="line"></span><br><span class="line"><span class="comment">#挂载</span></span><br><span class="line">mount kdc.skills.com:/mnt /mnt</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看挂载</span></span><br><span class="line">mount | grep krb5p</span><br><span class="line">kdc.skills.com:/mnt on /mnt <span class="built_in">type</span> nfs4 (rw,relatime,vers=4.2,rsize=131072,wsize=131072,namlen=255,hard,proto=tcp,timeo=600,retrans=2,sec=krb5p,clientaddr=10.10.70.102,local_lock=none,addr=10.10.70.101)</span><br></pre></td></tr></table></figure><blockquote><p>kerberos nfs 挂载不上的原因有</p></blockquote><ol><li><p>使用IP和域名简写挂载</p><p>例如主机名为 client1.skills.com ip地址为 10.10.70.102 的实例，挂载时用的是client1或是 10.10.70.102 进行挂载，结果导致挂载失败，没有用主机的完全域名就无法进行挂载。</p></li></ol>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;/assets/css/APlayer.min.css&quot;&gt;&lt;script src=&quot;/assets/js/APlayer.min.js&quot; cla</summary>
      
    
    
    
    <category term="Linux" scheme="https://www.hnswxx.cn/categories/Linux/"/>
    
    
    <category term="Centos8" scheme="https://www.hnswxx.cn/tags/Centos8/"/>
    
    <category term="Kerberos" scheme="https://www.hnswxx.cn/tags/Kerberos/"/>
    
    <category term="NFS" scheme="https://www.hnswxx.cn/tags/NFS/"/>
    
  </entry>
  
  <entry>
    <title>Windows Server 2019偏门性问题</title>
    <link href="https://www.hnswxx.cn/2021/11/18/problems-of-windows-server/"/>
    <id>https://www.hnswxx.cn/2021/11/18/problems-of-windows-server/</id>
    <published>2021-11-18T12:49:10.000Z</published>
    <updated>2021-11-23T08:17:01.804Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote><p>本章主要解决window server 2019的各种偏门问题</p></blockquote><h3 id="DNS"><a href="#DNS" class="headerlink" title="DNS"></a>DNS</h3><h4 id="关闭网络掩码排序功能"><a href="#关闭网络掩码排序功能" class="headerlink" title="关闭网络掩码排序功能"></a>关闭网络掩码排序功能</h4><p><a href="https://imgtu.com/i/ITqMrD"><img src="https://z3.ax1x.com/2021/11/18/ITqMrD.png" alt="ITqMrD.png"></a></p><h4 id="要求动态更新设置为非安全"><a href="#要求动态更新设置为非安全" class="headerlink" title="要求动态更新设置为非安全"></a>要求动态更新设置为非安全</h4><p><a href="https://imgtu.com/i/ITqbz6"><img src="https://z3.ax1x.com/2021/11/18/ITqbz6.md.png" alt="ITqbz6.md.png"></a></p><h3 id="证书"><a href="#证书" class="headerlink" title="证书"></a>证书</h3><h4 id="颁发的证书有效期修改"><a href="#颁发的证书有效期修改" class="headerlink" title="颁发的证书有效期修改"></a>颁发的证书有效期修改</h4><blockquote><p>环境介绍：CA证书有效期20年，CA颁发证书有效期10年</p></blockquote><p><a href="https://imgtu.com/i/IjXnot"><img src="https://z3.ax1x.com/2021/11/21/IjXnot.png" alt="IjXnot.png"></a></p><ol><li><strong>修改注册表</strong></li></ol><p><a href="https://imgtu.com/i/IjXGLj"><img src="https://z3.ax1x.com/2021/11/21/IjXGLj.png" alt="IjXGLj.png"></a></p><ol start="2"><li><strong>修改默认的web服务器证书</strong></li></ol><p><a href="https://imgtu.com/i/IjxDl8"><img src="https://z3.ax1x.com/2021/11/21/IjxDl8.png" alt="IjxDl8.png"></a></p><ol start="3"><li><strong>重启证书颁发机构然后把刚刚创建的web服务器副本添加过来</strong></li></ol><p><a href="https://imgtu.com/i/IjxLkR"><img src="https://z3.ax1x.com/2021/11/21/IjxLkR.png" alt="IjxLkR.png"></a></p><ol start="4"><li><strong>提交证书申请测试</strong></li></ol><p><a href="https://imgtu.com/i/IvSVa9"><img src="https://z3.ax1x.com/2021/11/21/IvSVa9.png" alt="IvSVa9.png"></a></p><ol start="5"><li><strong>查看证书年限</strong></li></ol><p><a href="https://imgtu.com/i/IvSKxK"><img src="https://z3.ax1x.com/2021/11/21/IvSKxK.png" alt="IvSKxK.png"></a></p><h3 id="组策略"><a href="#组策略" class="headerlink" title="组策略"></a>组策略</h3><h4 id="拒绝sys组从网络访问域控制器"><a href="#拒绝sys组从网络访问域控制器" class="headerlink" title="拒绝sys组从网络访问域控制器"></a>拒绝sys组从网络访问域控制器</h4><p><a href="https://imgtu.com/i/opIcCT"><img src="https://z3.ax1x.com/2021/11/23/opIcCT.png" alt="opIcCT.png"></a></p><h4 id="允许manager组本地登录域控制器"><a href="#允许manager组本地登录域控制器" class="headerlink" title="允许manager组本地登录域控制器"></a>允许manager组本地登录域控制器</h4><p><a href="https://imgtu.com/i/opoKiV"><img src="https://z3.ax1x.com/2021/11/23/opoKiV.png" alt="opoKiV.png"></a></p><h4 id="登录时不显示用户名，不显示上次登录，无须按Ctrl-Alt-Del"><a href="#登录时不显示用户名，不显示上次登录，无须按Ctrl-Alt-Del" class="headerlink" title="登录时不显示用户名，不显示上次登录，无须按Ctrl+Alt+Del"></a>登录时不显示用户名，不显示上次登录，无须按Ctrl+Alt+Del</h4><p><a href="https://imgtu.com/i/opTvNt"><img src="https://z3.ax1x.com/2021/11/23/opTvNt.png" alt="opTvNt.png"></a></p><p><a href="https://imgtu.com/i/op7n3T"><img src="https://z3.ax1x.com/2021/11/23/op7n3T.png" alt="op7n3T.png"></a></p><p><a href="https://imgtu.com/i/op78ER"><img src="https://z3.ax1x.com/2021/11/23/op78ER.png" alt="op78ER.png"></a></p><h4 id="审核登录事件，同时审核成功和失败"><a href="#审核登录事件，同时审核成功和失败" class="headerlink" title="审核登录事件，同时审核成功和失败"></a>审核登录事件，同时审核成功和失败</h4><p><a href="https://imgtu.com/i/op7228"><img src="https://z3.ax1x.com/2021/11/23/op7228.png" alt="op7228.png"></a></p><h4 id="禁用“关闭事件跟踪程序”"><a href="#禁用“关闭事件跟踪程序”" class="headerlink" title="禁用“关闭事件跟踪程序”"></a>禁用“关闭事件跟踪程序”</h4><p><a href="https://imgtu.com/i/opHiRK"><img src="https://z3.ax1x.com/2021/11/23/opHiRK.png" alt="opHiRK.png"></a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;/assets/css/APlayer.min.css&quot;&gt;&lt;script src=&quot;/assets/js/APlayer.min.js&quot; cla</summary>
      
    
    
    
    <category term="Windows" scheme="https://www.hnswxx.cn/categories/Windows/"/>
    
    
  </entry>
  
  <entry>
    <title>keepalived.conf配置文件说明</title>
    <link href="https://www.hnswxx.cn/2021/11/17/keepalived-profile/"/>
    <id>https://www.hnswxx.cn/2021/11/17/keepalived-profile/</id>
    <published>2021-11-17T08:24:46.000Z</published>
    <updated>2021-11-17T08:55:40.985Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>keepalived服务安装完成之后，后面的主要工作就是在 keepalived.conf 文件中配置HA和负载均衡。一个功能比较完整的常用的keepalived配置文件，主要包含三块：全局定义块、VRRP实例定义块和虚拟服务器定义块。全局定义块是必须的，如果keepalived只用来做ha，虚拟服务器是可选的。下面是一个功能比较完整的配置文件模板：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#全局定义块</span></span><br><span class="line">global_defs &#123;</span><br><span class="line">    <span class="comment"># 邮件通知配置</span></span><br><span class="line">    notification_email &#123;</span><br><span class="line">        email1</span><br><span class="line">        email2</span><br><span class="line">    &#125;</span><br><span class="line">    notification_email_from email</span><br><span class="line">    smtp_server host</span><br><span class="line">    smtp_connect_timeout num</span><br><span class="line"></span><br><span class="line">    lvs_id string</span><br><span class="line">    router_id string    <span class="comment">## 标识本节点的字条串,通常为hostname</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#VRRP 实例定义块</span></span><br><span class="line">vrrp_sync_group string &#123; </span><br><span class="line">    group &#123;</span><br><span class="line">        string</span><br><span class="line">        string</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance string &#123;</span><br><span class="line">    state MASTER|BACKUP</span><br><span class="line">    virtual_router_id num</span><br><span class="line">    interface string</span><br><span class="line">    mcast_src_ip @IP </span><br><span class="line">    priority num</span><br><span class="line">    advert_int num</span><br><span class="line">    nopreempt</span><br><span class="line">    smtp_alert</span><br><span class="line">    lvs_sync_daemon_interface string </span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS|AH</span><br><span class="line">        auth_pass string</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    virtual_ipaddress &#123;  <span class="comment"># Block limited to 20 IP addresses @IP</span></span><br><span class="line">        @IP</span><br><span class="line">        @IP</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#虚拟服务器定义块</span></span><br><span class="line">virtual_server (@IP PORT)|(fwmark num) &#123; </span><br><span class="line">    delay_loop num</span><br><span class="line">    lb_algo rr|wrr|lc|wlc|sh|dh|lblc </span><br><span class="line">    lb_kind NAT|DR|TUN</span><br><span class="line">    persistence_timeout num </span><br><span class="line">    protocol TCP|UDP</span><br><span class="line">    real_server @IP PORT &#123; </span><br><span class="line">        weight num</span><br><span class="line">        notify_down /path/script.sh</span><br><span class="line">        TCP_CHECK &#123; </span><br><span class="line">            connect_port num </span><br><span class="line">            connect_timeout num</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    real_server @IP PORT &#123;</span><br><span class="line">        weight num</span><br><span class="line">        MISC_CHECK &#123;</span><br><span class="line">            misc_path /path_to_script/script.sh(or misc_path “/path_to_script/script.sh &lt;arg_list&gt;”)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    real_server @IP PORT &#123;</span><br><span class="line">        weight num</span><br><span class="line">        HTTP_GET|SSL_GET &#123;</span><br><span class="line">            url &#123; </span><br><span class="line">                <span class="comment"># You can add multiple url block path alphanum</span></span><br><span class="line">                digest alphanum</span><br><span class="line">            &#125;</span><br><span class="line">            connect_port num</span><br><span class="line">            connect_timeout num </span><br><span class="line">            nb_get_retry num </span><br><span class="line">            delay_before_retry num</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="全局定义块"><a href="#全局定义块" class="headerlink" title="全局定义块"></a>全局定义块</h4><ol><li><p>email通知（notification_email、smtp_server、smtp_connect_timeout）：用于服务有故障时发送邮件报警，可选项，不建议用。需要系统开启sendmail服务，建议用第三独立监控服务，如用nagios全面监控代替。</p></li><li><p>lvs_id：lvs负载均衡器标识，在一个网络内，它的值应该是唯一的。</p></li><li><p>router_id：用户标识本节点的名称，通常为hostname</p></li><li><p>花括号｛｝：用来分隔定义块，必须成对出现。如果写漏了，keepalived运行时不会得到预期的结果。由于定义块存在嵌套关系，因此很容易遗漏结尾处的花括号，这点需要特别注意。</p></li></ol><h5 id="VRRP实例定义块"><a href="#VRRP实例定义块" class="headerlink" title="VRRP实例定义块"></a>VRRP实例定义块</h5><ol><li>vrrp_sync_group：同步vrrp级，用于确定失败切换（FailOver）包含的路由实例个数。即在有2个负载均衡器的场景，一旦某个负载均衡器失效，需要自动切换到另外一个负载均衡器的实例是哪</li><li>group：至少要包含一个vrrp实例，vrrp实例名称必须和vrrp_instance定义的一致</li><li>vrrp_instance：vrrp实例名<ol><li><strong>state</strong>：实例状态，只有MASTER 和 BACKUP两种状态，并且需要全部大写。抢占模式下，其中MASTER为工作状态，BACKUP为备用状态。当MASTER所在的服务器失效时，BACKUP所在的服务会自动把它的状态由BACKUP切换到MASTER状态。当失效的MASTER所在的服务恢复时，BACKUP从MASTER恢复到BACKUP状态。</li><li><strong>interface</strong>：对外提供服务的网卡接口，即VIP绑定的网卡接口。如：eth0，eth1。当前主流的服务器都有2个或2个以上的接口（分别对应外网和内网），在选择网卡接口时，一定要核实清楚\</li><li><strong>mcast_src_ip</strong>：本机IP地址</li><li><strong>virtual_router_id</strong>：虚拟路由的ID号，每个节点设置必须一样，可选择IP最后一段使用，相同的 VRID 为一个组，他将决定多播的 MAC 地址。</li><li><strong>priority</strong>：节点优先级，取值范围0～254，MASTER要比BACKUP高</li><li><strong>advert_int</strong>：MASTER与BACKUP节点间同步检查的时间间隔，单位为秒</li><li><strong>lvs_sync_daemon_inteface</strong>：负载均衡器之间的监控接口,类似于 HA HeartBeat 的心跳线。但它的机制优于 Heartbeat，因为它没有“裂脑”这个问题,它是以优先级这个机制来规避这个麻烦的。在 DR 模式中，lvs_sync_daemon_inteface与服务接口interface使用同一个网络接口</li><li><strong>authentication</strong>：验证类型和验证密码。类型主要有 PASS、AH 两种，通常使用PASS类型，据说AH使用时有问题。验证密码为明文，同一vrrp 实例MASTER与BACKUP使用相同的密码才能正常通信。</li><li><strong>smtp_alert</strong>：有故障时是否激活邮件通知</li><li><strong>nopreempt</strong>：禁止抢占服务。默认情况，当MASTER服务挂掉之后，BACKUP自动升级为MASTER并接替它的任务，当MASTER服务恢复后，升级为MASTER的BACKUP服务又自动降为BACKUP，把工作权交给原MASTER。当配置了nopreempt，MASTER从挂掉到恢复，不再将服务抢占过来。</li><li><strong>virtual_ipaddress</strong>：虚拟IP地址池，可以有多个IP，每个IP占一行，不需要指定子网掩码。注意：这个IP必须与我们的设定的vip保持一致。</li></ol></li></ol><h5 id="虚拟服务器virtual-server定义块"><a href="#虚拟服务器virtual-server定义块" class="headerlink" title="虚拟服务器virtual_server定义块"></a>虚拟服务器virtual_server定义块</h5><ol><li><p>virtual_server：定义一个虚拟服务器，这个ip是virtual_ipaddress中定义的其中一个，后面一个空格，然后加上虚拟服务的端口号。</p><ul><li>delay_loop：健康检查时间间隔，单位：秒</li><li>lb_algo：负载均衡调度算法，互联网应用常用方式为wlc或rr</li><li>lb_kind：负载均衡转发规则。包括DR、NAT、TUN 3种，一般使用路由（DR）转发规则。</li><li>persistence_timeout：http服务会话保持时间，单位：秒</li><li>protocol：转发协议，分为TCP和UDP两种</li></ul></li><li><p>real_server：真实服务器IP和端口，可以定义多个</p><ul><li>weight：负载权重，值越大，转发的优先级越高</li><li>notify_down：服务停止后执行的脚本</li><li>TCP_CHECK：服务有效性检测<ul><li>connect_port：服务连接端口</li><li>connect_timeout：服务连接超时时长，单位：秒</li><li>nb_get_retry：服务连接失败重试次数</li><li>delay_before_retry：重试连接间隔，单位：秒</li></ul></li></ul></li></ol>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;/assets/css/APlayer.min.css&quot;&gt;&lt;script src=&quot;/assets/js/APlayer.min.js&quot; cla</summary>
      
    
    
    
    <category term="Linux" scheme="https://www.hnswxx.cn/categories/Linux/"/>
    
    
    <category term="keepalived" scheme="https://www.hnswxx.cn/tags/keepalived/"/>
    
    <category term="高可用" scheme="https://www.hnswxx.cn/tags/%E9%AB%98%E5%8F%AF%E7%94%A8/"/>
    
  </entry>
  
  <entry>
    <title>高可用开源方案 Keepalived VS Heartbeat对比</title>
    <link href="https://www.hnswxx.cn/2021/11/16/keepalived_vs_heartbeat/"/>
    <id>https://www.hnswxx.cn/2021/11/16/keepalived_vs_heartbeat/</id>
    <published>2021-11-16T02:19:24.000Z</published>
    <updated>2021-11-16T02:22:11.392Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>最近因为项目需要，简单的试用了两款高可用开源方案：Keepalived和Heartbeat。两者都很流行，但差异还是很大的，现将试用过程中的感受以及相关知识点简单总结一下，供大家选择方案的时候参考。</p><ol><li><p>Keepalived使用更简单：从安装、配置、使用、维护等角度上对比，Keepalived都比Heartbeat要简单得多，尤其是Heartbeat 2.1.4后拆分成3个子项目，安装、配置、使用都比较复杂，尤其是出问题的时候，都不知道具体是哪个子系统出问题了；而Keepalived只有1个安装文件、1个配置文件，配置文件也简单很多；</p></li><li><p>Heartbeat功能更强大：Heartbeat虽然复杂，但功能更强大，配套工具更全，适合做大型集群管理，而Keepalived主要用于集群倒换，基本没有管理功能；</p></li><li><p>协议不同：Keepalived使用VRRP协议进行通信和选举，Heartbeat使用心跳进行通信和选举；Heartbeat除了走网络外，还可以通过串口通信，貌似更可靠；</p></li><li><p>使用方式基本类似：如果要基于两者设计高可用方案，最终都要根据业务需要写自定义的脚本，Keepalived的脚本没有任何约束，随便怎么写都可以；Heartbeat的脚本有约束，即要支持service start/stop/restart这种方式，而且Heartbeart提供了很多默认脚本，简单的绑定ip，启动apache等操作都已经有了；</p></li></ol><blockquote><p>使用建议：<strong>优先使用Keepalived</strong>，当Keepalived不够用的时候才选择Heartbeat</p></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;/assets/css/APlayer.min.css&quot;&gt;&lt;script src=&quot;/assets/js/APlayer.min.js&quot; cla</summary>
      
    
    
    
    <category term="Linux" scheme="https://www.hnswxx.cn/categories/Linux/"/>
    
    
    <category term="keepalived" scheme="https://www.hnswxx.cn/tags/keepalived/"/>
    
    <category term="高可用" scheme="https://www.hnswxx.cn/tags/%E9%AB%98%E5%8F%AF%E7%94%A8/"/>
    
  </entry>
  
  <entry>
    <title>Keepalived原理</title>
    <link href="https://www.hnswxx.cn/2021/11/15/keepalived-principle/"/>
    <id>https://www.hnswxx.cn/2021/11/15/keepalived-principle/</id>
    <published>2021-11-15T12:21:57.000Z</published>
    <updated>2021-11-15T12:28:16.968Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h3 id="Keepalived简介"><a href="#Keepalived简介" class="headerlink" title="Keepalived简介"></a>Keepalived简介</h3><p>Keepalived是Linux下一个轻量级别的高可用解决方案。高可用：广义来讲，是指整个系统的高可用行；狭义的来讲就是主机的冗余和接管。</p><p>它与HeartBeat实现类似的功能，都可以实现服务或者网络的高可用，但是又有差别，HeartBeat是一个专业的、功能完善的高可用软件，它提供HA软件所需的基本功能，比如：心跳检测、资源接管，检测集群中的服务，在集群节点转移共享IP地址的所有者等等。HeartBeat功能强大，但是部署和使用相对比较麻烦，与HeartBeat相比，Keepalived主要是通过虚拟路由冗余来实现高可用功能，虽然它没有HeartBeat功能强大，但是Keepalived部署和使用非常的简单，所有配置只需要一个配置文件即可以完成。</p><h3 id="Keepalived是什么？"><a href="#Keepalived是什么？" class="headerlink" title="Keepalived是什么？"></a>Keepalived是什么？</h3><p>Keepalived起初是为LVS设计的，专门用来监控集群系统中各个服务节点的状态，它根据TCP/IP参考模型的第三、第四层、第五层交换机制检测每个服务节点的状态，如果某个服务器节点出现异常，或者工作出现故障，Keepalived将检测到，并将出现的故障的服务器节点从集群系统中剔除，这些工作全部是自动完成的，不需要人工干涉，需要人工完成的只是修复出现故障的服务节点。</p><p>后来Keepalived又加入了VRRP的功能，VRRP（VritrualRouterRedundancyProtocol,虚拟路由冗余协议)出现的目的是解决静态路由出现的单点故障问题，通过VRRP可以实现网络不间断稳定运行，因此Keepalvied一方面具有服务器状态检测和故障隔离功能，另外一方面也有HAcluster功能。</p><p>健康检查和失败切换是keepalived的两大核心功能。所谓的健康检查，就是采用tcp三次握手，icmp请求，http请求，udp echo请求等方式对负载均衡器后面的实际的服务器(通常是承载真实业务的服务器)进行保活；而失败切换主要是应用于配置了主备模式的负载均衡器，利用VRRP维持主备负载均衡器的心跳，当主负载均衡器出现问题时，由备负载均衡器承载对应的业务，从而在最大限度上减少流量损失，并提供服务的稳定性。</p><h3 id="VRRP协议与工作原理"><a href="#VRRP协议与工作原理" class="headerlink" title="VRRP协议与工作原理"></a>VRRP协议与工作原理</h3><p>在现实的网络环境中。主机之间的通信都是通过配置静态路由或者(默认网关)来完成的，而主机之间的路由器一旦发生故障，通信就会失效，因此这种通信模式当中，路由器就成了一个单点瓶颈，为了解决这个问题，就引入了VRRP协议。</p><p>VRRP协议是一种容错的主备模式的协议，保证当主机的下一跳路由出现故障时，由另一台路由器来代替出现故障的路由器进行工作，通过VRRP可以在网络发生故障时透明的进行设备切换而不影响主机之间的数据通信。</p><p><a href="https://imgtu.com/i/IRF7wQ"><img src="https://z3.ax1x.com/2021/11/15/IRF7wQ.png" alt="IRF7wQ.png"></a></p><h4 id="虚拟路由器："><a href="#虚拟路由器：" class="headerlink" title="虚拟路由器："></a>虚拟路由器：</h4><p>虚拟路由器是VRRP备份组中所有路由器的集合，它是一个逻辑概念，并不是正真存在的。从备份组外面看备份组中的路由器，感觉组中的所有路由器就像一个 一样，可以理解为在一个组中： 主路由器+所有备份路由器=虚拟路由器。虚拟路由器有一个虚拟的IP地址和MAC地址。主机将虚拟路由器当作默认网关。虚拟MAC地址的格式为00-00-5E-00-01-{VRID}。通常情况下，虚拟路由器回应ARP请求使用的是虚拟MAC地址，只有虚拟路由器做特殊配置的时候，才回应接口的真实MAC地址。</p><h4 id="主路由器（MASTER）："><a href="#主路由器（MASTER）：" class="headerlink" title="主路由器（MASTER）："></a>主路由器（MASTER）：</h4><p>虚拟路由器通过虚拟IP对外提供服务，而在虚拟路由器内部同一时间只有一台物理路由器对外提供服务，这台提供服务的物理路由器被称为主路由器。一般情况下Master是由选举算法产生，它拥有对外服务的虚拟IP，提供各种网络功能，如：ARP请求，ICMP数据转发等。</p><h4 id="备份路由器（BACKUP）："><a href="#备份路由器（BACKUP）：" class="headerlink" title="备份路由器（BACKUP）："></a>备份路由器（BACKUP）：</h4><p>虚拟路由器中的其他物理路由器不拥有对外的虚拟IP，也不对外提供网络功能，仅接受MASTER的VRRP状态通告信息，这些路由器被称为备份路由器。当主路由器失败时，处于BACKUP角色的备份路由器将重新进行选举，产生一个新的主路由器进入MASTER角色，继续提供对外服务，整个切换对用户来说是完全透明的。</p><h3 id="VRRP选举机制"><a href="#VRRP选举机制" class="headerlink" title="VRRP选举机制"></a>VRRP选举机制</h3><p>VRRP路由器在运行过程中有三种状态：</p><ol><li>Initialize状态： 系统启动后就进入Initialize，此状态下路由器不对VRRP报文做任何处理；</li><li>Master状态；</li><li>Backup状态；一般主路由器处于Master状态，备份路由器处于Backup状态。</li></ol><p>VRRP使用选举机制来确定路由器的状态，优先级选举：</p><ol><li>VRRP组中IP拥有者。如果虚拟IP地址与VRRP组中的某台VRRP路由器IP地址相同，则此路由器为IP地址拥有者，这台路由器将被定位主路由器。</li><li>比较优先级。如果没有IP地址拥有者，则比较路由器的优先级，优先级的范围是0~255，优先级大的作为主路由器</li><li>比较IP地址。在没有Ip地址拥有者和优先级相同的情况下，IP地址大的作为主路由器。</li></ol><p>如下图所示，虚拟IP为10.1.1.254，在VRRP组中没有IP地址拥有者，则比较优先级，很明显RB和RA的优先级要大于RC，则比较RA和RB的IP地址，RB的IP地址大。所以RB为组中的主路由器。</p><p><a href="https://imgtu.com/i/IRFLYn"><img src="https://z3.ax1x.com/2021/11/15/IRFLYn.png" alt="IRFLYn.png"></a></p><h3 id="工作过程"><a href="#工作过程" class="headerlink" title="工作过程"></a>工作过程</h3><p>路由器使用VRRP 功能后，会根据优先级确定自己在备份组中的角色。优先级高的路由器成为Master 路由器，优先级低的成为Backup 路由器。Master 拥有对外服务的虚拟IP，提供各种网络功能，并定期发送VRRP 报文，通知备份组内的其他设备自己工作正常；Backup 路由器只接收Master 发来的报文信息，用来监控Master 的运行状态。当Master 失效时，Backup 路由器进行选举，优先级高的Backup 将成为新的Master 。</p><p>在抢占方式下，当Backup 路由器收到VRRP 报文后，会将自己的优先级与报文中的优先级进行比较。如果大于通告报文中的优先级，则成为Master 路由器；否则将保持Backup状态；</p><p>在非抢占方式下，只要Master 路由器没有出现故障，备份组中的路由器始终保持Master 或Backup 状态，Backup 路由器即使随后被配置了更高的优先级也不会成为Master 路由器；</p><p>如果Backup 路由器的定时器超时后仍未收到Master 路由器发送来的VRRP报文，则认为Master 路由器已经无法正常工作，此时Backup 路由器会认为自己是Master 路由器，并对外发送VRRP报文。备份组内的路由器根据优先级选举出Master 路由 器，承担报文的转发功能。</p><h3 id="Keepalvied的工作原理"><a href="#Keepalvied的工作原理" class="headerlink" title="Keepalvied的工作原理"></a>Keepalvied的工作原理</h3><p>Keepalived对服务器运行状态和故障隔离的工作原理：<br>Keepalived工作在TCP/IP参考模型的三层、四层、五层（物理层，链路层）：<br>网络层（3）：Keepalived通过ICMP协议向服务器集群中的每一个节点发送一个ICMP数据包(有点类似与Ping的功能)，如果某个节点没有返回响应数据包，那么认为该节点发生了故障，Keepalived将报告这个节点失效，并从服务器集群中剔除故障节点。</p><p>传输层（4）：Keepalived在传输层里利用了TCP协议的端口连接和扫描技术来判断集群节点的端口是否正常，比如对于常见的WEB服务器80端口。或者SSH服务22端口，Keepalived一旦在传输层探测到这些端口号没有数据响应和数据返回，就认为这些端口发生异常，然后强制将这些端口所对应的节点从服务器集群中剔除掉。</p><p>应用层（5）：，Keepalived的运行方式也更加全面化和复杂化，用户可以通过自定义Keepalived工作方式，例如：可以通过编写程序或者脚本来运行Keepalived，而Keepalived将根据用户的设定参数检测各种程序或者服务是否允许正常，如果Keepalived的检测结果和用户设定的不一致时，Keepalived将把对应的服务器从服务器集群中剔除。</p><h3 id="Keepalived体系结构"><a href="#Keepalived体系结构" class="headerlink" title="Keepalived体系结构"></a>Keepalived体系结构</h3><p>Keepalived起初是为LVS设计的，由于Keeplalived可以实现对集群节点的状态检测，而IPVS可以实现负载均衡功能，因此,Keepalived借助于第三方模块IPVS就可以很方便地搭建一套负载均衡系统。在Keepalived当中IPVS模块是可配置的，如果需要负载均衡功能，可以在编译Keepalived时开打负载均衡功能，也可以通过编译参数关闭。</p><p><a href="https://imgtu.com/i/IRFvlV"><img src="https://z3.ax1x.com/2021/11/15/IRFvlV.png" alt="IRFvlV.png"></a></p><p>SchedulerI/OMultiplexer是一个I/O复用分发调度器，它负载安排Keepalived所有内部的任务请求；</p><p>Memory Mngt是一个内存管理机制，这个框架提供了访问内存的一些通用方法；</p><p>Control Plane 是keepalived的控制版面，可以实现对配置文件编译和解析；</p><p>Core componets 这部分主要包含了5个部分；</p><p>Watchdog：是计算机可靠领域中极为简单又非常有效的检测工具，Keepalived正是通过它监控Checkers和VRRP进程的。<br>Checkers:这是Keepalived最基础的功能，也是最主要的功能，可以实现对服务器运行状态检测和故障隔离。<br>VRRP Stack:这是keepalived后来引用VRRP功能，可以实现HA集群中失败切换功能。负责负载均衡器之间的失败切换FailOver；<br>IPVS wrapper:这个是IPVS功能的一个实现，IPVSwarrper模块将可以设置好的IPVS规则发送的内核空间并且提供给IPVS模块，最终实现IPVS模块的负载功能。<br>Netlink Reflector：用来实现高可用集群Failover时虚拟IP(VIP)的设置和切换，<br>keepalived运行时，会启动3个进程，分别为：core(核心进程)，check和vrrp</p><ul><li>core：负责主进程的启动，维护和全局配置文件的加载；</li><li>check：负责健康检查</li><li>vrrp：用来实现vrrp协议</li></ul><h3 id="与heartbeat-corosync等比较"><a href="#与heartbeat-corosync等比较" class="headerlink" title="与heartbeat/corosync等比较"></a>与heartbeat/corosync等比较</h3><p>　　Heartbeat、Corosync、Keepalived这三个集群组件我们到底选哪个好，Heartbeat、Corosync是属于同一类型，Keepalived与Heartbeat、Corosync，根本不是同一类型的。Keepalived使用的vrrp虚拟路由冗余协议方式；Heartbeat或Corosync是基于主机或网络服务的高可用方式；简单的说就是，Keepalived的目的是模拟路由器的高可用，Heartbeat或Corosync的目的是实现Service的高可用。<br>　　<br>　　所以一般Keepalived是实现前端高可用，常用的前端高可用的组合有，就是我们常见的LVS+Keepalived、Nginx+Keepalived、HAproxy+Keepalived。而Heartbeat或Corosync是实现服务的高可用，常见的组合有Heartbeat v3(Corosync)+Pacemaker+NFS+Httpd 实现Web服务器的高可用、Heartbeat v3(Corosync)+Pacemaker+NFS+MySQL 实现MySQL服务器的高可用。总结一下，Keepalived中实现轻量级的高可用，一般用于前端高可用，且不需要共享存储，一般常用于两个节点的高可用。而Heartbeat(或Corosync)一般用于服务的高可用，且需要共享存储，一般用于多节点的高可用。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;/assets/css/APlayer.min.css&quot;&gt;&lt;script src=&quot;/assets/js/APlayer.min.js&quot; cla</summary>
      
    
    
    
    <category term="Linux" scheme="https://www.hnswxx.cn/categories/Linux/"/>
    
    
    <category term="keepalived" scheme="https://www.hnswxx.cn/tags/keepalived/"/>
    
    <category term="高可用" scheme="https://www.hnswxx.cn/tags/%E9%AB%98%E5%8F%AF%E7%94%A8/"/>
    
  </entry>
  
  <entry>
    <title>网络参数管控者 DHCP服务</title>
    <link href="https://www.hnswxx.cn/2021/11/15/dhcp-server/"/>
    <id>https://www.hnswxx.cn/2021/11/15/dhcp-server/</id>
    <published>2021-11-15T08:32:39.000Z</published>
    <updated>2021-11-15T10:50:34.680Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote><p>想象两种情况：</p></blockquote><ol><li>如果你在工作单位使用的是笔记本电脑，而且常常要带着你的笔记本电脑到处跑， 那么你会发现，哇！ 我的网络卡参数要常常修改啊！而且， 每到一个新的地方，就得问清楚该地的网络参数才行！真是麻烦。 </li><li>你的公司常常有访客或贵客来临，因为他们也带来笔电，所以也得常常跑来</li><li>找你问网络参数才能设定他的计算机。哇！这两种情况都会让你想哭哭吧？这个时候，动态主机设定协议(DHCP)可就大大的派上用场啦！DHCP这个服务可以自动的分配IP与相关的网络参数给客户端，来提供客户端自动以服务器提供的参数来设定他们的网络。如此一来，使用者只要将自己的笔电设定好经由DHCP协议来取得网络参数后，一插上网络线，呵呵！马上就可以享受Internet的服务啦！很方便吧！所以得来瞧一瞧这个好用的协定喔！</li></ol><h3 id="DHCP-运作的原理"><a href="#DHCP-运作的原理" class="headerlink" title="DHCP 运作的原理"></a>DHCP 运作的原理</h3><p>在正式的进入DHCP(DynamicHostConfigurationProtocol)服务器设定之前，我们先来认识一下DHCP这个协议吧！还有，需要了解的是，我们是否『一定』得设定DHCP这个服务器呢？这里都需要厘清一下概念喔！</p><h4 id="DHCP-服务器的用途"><a href="#DHCP-服务器的用途" class="headerlink" title="DHCP 服务器的用途"></a>DHCP 服务器的用途</h4><p>在开始DHCP的说明之前，我们先来复习一下之前在网络基础里面提到的几个网络参数吧！要设定好一个网络的环境，使计算机可以顺利的连上Internet，那么你的计算机里面一定要有底下几个网络的参数才行，分别是：</p><table><thead><tr><th>IP</th><th>netmask</th><th>network</th><th>broadcast</th><th>gateway</th><th>DNS IP</th></tr></thead></table><p>其中，那个IP netmask network broadcast 与 gateway都可以在</p><p>/etc/sysconfig/network-scripts/ifcfg-eth[0-n] 这档案里面设定，DNS 服务器的地址则是在 /etc/resolv.conf 里头设定。只要这几个项目设定正确，那么计算机应该就没问题的可以上网了！所以说，你家里面的3,4部计算机，你都可以手动的来设定好你所需要的网络参数，然后利用NAT服务器的功能，就可以大摇大摆的连上Internet了！真是不错^_^，不是吗？</p><ol><li>直接每一部计算机都让你登门拜访手动的去设定好？ </li><li>将所有的学生都集合起来，然后精神训话…..喔不！是直接教导一下怎么 设定？还是 </li><li>藉由一部主机来自动的分配所有的网络参数给宿舍内的任何一部计算机？ 这三种解决方案所需要的时间都不相同，如果你选择的是(1)，那么鸟哥个人认为， 你不是工作狂就是疯掉了， 因为所要花费的时间与你所得的薪水与付出的心力是完全 不成比例的。如果选择是(2)，那么很可能你会被挂上独裁者、 没良心的管理员的称号！ 如果是选择(3)呢？恭喜你！这个方案的管理时间花费最短，也是最不麻烦的作法啦！ 呵呵！知道鸟哥要说些什么了吗？是的！这个 DHCP (Dynamic Host Configuration Protocol) 服务器最主要的工作，就是在进行上面的第三个方案，也就是自动的将网络 参数正确的分配给网域中的每部计算机， 让客户端的计算机可以在开机的时候就立即 自动的设定好网络的参数值，这些参数值可以包括了 IP、netmask、network、gateway 与 DNS 的地址等等。如此一来，身为管理员的你，只要注意到这一部提供网络参数的 主机有没有挂掉就好了， 其他同学们的个人计算机，哈！你想都不必想要怎么去帮忙！ 因为 DHCP 主机已经完全都帮你搞定啦！ ^_^！ 阿！当管理员最大的幸福就是可以喝 喝茶、聊聊天就能控管好一切的网络问题呢！</li></ol><h4 id="DHCP-协议的运作方式"><a href="#DHCP-协议的运作方式" class="headerlink" title="DHCP 协议的运作方式"></a>DHCP 协议的运作方式</h4><p>你必需要知道的是，DHCP通常是用于局域网络内的一个通讯协议，他主要藉由客户端传送广播封包给整个物理网段内的所有主机，若局域网络内有DHCP服务器时，才会响应客户端的IP参数要求。所以啰，DHCP服务器与客户端是应该要在同一个物理网段内的。至于整个DHCP封包在服务器与客户端的来来回回情况有点像底下这样：</p><p><a href="https://imgtu.com/i/I2rPcn"><img src="https://z3.ax1x.com/2021/11/15/I2rPcn.png" alt="I2rPcn.png"></a></p><blockquote><p>客户端取得 IP 参数的程序可以简化如下：</p></blockquote><ol><li><p>客户端：利用广播封包发送搜索 DHCP 服务器的封包： 若客户端网络设定使用 DHCP 协议取得 IP (在 Windows 内为『自动取得 IP』)， 则当客户端开机或者是重新启动网络卡时， 客户端主机会发送出搜寻 DHCP 服 务器的 UDP 封包给所有物理网段内的计算机。此封包的目标 IP 会是 255.255.255.255， 所以一般主机接收到这个封包后会直接予以丢弃，但若局域 网络内有 DHCP 服务器时，则会开始进行后续行为。 </p></li><li><p>服务器端：提供客户端网络相关的租约以供选择： DHCP 服务器在接收到这个客户端的要求后，会针对这个客户端的硬件地址 (MAC) 与本身的设定数据来进行下列工作：</p><ul><li><p>到服务器的登录文件中寻找该用户之前是否曾经用过某个 IP ，若有且该 IP 目前无人使用，则提供此 IP 给客户端；</p></li><li><p>若配置文件针对该 MAC 提供额外的固定 IP (static IP) 时，则提供该固定 IP 给客户端；</p></li><li><p>若不符合上述两个条件，则随机取用目前没有被使用的 IP 参数给客户端，并记录下来。</p></li></ul></li></ol><p>​        总之，服务器端会针对客户端的要求提供一组网络参数租约给客户端选择，由于此时客户端尚未有 IP ，因此        服务器端响应的封包信息中， 主要是针对客户端此时客户端尚未有 IP ，因此服务器端响应的封包信息中，         主要是针对客户端</p><ol start="3"><li><p>客户端：决定选择的DHCP服务器提供的网络参数租约并回报服务器：由于局域网络内可能并非仅有一部DHCP服务器，但客户端仅能接受一组网络参数的租约。因此客户端必需要选择是否要认可该服务器提供的相关网络参数的租约。当决定好使用此服务器的网络参数租约后，客户端便开始使用这组网络参数来设定自己的网络环境。此外，客户端也会发送一个广播封包给所有物理网段内的主机，告知已经接受该服务器的租约。此时若有第二台以上的DHCP服务器，则这些没有被接受的服务器会收回该IP租约。至于被接受的DHCP服务器会继续进行底下的动作。</p></li><li><p>服务器端：记录该次租约行为并回报客户端已确认的响应封包信息：当服务器端收到客户端的确认选择后，服务器会回传确认的响应封包，并且告知客户端这个网络参数租约的期限，并且开始租约计时喔！那么该次租约何时会到期而被解约(真可怕的字眼)？你可以这样想：</p></li></ol><ul><li><p>客户端脱机：不论是关闭网络接口(ifdown)、重新启动(reboot)、关机(shutdown)等行为，皆算是脱机状态，这个时候Server端就会将该IP回收，并放到Server自己的备用区中，等待未来的使用；</p></li><li><p>客户端租约到期：前面提到DHCPserver端发放的IP有使用的期限，客户端使用这个IP到达期限规定的时间，而且没有重新提出DHCP的申请时，就需要将IP缴回去！这个时候就会造成断线。但用户也可以再向 DHCP 服务器要求再次分配 IP 啰。</p></li></ul><p>以上就是DHCP这个协议在Server端与Client端的运作状态，由上面这个运作状态来看，我们可以晓得，只要Server端设定没有问题，加上Server与Client在硬件联机上面确定是OK的，那么Client就可以直接藉由Server来取得上网的网络参数，当然啦，只要我们这些管理员能够好好的、正确的管理好我们的DHCP服务器，嘿嘿！那么上网的设定自然就变成一件很简单的事情啦！不过，关于上述的流程还是有一些需要额外说明的啦：</p><blockquote><p>DHCP服务器给予客户端的IP参数为固定或动态：</p></blockquote><p>在上面的步骤里面，注意到第二步骤了吗？就是服务器会去比较客户端的MAC硬件地址，并判断该MAC是否需要给予一个固定的IP呢！所以啦，我们可以设定DHCP服务器给予客户端的IP参数主要有两种：</p><ul><li><p>固定 (Static) IP：</p><p>只要那个客户端计算机的网络卡不换掉，那么 MAC 肯定就不会改变，由于 DHCP 可以根据 MAC 来给予固定的 IP 参数租约，所以该计算机每次都能以一个固定 的 IP 连上 Internet ！呵呵！ 这种情况比较适合当这部客户端计算机需要用 来做为提供区域内的一些网络服务的主机之用 (所以 IP 要固定)。那么如何在 Linux 上面知道网络卡的 MAC 呢？很简单啦！有很多的方式，最简单的方式就 是使用 ifconfig 及 arp 来进行：</p><ul><li><p>观察自己的 MAC 可用 ifconfig：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@www ~]<span class="comment"># ifconfig | grep HW</span></span><br><span class="line">eth0 Link encap:Ethernet HWaddr 08:00:27:71:85:BD</span><br><span class="line">eth1 Link encap:Ethernet HWaddr 08:00:27:2A:30:14</span><br><span class="line"><span class="comment"># 因为鸟哥有两张网卡，所以有两个硬件地址喔！</span></span><br></pre></td></tr></table></figure></li><li><p>观察别人的 MAC 可用 ping 配合 arp</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@www ~]<span class="comment"># ping -c 3 192.168.1.254</span></span><br><span class="line">[root@www ~]<span class="comment"># arp -n</span></span><br><span class="line">Address HWtype HWaddress Flags Mask Iface</span><br><span class="line">192.168.1.254 ether 00:0c:6e:85:d5:69 C eth0</span><br></pre></td></tr></table></figure></li></ul></li><li><p>动态 (dynamic) IP：</p><p>Client 端每次连上 DHCP 服务器所取得的 IP 都不是固定的！都直接经由 DHCP 所随机由尚未被使用的 IP 中提供！除非你的局域网络内的计算机有可能用来做为主机之用，所以必需要设定成为固定 IP ，否则使用动态 IP 的设定比较简单，而且使用上面具有较佳的弹性。怎么说呢？ 假如你是一个 ISP 好了，而你只申请到 150 个 IP 来做为你的客户联机之用。那么你是否真的只能邀集到 150 的使用者？呵呵！当然不啰！我可以邀集 200 个使用者以上呢！</p><p>为什么？这样想好了，我今天开了一家餐馆，里面只有20个座位，那么是否我一餐只能卖给20个人呢？当然不是啦！因为客人是人来人往的，有人先吃有人后吃，所以同样是20个座位，但是可以有40个人来吃我的简餐，因为来的时间不一样嘛！了解了吗？呵呵！对啦！你这个ISP虽然只有150个IP可以发放，但是因为你的使用者并非24小时都挂在在线的，所以你可以将这150个IP做良好的分配，让200个人来『轮流使用』这150个IP哩！</p></li></ul><p><strong>Tips</strong>:</p><p>其实IP只有PublicIP与PrivateIP两种，中文翻译成『公共IP』与『私有IP』这两个，至于其他所谓的『静态IP』、『实体IP』、『虚拟IP』、『浮动式IP』等等，都是藉由一些IP取得的方式来分类的，关于IP的种类我们在网络基础中谈过了，记得再好好的厘清一下观念喔！事实上现在主流的ADSL宽带拨接上网也有使用到『静态IP』与『固定IP』之类的概念喔！举例来说好了，hinet/seednet等主要ISP都有提供所谓的：『一个固定IP搭配7~8个浮动IP』的ADSL拨接功能，也就是说同样透过一条电话线拨接到ISP，但是其中一个拨接是可以取得固定的IP呢！而其他的则是非固定的IP，DHCP的static/dynamic跟这个玩意儿有点类似啦！^_^</p><blockquote><p>关于租约所造成的问题与租约期限：</p></blockquote><p>怪了！如果我们观察上面DHCP运作模式的第四个步骤，你会发现最后DHCP服务器还会给予一个租约期限！干嘛还要这样的一个期限呢？其实设定期限还是有个优点啦！最大的优点就是可以避免IP被某些使用者一直占用着，但该使用者却是Idle(发呆)的状态！</p><p>举个例子来说，我们刚刚不是说到，我有150个IP，但是偏偏我有200个用户吗？我们以2010年的世界杯足球赛来说明好了。假设每个使用者都急着上网知道世足赛的消息，那么某些热门对战时段网络将可能达到使用尖峰！也就是说，这200个人同时要来使用这150个IP，有可能吗？当然不可能！肯定会有50个人无法联机，因为『很抱歉！目前系统正在忙线中，请你稍后再拨！』</p><p>那怎么办？这个时候租约到期的方式就很有用处啦！那几个已经联机进来很久的人，就会因为租约到期而被迫脱机，这个时候该IP就会被释放出来，哈哈！大家赶快抢呀！先抢到先赢喔！所以，那50个人(包括被迫脱机的那个朋友)只好继续的、努力的、加油的来进行DHCP的要求啰！^_^””虽然说是优点，但是其实如果站在使用者的角度来看，还是可能会造成公愤的！凭什么大家一起交钱，我先联机进来就需要先被踢出去？～呵呵！所以啰，如果要当ISP，</p><p>还是得要先规划好服务的方针才行呦！这样你可以了解租约到期的行为了吗？！^_^既然有租约时间，那么是否代表我用DHCP取得的IP就得要『手动』的在某个时间点去重新取得新的IP呢？不需要的啦！因为目前的DHCP客户端程序大多会主动的依据租约时间去重新申请IP(renew)的！也就是说在租约到期前你的DHCP客户端程序就已经又重新申请更新租约时间了。所以除非DHCP主机挂点，否则你所取得的IP应该是可以一直使用下去的！</p><p><strong>Tips</strong>: </p><p>一般来说，假设租约期限是T小时，那么客户端在0.5T会主动向DHCP服务器发出重新要求网络参数的封包。如果这次封包要求没有成功，那么在0.875T后还会再次的发送封包一次。正因如此，所以服务器端会启动port67监听用户要求，而用户会启动port68主动向服务器要求哩！鸟哥觉得这是很特殊的一件事呢！</p><blockquote><p>多部 DHCP 服务器在同一物理网段的情况</p></blockquote><p>或许你曾经发现过一件事情，那就是当我的网域里面有两部以上的DHCP服务器时，到底哪一部服务器会提供我的这部客户端计算机所发出的DHCP要求？呵呵！很抱歉，俺也不晓得！因为在网络上面，很多时候都是『先抢先赢』的，DHCP的回应也是如此！当Server1先响应时，你使用的就是Server1所提供的网络参数内容，如果是Server2先响应，你就是使用Server2的参数来设定你的客户端PC！不过，前提之下当然是这些计算机的『物理联机』都是在一起的啊！</p><p>因为这个特色的关系，所以当你在练习DHCP服务器的设定之前，不要在已经正常运作的区网下测试，否则会很惨。举个鸟哥的例子来说好了，某一次其他系的研究生在测试网络安全时，在原有的区网上面放了一部IP分享器，结果你猜怎么着？整栋大楼的网络都不通了！因为那时整栋大楼的网络是串接在一起的，而我们学校是使用DHCP让客户端上网。由于IP分享器的设定并不能连上Internet，哇！大家都无法上网了啦！那你晓得了吗？不要随便测试啦这个DHCP服务器！</p><h4 id="何时需要架设-DHCP-服务器"><a href="#何时需要架设-DHCP-服务器" class="headerlink" title="何时需要架设 DHCP 服务器"></a>何时需要架设 DHCP 服务器</h4><p>既然DHCP的好处是『免客户端设定』，而且对于行动装置的上网方面非常的方便！那么是否代表你就得要架设一部DHCP呢？那可不一定！接下来要告知大家的是几个概念性的问题，你倒不一定『必需』遵守底下的一些概念呢！反正，自己的网域自己『爽』就好啦！</p><blockquote><p>使用 DHCP 的几个时机</p></blockquote><p>在某些情况之下，倒是强烈的建议架设DHCP主机的！什么情况呢？例如：</p><ul><li><p>具有相当多行动装置的场合：</p><p>例如你的公司内部很多笔记本电脑使用的场合！因为这种笔电本身就是移动性的装置，如果每到一个地方都要去问人家『喂！你这边的网络参数是什么？』还得要担心是否会跟人家的IP相冲突等等的问题！这个时候，DHCP可就是你的救星啰！</p></li><li><p>区域内计算机数量相当的多时：</p><p>另外一个情况就是你所负责的网域内计算机数量相当庞大时，大到你没有办法一个一个的进行说明来设定他们自己的网络参数，这个时候为了省麻烦，还是架设DHCP来的方便吶！况且，维护一部你熟悉的DHCP主机，要比造访几十个不懂计算机的人要简单的多哩！^_^</p></li></ul><blockquote><p>不建议使用 DHCP 主机的时机</p></blockquote><p>虽然DHCP有很多好处，但是你有没有发现一个步骤怪怪的呀！回头看一下那个步骤一，客户端在开机的时候会主动的发送讯息给网域上的所有机器，这个时候，如果网域上就是没有DHCP主机呢？很抱歉，那么你的这部客户端计算机，『仍然会持续的发送讯息！』真正的时间与次数不晓得会有多久，不过，肯定会超过30秒以上，甚至可以达到一分钟以上！哇！那么这段时间你能干嘛？呵呵！除了等、还是等！所以啰，如果计算机数不多，还是使用手动的方式来设定一下就好了！方便嘛！</p><ul><li><p>在你网域内的计算机，有很多机器其实是做为主机的用途，很少用户需求， 那么似乎就没有必要架设 DHCP </p></li><li><p>更极端的情况是，像一般家里，只有 3 ~ 4 部计算机，这个时候，架设 DHCP 只能拿来练练功力，事实上，并没有多大的效益；</p></li><li><p>当你管理的网域当中，大多网络卡都属于老旧的型号，并不支持 DHCP 的协议时；</p></li><li><p>很多用户的信息知识都很高，那么也没有需要架设 DHCP 啦。</p></li></ul><p>如前所述，上面的都是概念性的说法，事实上，一件事情的解决之道是有很多的方案的，没有所谓的『完全正确』的方案，只有『相对可行、并且符合经济效益与功能』的方案！所以啰，架设任何网站之前，请先多评估评估吶！</p><h3 id="DHCP-服务器端的设定"><a href="#DHCP-服务器端的设定" class="headerlink" title="DHCP 服务器端的设定"></a>DHCP 服务器端的设定</h3><p>事实上，目前市面上的 IP 分享器已经便宜到爆了！而 IP 分享器本身就含有 DHCP的功能。 所以如果你只是想要单纯的使用 DHCP 在你的局域网络当中而已，那么建议你直接购买一部 IP 分享器来使用即可， 因为至少它很省电。如果你还有其他考虑的话，才来架设 DHCP 吧！底下我们以一个简单的范例来架设 DHCP 先。</p><h4 id="所需软件与档案结构"><a href="#所需软件与档案结构" class="headerlink" title="所需软件与档案结构"></a>所需软件与档案结构</h4><p>DHCP的软件需求很简单，就是只要服务器端软件即可，在CentOS6.x上面，这个软件的名称就是dhcp啰！如果是默认安装，那么这个软件是不会安装的，请自行使用yum去装好这个软件吧！安装完毕之后，你可以使用『rpm-ql dhcp』来看看这个软件提供了哪些档案，基本上，比较重要的档案数据如下：</p><ul><li><p>/etc/dhcp/dhcpd.conf</p><p>这个就是 dhcp 服务器的主要配置文件咯！在某些 Linux 版本上头这个档案可能不存在，所以如果你确定有安装 dhcp 软件却找不到这个档案时，请手动自行建立它即可。</p><blockquote><p><strong>Tips</strong>: </p><p>其实 dhcp 软件在释出的时候都会附上一个范例档案，你可以使用 『 rpm -ql dhcp 』来查询到 dhcpd.conf.sample 这个范例档案， 然后将该档案复制成为 /etc/dhcp/dhcpd.conf 后，再手动去修改即可，这样设定比较容易啦！</p></blockquote></li><li><p>/usr/sbin/dhcpd</p><p>启动整个 dhcp daemon 的执行档啊！其实最详细的执行方式应该要使用『 man dhcpd 』来查阅一番的呢！^_^</p></li><li><p>/var/lib/dhcp/dhcpd.leases</p><p>这档案颇有趣的！我们前面原理部分不是有提到『租约』吗？DHCP服务器端与客户端租约建立的启始与到期日就是记录在这个档案当中的咯！就跟你说很简单吧！整个软件数据也不过才如此而已呢！</p></li></ul><h4 id="主要配置文件-etc-dhcp-dhcpd-conf-的语法"><a href="#主要配置文件-etc-dhcp-dhcpd-conf-的语法" class="headerlink" title="主要配置文件 /etc/dhcp/dhcpd.conf 的语法"></a>主要配置文件 /etc/dhcp/dhcpd.conf 的语法</h4><p>在 CentOS 5.x 以前，这个档案都被放置到 /etc/dhcpd.conf 的，新版的才放置于此处。其实 DHCP 的设定很简单啊，只要将 dhcpd.conf 设定好就可以启动了。不过编辑这个档案时你必须要留意底下的规范：</p><p>『 # 』为批注符号；除了右括号 “)” 后面之外，其他的每一行设定最后都要以『 ; 』做为结尾！ 重要！</p><p>设定项目语法主要为：『 &lt;参数代号&gt; &lt;设定内容&gt; 』，例如：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">default-lease-time 259200;</span><br></pre></td></tr></table></figure><p>某些设定项目必须以 option 来设定，基本方式为『 option &lt;参数代码&gt; &lt; 设定内容&gt; 』例如：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">option domain-name <span class="string">&quot;your.domain.name&quot;</span>;</span><br></pre></td></tr></table></figure><p>基本上，我们刚刚前面提过说，DHCP的IP分配可分为给予动态IP与固定IP，其中又需要了解的是，如果需要设定固定IP的话，那么就必须要知道要设定成固定IP的那部计算机的硬件地址(MAC)才行，请使用arp或ifconfig来查知你的接口的MAC吧！好了，那么需要设定的项目有哪些呢？其实dhcpd.conf里头的设定主要分为两大项目，一个是服务器运作的整体设定(Global)一个是IP设定模式(动态或固定)，每个项目的设定值大概有底下这几项</p><blockquote><p>整体设定 (Global) </p></blockquote><p>假设你的 dhcpd 只管理一个区段的区网，那么除了 IP 之外的许多网络参数就可 以放在整体设定的区域中，这包括有租约期限、DNS 主机的 IP 地址、路由器的 IP 地址还有动态 DNS (DDNS) 更新的类型等等。当固定 IP 及动态 IP 内没有规范到某些设 定时，则以整体设定值为准。这些参数的设定名称为：</p><ul><li><p>default-lease-time 时间：</p><p>用户的计算机也能够要求一段特定长度的租约时间，但若使用者没有特别要求租约时间的话， 那么就以此为预设的租约时间。后面的时间参数默认单位为秒；</p></li><li><p>max-lease-time 时间：</p><p>与上面的预设租约时间类似，不过，这个设定值是在规范使用者所能要求的最大租约时间。也就是说， 使用者要求的租约时间若超过此设定值，则以此值为准；</p></li><li><p>option domain-name “领域名”：</p><p>如果你在/etc/resolv.conf里面设定了一个『search google.com』的话，这表示当你要搜寻主机名时，DNS系统会主动帮你加上这个领域名的意思。</p></li><li><p>option domain-name-servers IP1, IP2： </p><p>这个设定参数可以修改客户端的 /etc/resolv.conf 档案！就是 nameserver 后 面接的那个 DNS IP 啰！特别注意设定参数最末尾为『servers』 (有 s 喔)；</p></li><li><p>ddns-update-style 类型：、</p><p>因为DHCP客户端所取得的IP通常是一直变动的，所以某部主机的主机名与IP的对应就很难处理。此时DHCP可以透过ddns来更新主机名与IP的对应。不过我们这里不谈这么复杂的东西，所以你可以将他设定为none喔。</p></li><li><p>ignore client-updates：</p><p>与上一个设定值较相关，客户端可以透过dhcpd服务器来更新DNS相关的信息。不过，这里我们也先不谈这个，因此就将它设定为ignore(忽略)了。</p></li><li><p>option routers 路由器的地址： </p><p>设定路由器的 IP 所在，记得那个『 routers 』要加 s 才对！</p></li></ul><blockquote><p>IP 设定模式 (动态或固定)</p></blockquote><p>由于dhcpd主要是针对局域网络来给予IP参数的，因此在设定IP之前，我们得要指定一个区网才行。指定区网的方式使用如下的参数：subnet NETWORK_IP netmask NETMASK_IP{…}我们知道区网要给予network/netmaskIP这两个参数才行，例如之前谈过的：192.168.100.0/255.255.255.0这样的设定值。上头设定值当中，subnet与<br>netmask是关键词，而大写部分就填上你的区网参数啰。那在括号内还有什么参数需要设定的？那就是到底IP是固定的还是动态的设定啊：</p><ul><li><p>range IP1 IP2：<br>在这个区网当中，给予一个连续的IP群用来发放成动态IP的设定，那个IP1 IP2指的是开放的IP范围。举例来说，你想要开放192.168.100.101到192.168.100.200这100个IP用来作为动态分配，那就是：range<br>192.168.100.101192.168.100.200;</p></li><li><p>host 主机名 { … };</p><p>这个 host 就是指定固定 IP 对应到固定 MAC 的设定值，那个主机名可以自己想想再给予即可。 不过在大括号内就得要指定 MAC 与固定的 IP 啰！那这两个设定值怎么设定呢？看看底下啰：</p><ul><li><p>hardware ethernet 硬件地址：</p><p>利用网络卡上面的固定硬件地址来设定，亦即该设定仅针对这个硬件地址 有效的意思；</p></li><li><p> fixed-address IP 地址：</p></li></ul><p>  给予一个固定的 IP 地址的意思。 说再多也没有什么用啦！让我们实际来玩一个案例吧！你就知道该如何处理了。</p></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;/assets/css/APlayer.min.css&quot;&gt;&lt;script src=&quot;/assets/js/APlayer.min.js&quot; cla</summary>
      
    
    
    
    <category term="Linux" scheme="https://www.hnswxx.cn/categories/Linux/"/>
    
    
    <category term="Centos8" scheme="https://www.hnswxx.cn/tags/Centos8/"/>
    
    <category term="DHCP" scheme="https://www.hnswxx.cn/tags/DHCP/"/>
    
    <category term="鸟哥的Linux私房菜" scheme="https://www.hnswxx.cn/tags/%E9%B8%9F%E5%93%A5%E7%9A%84Linux%E7%A7%81%E6%88%BF%E8%8F%9C/"/>
    
  </entry>
  
  <entry>
    <title>邮件服务器 Postfix</title>
    <link href="https://www.hnswxx.cn/2021/11/13/mail-server-postfix/"/>
    <id>https://www.hnswxx.cn/2021/11/13/mail-server-postfix/</id>
    <published>2021-11-13T00:49:16.000Z</published>
    <updated>2021-11-22T02:03:35.087Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>​        在这个邮件服务器的架设中，我们首先谈论 Mail 与 DNS 的重要相关性，然后依序介绍 Mail Server 的相关名词，以及 Mail Server 的运作基本流程与协议，也会谈到相关的 Relay 与邮件认证机制等项目， 这些项目对于未来邮件服务器的管理与设定是重要的，请不要忽略了这方面问题的讨论喔。 由于 Postfix 的配置文件内容较具有亲和性，因此我们单纯介绍了 Postfix 不再介绍 sendmail 了。</p><h4 id="邮件服务器的功能与运作原理"><a href="#邮件服务器的功能与运作原理" class="headerlink" title="邮件服务器的功能与运作原理"></a>邮件服务器的功能与运作原理</h4><p>​        电子邮件是个啥玩意儿？它是利用网络传递一些信息给远程服务器的一种信息传递行为，虽然消息正文是很冷很硬的计算机文字， 确实比不上手写信件来的让人觉得温暖，不过，对于具有时效性的信息来说，电子邮件可是个不可多得的好帮手！ 但是，电子邮件系统蓬勃发展的现在却被某些少部分的特定人士所乱用，导致垃圾信件、色情广告信件等等的泛滥！真是啊～伤脑筋～底下我们就先来谈一谈这个电子邮件相关的功能吧！</p><p><strong>Tips</strong>:</p><p>​        时至今日，Google 与几个大型的网络公司都有提供免费或者是付费的邮件服务器，其中，免费的电子邮件账号甚至已经提供高达数个 GB 的邮件储存量！对于一般用户来说真是非常够用了！因此，除非必要，现在我们都『不建议您架设 mail server』的！ 因为玩过邮件主机的朋友都很清楚，在现在的环境当中想要搞定 Mail server 是很难的一件事情， 除了目前网络社会的广告信、垃圾信、病毒信实在是多的不象话，所以各主要的 ISP 对于邮件控管上面越来越严格， 而且基本功当中的 mail vs. DNS 相关性又太高！很难理解～</p><h5 id="电子邮件的功能与问题"><a href="#电子邮件的功能与问题" class="headerlink" title="电子邮件的功能与问题"></a>电子邮件的功能与问题</h5><p>​        在目前的社会当中，没有电子邮件 (e-mail) 似乎是蛮奇怪的一件事！可以说，现在 e-mail 已经成为一个很普遍的人与人之间的沟通管道了， 电子邮件可以很快速的帮你将文件或讯息传送到地球上的任何一个有网络存在的角落，当然，你也可以在任何有网络的地方，连上 Internet去收取你的信件！ 不过，遗憾的是，只要是有人类的地方，就会有很多你意想不到的事情会出现了， 当然 e-mail 也不例外，怎么说呢？ 我们来慢慢的分析一下电子邮件产生的一些问题吧： </p><h6 id="夹带病毒的电子邮件问题："><a href="#夹带病毒的电子邮件问题：" class="headerlink" title="夹带病毒的电子邮件问题："></a>夹带病毒的电子邮件问题：</h6><p>​        你可以常常听到电子邮件可能夹带病毒对吧！没错，利用电子邮件以及人们对于电子邮件的漫不经心的态度， 使得以电子邮件为媒介的计算机病毒更容易『深入人群』当中吶！ </p><h6 id="怪客透过邮件程序入侵："><a href="#怪客透过邮件程序入侵：" class="headerlink" title="怪客透过邮件程序入侵："></a>怪客透过邮件程序入侵：</h6><p>​        只要在 Internet 上面跑的数据就没有绝对保密的！你可以轻易的使用怪客软件 (Cracker) 就可以取得使用者在利用 e-mail 传送过程当中所输入的账号与密码，若经过分析之后，还可能破解对方的邮件主机～哇！真是乱可怕一把的！</p><h6 id="广告信与垃圾信等："><a href="#广告信与垃圾信等：" class="headerlink" title="广告信与垃圾信等："></a>广告信与垃圾信等：</h6><p>​        这个可说是目前各大 ISP 心中永远的痛～这些垃圾信件可以占掉很多那少的可怜的带宽， 使得正常用户连接速度与质量下降，更可能造成网络的停顿～当然， 常常收到垃圾信件的你，大概也不好过吧！</p><h6 id="主机被大量不明信件塞爆："><a href="#主机被大量不明信件塞爆：" class="headerlink" title="主机被大量不明信件塞爆："></a>主机被大量不明信件塞爆：</h6><p>​        万一你没有将邮件服务器设定好，嘿嘿！送信者可以藉由你主机收信的功能，发送大量的信件， 让你『一次收个够！』灌爆你的服务器硬盘，想要不宕机都很难～</p><h6 id="真实社会的讨厌情事："><a href="#真实社会的讨厌情事：" class="headerlink" title="真实社会的讨厌情事："></a>真实社会的讨厌情事：</h6><p>​        『匿名信函』！听到会不会很害怕？当然很害怕啦！偏偏使用 e-mail 就可以作很多的坏事～这真是太不道德了～</p><h6 id="不实的信件内容："><a href="#不实的信件内容：" class="headerlink" title="不实的信件内容："></a>不实的信件内容：</h6><p>​        只要注意到消基会的讯息就可以知道啦，不明来源的电子邮件说的内容，不要轻易的相信！ 因为很多可是以讹传讹，结果，大家都被耍了的～例如，你的朋友收到一封信，认为『哇！这是大事情』， 所以在没有求证的情况下，将信『转寄』给你看，嘿！你的朋友寄给你的，当然要相信他啦！ 立刻再转寄，如此一再地循环，嘿嘿！这个错误内容的讯息马上就让大家知道， 更可怕的是『还会让大家接受～』所以，看到任何讯息时，请千万要记得求证一下吶！</p><p>​        可怕吧！电子邮件会衍生出这么多的问题说～另外，这个 email 服务器的设定与管理真的是网管人员心中永远的痛！ 为什么呢？因为人都是想要越便利越简单越好， 但越便利越不管制的邮件服务器就越容易被攻击或遭利用！ 反过来说，如果你针对邮 件服务器管得太严厉，那就不太人性化，相信至少您的主管可能就不太满意，怎么办？ 呵呵！没错啦！邮件服务器就是这么回事，让人又爱又怕的一个玩意儿，搞定他， 恭喜您啊一切顺利圆满！ 搞不定他，服务器被当成垃圾信件转运站事小，丢掉工作那 可是『兹事体大』呦！就因为他是这么重要又难以搞定， 所以我们可得好好的学学他吶！</p><h5 id="Mail-server-与-DNS-之间的关系"><a href="#Mail-server-与-DNS-之间的关系" class="headerlink" title="Mail server 与 DNS 之间的关系"></a>Mail server 与 DNS 之间的关系</h5><p>​        既然要使用 e-mail ，当然就需要邮件服务器啰 (Mail Server)！不然你的信要怎样寄出去呢？事实上，mail server 的原理说难不难，但是说简单吗～似乎又有点难以理解～，所以，底下我们要来谈一谈他的原理部分，然后再针对服务器的设定来进行说明咯！我们首先要讲的就是『 Mail server 系统与 DNS 系统有什么关连性？』 这 个部分新手最容易被搞混哩，是否要架设 mail server 就『宿命』的一定得架设 DNS server 在你的主机上面吗？</p><p>​        Mail server 与合法的主机名 事实上目前已经没有人会使用 IP 来寄信了，我们通常接收到的 email 都是使用 『账号@主机名』的方式来处理的， 所以说，你的邮件服务器『就一定要有一个合法注册过的主机名』才可以。为什么呢？ 因为网络恶意使用与垃圾邮件泛滥的种种因素， 导致我们不允许直接利用主机的 IP 来寄信了，否则每部有 IP 的主机都能寄信… 因此，你想要架设 mail server 就『必需』要有合法的主机名啰。</p><p>​        OK！既然我只要一个合法的主机名即可，那么表示我不需要架设一部 DNS 主机啰？ 是的，你可以这样认为！只要你拥有合法的主机名，亦即在 DNS 的查询系统当中你的主机名拥有一个 A 的标志， 理论上你的 mail server 就可以架设成功。只不过由于目前因特网上面的广告信、 垃圾信与病毒信等占用了太多的带宽，导致整个网络社会花费过多的成本在消耗这些垃圾资料。 所以为了杜绝可恶的垃圾信件，目前的大型网络供货商 (ISP) 都会针对不明来源的邮件加以限制，这也就是说『想要架设一部简单 可以运作的 mail server 越来越难了』。</p><p>​        DNS 的反解也很重要！ 对于一般的服务器来说，我们只要使用正解让客户端可以正确的找到我们服务器的 IP 即可架站，举例来说 WWW 服务器就是这样。不过，由于目前收信端的邮件服务器会针对邮件来源的 IP 进行反解，而如果你的网络环境是由拨接取得非固定的 IP 时，该 种 IP 在 ISP 方面通常会主动的以 xxx.dynamic.xxx 之类的主机名来管理，偏偏这样的主机名会被主要的大型邮件服务器 (例如 hotmail, yahoo 等) 视为垃圾信件， 所以你的邮件服务器所发出的信件将可能被丢弃，那可就伤脑筋了！ 所以啊，如果你想要架设一部 Mail server 的话，请『务必』向您的上层 ISP 申 请 IP 反解的对应， 不要再使用预设的反解主机名，否则很容易导致您的邮件服务器 所发出的信件会在 Internet 上面流浪啊！</p><p><strong>Tips</strong>:</p><p>​        其实你还是可以不用申请 IP 的反解，不过就得要利用所谓的 relayhost 或者是 smarthost 来处理邮件转递的问题， 这个部分又涉及到上层 ISP 的问题，挺复杂！我们会在后续作说明！</p><p><strong>需要 DNS 的 MX 及 A 标志啊 (超重要的 MX)！</strong></p><p>​        那么我们的邮件服务器系统到底是如何使用 DNS 的信息来进行邮件的传递的？还 记得在 DNS 里面谈到的 MX 这个标志吗？当时我们仅说过这个 MX 代表的是 Mail exchanger， 当一封邮件要传送出去时，邮件主机会先分析那封信的『目标主机 的 DNS 』，先取得 MX 标志 (注意，MX 标志可能会有多部主机喔) 然后以最优先 MX 主 机为准将信发送出去。看不懂吗？没关系，我们以底下这个 DNS 范例来说：</p><p>xyz.com.vbird IN MX 10 mail.xyz.com.vbird </p><p>xyz.com.vbird IN MX 20 mail2.xyz.com.vbird </p><p>xyz.com.vbird IN A aaa.bbb.ccc.ddd</p><p>假如上述的 DNS 设定是正常的，那么： </p><p>​        当有一封信要传给 <a href="mailto:&#117;&#115;&#x65;&#x72;&#64;&#120;&#x79;&#x7a;&#46;&#x63;&#111;&#109;&#x2e;&#118;&#98;&#x69;&#114;&#x64;">&#117;&#115;&#x65;&#x72;&#64;&#120;&#x79;&#x7a;&#46;&#x63;&#111;&#109;&#x2e;&#118;&#98;&#x69;&#114;&#x64;</a> 时，由于 MX 标志最低者优先，所以该封信会先传送到 mail.xyz.com.vbird 那部主机。</p><p>​        如果 mail.xyz.com.vbird 由于种种原因，导致无法收下该封信时，该封信将以次要 MX 主机来传送，那就是传送到 mail2.xyz.com.vbird 那部主机上头；</p><p>​        如果两部 MX 主机都无法负责的话，那么该封信会直接以 A 的标志，亦即直接传送到 aaa.bbb.ccc.ddd 那个 IP 上头去， 也就是 xyz.com.vbird 本身 啦！</p><p>​        在这个过程当中，你必需要注意到：mail.xyz.com.vbird 及 mail2.xyz.com.vbird 必需要是可以帮 xyz.com.vbird 转信的主机才行，也就是说，那两部主机通常是你公司的最上游的邮件主机， 并不是你随意填写的！那两部主机还需要针对你的 xyz.com.vbird 来设定『邮件转递』才行！否则你的信会被踢掉的。</p><p>​        由于现在的很多邮件服务器会去搜寻 MX 这个标志来判断目标邮件服务器是否为合法，所以你要架设 Mail server 虽然不必自行设定 DNS 服务器，不过你最好要申请 一个 MX 的标志才行。此外，MX 标志一定要设定正确，否则你的信件将可能会直接被 MX服务器踢掉。为了要设定 MX 但是我们没有上层邮件服务器时，所以你可以指定 MX 为 自己，利用自己当 MX 服务器即可。</p><p>​        那么你或许会想，这个 MX 有啥好处啊？一般来说，如果目标主机挂点时，你的邮件通常会直接退还给原发信者， 但如果有 MX 主机时，这部 MX 主机会先将该封信放 在他的队列 (queue) 当中，等到你的目标主机重新提供邮件服务后， MX 主机会将你 的信件传送给目标主机，如此一来你的信件就比较不会遗失啊！这样说，您可以了解吧！ ^_^</p><p><strong>Email 的地址写法</strong></p><p>​        刚刚上头说过 email 通常是『账号@主机名』的方式来处理，举例来说鸟哥的 <a href="http://www.centos.vbird/">www.centos.vbird</a> 主机上面有个 dmtsai 的使用者，则我的 email 将会成为： 『<a href="mailto:&#100;&#x6d;&#x74;&#x73;&#97;&#x69;&#64;&#x77;&#x77;&#119;&#46;&#99;&#x65;&#x6e;&#x74;&#111;&#x73;&#x2e;&#118;&#98;&#x69;&#114;&#x64;">&#100;&#x6d;&#x74;&#x73;&#97;&#x69;&#64;&#x77;&#x77;&#119;&#46;&#99;&#x65;&#x6e;&#x74;&#111;&#x73;&#x2e;&#118;&#98;&#x69;&#114;&#x64;</a>』，当有人要寄信给我时， 他会分析 @ 后面的主机名， 亦即 <a href="http://www.centos.vbird/">www.centos.vbird</a> 的 MX/A 标志等等，然后再透过刚刚说明的流程来传出信件。</p><p>而当我的 <a href="http://www.centos.vbird/">www.centos.vbird</a>. 收到这封信时，他会将信放到 dmtsai 的信箱当中啦！ 底下我们就来谈一谈这个流程吧！</p><h5 id="邮件传输所需要的组件-MTA-MUA-MDA-以及相关协议"><a href="#邮件传输所需要的组件-MTA-MUA-MDA-以及相关协议" class="headerlink" title="邮件传输所需要的组件 (MTA, MUA, MDA) 以及相关协议"></a>邮件传输所需要的组件 (MTA, MUA, MDA) 以及相关协议</h5><h6 id="邮件传输所需要的组件-MTA-MUA-MDA-以及相关协议-1"><a href="#邮件传输所需要的组件-MTA-MUA-MDA-以及相关协议-1" class="headerlink" title="邮件传输所需要的组件 (MTA, MUA, MDA) 以及相关协议"></a>邮件传输所需要的组件 (MTA, MUA, MDA) 以及相关协议</h6><p>在开始介绍邮件的传送过程之前，我们先来想一想，你是如何寄出电子邮件的？假设你要寄信给一个用户， 他的电子邮件是『<a href="mailto:&#97;&#x5f;&#x75;&#x73;&#x65;&#114;&#64;&#103;&#x6d;&#97;&#x69;&#x6c;&#x2e;&#x63;&#111;&#x6d;">&#97;&#x5f;&#x75;&#x73;&#x65;&#114;&#64;&#103;&#x6d;&#97;&#x69;&#x6c;&#x2e;&#x63;&#111;&#x6d;</a>』好了，也就是说，你要寄一封信到 gmail.com 这个主机上的意思。 那你的桌面计算机 (举例来说， Windows 系统) 是否能够将这封信『直接』透过网络送给 gmail.com 那个主机上？ 当然不行啦！你得要设定帮你转信的邮件服务器才行！也就是说，你必需要先向某一部邮件服务器注册， 以取得一个合法的电子邮件权限后，才能够发送邮件出去的。 所以说，你要寄出一封信件时是需要很多接口的帮忙的，底下列出一个简单的图示来说明</p><p><a href="https://imgtu.com/i/Iy57r9"><img src="https://z3.ax1x.com/2021/11/13/Iy57r9.png" alt="Iy57r9.png"></a></p><p>电子邮件的『传送』过程示意图</p><p>我们先来解释一些专有名词吧！然后再来说明传送的流程：</p><ul><li>MUA (Mail User Agent)：</li></ul><p>顾名思义 MUA 就是『邮件使用者代理人』的意思，因为除非你可以直接利用类似 telnet 之类的软件登入邮件服务器来主动发出信件，否则您就得要透过 MUA 来帮你送信到邮件服务器上头去。 最常见的 MUA 像是 Mozilla 推出的 Thunderbird (雷鸟) 自由软件， 或者是 Linux 桌面 KDE 常见的 Kmail ，及 Windows 内件的 Outlook Express (OE) 等。 MUA 主要的功能就是收受邮件主 机的电子邮件，以及提供用户浏览与编写邮件的功能！</p><ul><li>MTA (Mail Transfer Agent)：</li></ul><p>MUA 帮用户传送邮件到邮件主机上，那这部邮件主机如果能够帮用户将这封信寄出去，那他就是一部邮件传送主机 (MTA) 啦！这个MTA 就是『邮件传送代理人』的意思。也来顾名思义一下，既然是『传送代理人』，那么使用者寄出的信， 帮用户将属于该用户的信件收下时，就是找它 (MTA) 就对啦！基本上，MTA 的功能有这些：</p><ol><li><p>收受信件：</p><p>使用简单邮件传送协议(SMTP) MTA 主机最主要的功能就是：将来自客户端或者是其他 MTA 的来信收下来，这个时候 MTA 使用的是 Simple Mail Transfer Protocol (SMTP)， 他使用的是 port 25 啦！</p></li><li><p>转递信件：</p><p>如果该封信件的目的地并不是本身的用户，且该封信的相关数据符合使用 MTA 的权力， 那么咱们的 MTA 就会将该封信再传送到下一部主机上。这即是所谓的转递 (Relay) 的功能。 总之，我们一般提到的 Mail Server 就是 MTA 啦！而严格来说， MTA 其实仅是指 SMTP 这个协议而已。而达成 MTA 的 SMTP 功能的主要软件包括老牌 的 sendmail，后起之秀的 postfix，还有 qmail 等等。底下我们来看看，那么在 MTA 上头还有哪些重要的功能。</p></li></ol><ul><li>MDA (Mail Delivery Agent)：</li></ul><p>字面上的意思是『邮件递送代理人』的意思。事实上，这个 MDA 是挂在 MTA 底下的一个小程序， 最主要的功能就是：分析由 MTA 所收到的信件表头或内容等数据， 来决定这封邮件的去向。所以说，上面提到的 MTA 的信件转递功能，其实是由 MDA 达成的。 举例来说，如果 MTA 所收到的这封信目标是自己，那么 MDA 会将这封信给他转到使用者的信箱 (Mailbox) 去， 如果不是呢？那就准备要转递出去了。此外，MDA 还有分析与过滤邮件的功能喔！举例来说：</p><ol><li><p>过滤垃圾信件：</p><p>可以根据该封邮件的表头资料，或者是特定的信件内容来加以分析过滤。 例如某个广告信的主题都是固定的， 如『AV 情色…』等等，那就可以透过 MDA 来过滤并去除该邮件。</p></li><li><p>自动回复：</p><p>如果您出差了导致某一段时间内无法立即回信时，就可以透过 MDA 的功能让邮件主机可以自动发出回复信件， 如此您的朋友就不会认为你太大牌！^_^</p></li></ol><p>各主要的 MTA 程序 (sendmail,postfix…) 都有自己的 MDA 功能，不过有些外挂的程序功能更强大，举例来说 procmail 就是一个过滤的好帮手，另外 Mailscanner + Spamassassion 也是可以使用的一些 MDA 喔。</p><ul><li> Mailbox：</li></ul><p>就是电子邮件信箱嘛！简单的说，就是某个账号专用的信件收受档案啰。我们的 Linux 系统默认的信箱都是放在 /var/spool/mail/使用者账号中！ 若 MTA 所收到的信件是本机的使用者，MDA 就会将信件送到该 mailbox 当中去啰！ 好了，那么来想一想，你如何透过 MUA 来将信件送到对方的邮件信箱 (Mailbox)去呢？</p><ol><li><p>取得某部 MTA 的权限： 我们本地端的 MUA 想要使用 MTA 来传出信件时， 当然需要取得 MTA 的权限。通常就是说：我们必须要向 MTA 注册一组可使用 email 的账号与密码才行。</p></li><li><p>使用者在 MUA 上编写信件后，传送至 MTA 上头： 用户在 MUA 上面编写信件，信件的数据主要有： </p><ul><li>信件标头：包括发件人与收件者的 email 地址，还有该封信件的主旨 (subject) 等；</li><li>信件内容：就是你要跟对方说明的内容啦！</li></ul></li></ol><p>编写完毕之后只要按下传送钮，该封信就会送至你的 MTA 服务器上面了，注意： 是你的 MTA 而不是对方的 MTA ！ 如果你确定可以使用该部 MTA，那么你的这封信就会被放置到 MTA 的队列 (queue) 当中并等待传送出去了。</p><ol start="3"><li><p>如果该封信的目标是本地端 MTA 自己的账号：</p><p>你是可以寄信给你自己的，所以如果你的 MTA 收到该封信件的目标是自己的用户时，那就会透过 MDA 将这封信送到 Mailbox 去啰！</p></li><li><p>如果该封信目的为其他 MTA ，则开始转递 (Relay) 的流程：</p><p>那如果这封信的目标是其他的主机呢？这个时候我们的 MTA 就会开始分析该封信是否具有合法的权限， 若具有权限时，则我们的 MDA 会开始进行邮件转递，亦即该封信件会透过我们的 MTA 向下一部 MTA 的 smtp (port 25) 发送出去。 如果该封信件顺利的发送出去了，那么该封信件就会由队列当中移除掉了。</p></li><li><p>对方 MTA 服务器收受信件</p></li></ol><p>如果一切都没有问题的话，远程的 MTA 会收到我们 MTA 所发出的那封信，并将该信件放置到正确的使用者信箱当中， 等待使用者登入来读取或下载。 在这整个过程当中，你会发现你的信件是由我们的 MTA 帮忙发送出去的，此时 MTA 提供的协议是简单邮件传输协议 (Simple Mail Transfer Protocol, smtp)， 并且该封信最终是停留在对方主机的 MTA 上头！并不是你朋友的 MUA 上头啊！</p><p><strong>Tips</strong>:</p><p>为何特别强调这一点？因为以前有个朋有跟我说：『鸟哥啊，你要 寄 email 给我的时候记得跟我讲， 那我下班前将计算机开着，以免你信寄不到我的信箱』，此时额头三条线突然跑出来～很不好意 思～ 所以这里才要特别强调，你的 MUA 不必开着啦！要收信时再打开即可。 了解了传送信件时 MTA 需要启动 smtp (port 25) 之后，再来我们得要谈谈那这封信件对方要如何接收啊？</p><h5 id="使用者收信时服务器端所提供的相关协议：-MRA"><a href="#使用者收信时服务器端所提供的相关协议：-MRA" class="headerlink" title="使用者收信时服务器端所提供的相关协议： MRA"></a>使用者收信时服务器端所提供的相关协议： MRA</h5><p>​        那使用者如果想要收信时，当然也可以透过 MUA 直接来联机取得自己的邮件信箱内的数据啊！整个过程有点像底下这样：</p><p><a href="https://imgtu.com/i/Iy7wZj"><img src="https://z3.ax1x.com/2021/11/13/Iy7wZj.png" alt="Iy7wZj.png"></a></p><p>客户端透过 MRA 收回信件的流程示意图</p><p>在上述的图示中，多了一个邮件组件，那就是 MRA：</p><ul><li>MRA (Mail Retrieval Agent)：</li></ul><p>使用者可以透过 MRA 服务器提供的邮政服务协议 (Post Office Protocol, POP) 来收下自己的信件， 也可以透过 IMAP (Internet Message Access Protocol) 协议将自己的信件保留在邮件主机上面， 并进一步建立邮件数据匣等进阶工作。 也就是说，当客户端收受信件时，使用的是 MRA 的 POP3, IMAP 等通讯协议， 并非 MTA 的 SMTP 喔！ 我们先谈一谈 POP3 的收信方式吧：</p><ol><li><p>MUA 透过 POP3 (Post Office Protocol version 3) 的协议连接到 MRA 的 port 110， 并且输入账号与密码来取得正确的认证与授权；</p></li><li><p>MRA 确认该用户账号/密码没有问题后，会前往该使用者的 Mailbox (/var/spool/mail/使用者账号) 取得使用者的信件并传送给用户的 MUA 软件 上；</p></li><li><p>当所有的信件传送完毕后，用户的 mailbox 内的数据将会被删除！ 在上述的流程当中我们知道 MRA 必须要启动 POP3 这个协议才行，不过这个协议的收件方式比较有趣， 因为使用者收信是由第一封信件开始收下直到最后一封信件传输完毕为止。不过由于某些 MUA 程序撰写的问题，若有些邮件有病毒的可能性时，透 过防病毒软件将可能导致该 MUA 软件的断线！ 如此一来由于传输没有完毕，因此 MRA 主机并不会将用户的信件删除。 此时如果使用者又再一次的按下接收按键，呵呵！原 来已接收的信件又会重复收到，而没有收到的还是收不到！</p><p>这个时候或许你可以透过登入主机利用 mail 这个指令来处理你有问题的邮件， 或许换一种 MUA 也是个不错的思考方向，又或者暂时将防病毒软件关掉也是可以考虑的手段之一。 转头过来想一想，因为 POP3 的协议预设会将信件删除，那如果我今天在办公室将我的信收到办公室的计算机中， 当我回家时再度启动 MUA 时，是否能够收到已经被接收的信件？当然不行，对吧！</p><p>或许你需要更有帮助的协议，亦即 IMAP (Internet Messages Access Protocol) ， 这个协议可以让你将 mailbox 的数据转存到你主机上的家目录，亦即 /home/账号/ 那 个目录下， 那你不但可以建立邮件数据匣，也可以针对信件分类管理，而且在任何一 个可连上网络的地方你只要登入主机， 原本的信件就还是存在吶！真是好啊！ 不过，使用 IMAP 时，用户的目录最好能够加点限制，例如利用 quota 来管理用户的硬盘权限， 否则因为信件都在主机上头，如果用户过多且误用时，你的硬盘空间会被吃光光喔！注意注意！</p></li></ol><p>OK！透过上面的说明你要知道，要架设一部可以使用 MUA 进行收发信件的 MTA, MRA 服务器，你至少也需要启动 SMTP 以及 POP3 这两个协议才行！而这两个协议的启动程序并不相同， 所以架设上还是得要小心注意啊！</p><p>​        pop3s, imap2 与 SMTP 的困扰 邮件数据在因特网上面传输时，透过的 SMTP, POP3, IMAP 等通讯协议，通通是明码传输的！尤其 POP3, IMAP 这两个通讯协议中，使用者必须要输入账号/密码才能收受信件！因为涉及帐密，所以当然加密这两个通讯协议的数据较佳！ 于是就有了 POP3s, IMAPs 通讯协议出现了！透过 SSL 加密嘛！那你会问，既然已经有 pop3s, imaps 了， 那有没有 smtps 呢？答案是，当然有！只不过没人用！</p><p>​        从面两张图的流程来看，POP3, IMAP 只与 MRA 及自己的用户有关， 因此你只要跟你的用户说，你服务器使用的 MRA 协议为何，通知你的用户改变即可， 并不会影响到其他的服务器。 但是 MTA 就不同了！因为 MTA 必须与其他的 MTA 沟 通，</p><p>​        因此，若你使用了 smtps ，那么全世界与你的 MTA 沟通者， 通通需要改变为 smtps 通讯协议才行！这个工程实在太浩大了！目前还没有任何一家 ISP 有能力进行！ 所以， 就造成目前没有 SMTPs 的协议啰。</p><p>​        那么难道你的数据就一定要是明码吗？那倒不见得～既然你的 MTA 无法加密，那么你就自己将邮件数据加密后，再交由 MTA 传送即可！这也是目前很多急需加密数据 的邮件用户所使用的手段啦！^_^</p><h5 id="Relay-与认证机制的重要性"><a href="#Relay-与认证机制的重要性" class="headerlink" title="Relay 与认证机制的重要性"></a>Relay 与认证机制的重要性</h5><p>​        当你需要 MTA 帮你将信寄送到下一部 MTA 去时，这个动作就称为邮件转递 (Relay) 啰，那就是电子邮件的『传送』过程示意图 当中的 Step 2.2 那个动作啦。那么我们来想一想，如 果『所有的人都可以藉由这一部 MTA 帮忙进行 Relay 时， 这个情况称之为 Open Relay 的动作』。当你的 MTA 发生 Open Relay 时，会有什么问题？ 问题可就大了！ 当你的 MTA 由于设定不良的关系导致具有 Open Relay 的状况，加上你的 MTA 确 实是连上因特网时， 由于因特网上面用 port scan 软件的闲人太多，你的 MTA 具有 Open Relay 的功能这件事情， 将会在短时间内就被很多人察觉，此时那些不法的广告信、色情垃圾信业者将会利用你的这部 Open Relay MTA 发送他们的广告，所以你会发生的问题至少有：</p><ul><li><p>你主机所在的网域正常使用的连接速度将会变慢，因为网络带宽都被广告、 垃圾信吃光了；</p></li><li><p>你的主机可能由于大量发送信件导致主机资源被耗尽，容易产生不明原因当机之类的问题；</p></li><li><p>你的 MTA 将会被因特网社会定义为『黑名单』，从此很多正常的邮件就会无法收发；</p></li><li><p>你 MTA 所在的这个 IP 将会被上层 ISP 所封锁，直到你解决这个 Open Relay 的问题为止；</p></li><li><p>某些用户将会对你的能力产生质疑，对您公司或者是你个人将会有信心障碍！ 甚至可能流失客源；</p></li><li><p>如果你的 MTA 被利用来发黑函，你是找不到原发信者的，所以你这部 MTA 将会被追踪为最终站！</p></li></ul><p>问题很大呦！所以啊，目前所有的 distributions 都一样，几乎都将 MTA 预设启动为仅监听内部循环接口 (lo) 而已，而且也将 Open Relay 的功能取消了。既然取消 Open Relay 的功能，那么怎么使用这部 MTA 的 Relay 来帮忙转信啊？呵呵！所以我们在上头才会一直说，你『必需』取得合法使用该 MTA 的权限啊！ 这也就是说，设定 谁可以使用 Relay 的功能就是我们管理员的任务啦！通常设定 Relay 的方法有这几种：</p><ul><li><p>规定某一个特定客户端的 IP 或网段，例如规定内部 LAN 的 192.168.1.0/24 可使用 Relay；</p></li><li><p>若客户端的 IP 不固定时 (例如拨接取得的非固定 IP) 可以利用认证机制来处理。</p></li><li><p>将 MUA 架设在 MTA 上面，例如 OpenWebMail 之类的 web 接口的 MUA 功能。</p></li></ul><p>认证机制上面常见的有 SMTP 邮件认证机制，以及 SMTP after POP 两种，不论是 哪一种机制， 基本上都是透过让使用者输入认证用的账号与密码，来确定他有合法使 用该 MTA 的权限，然后针对通过认证者开启 Relay 的支持就是了。如此一来你的 MTA不再启动 Open Relay ，并且客户端还是可以正常的利用认证机制来收发信件， 身为 管理员的你可就轻松多啰！ ^_^</p><h5 id="电子邮件的数据内容"><a href="#电子邮件的数据内容" class="headerlink" title="电子邮件的数据内容"></a>电子邮件的数据内容</h5><p>看过上头的数据后，您应该对于 Mail server 有一些程度的认识了。再来要谈的是，那么一封 email 的内容有哪些部分呢？就跟人类社会的邮件有信封袋以及内部的信纸一样，email 也有所谓的标头 (header) 以及内容 (body) 两部份喔！ email 的标头部分 (类似邮件信封) 会有几个重要信息，包括：这封信来自那个 MTA、是由谁所发送出来的、要送给谁、 主旨为何等等，至于内容 (类似信封内的信纸) 则是发信者所填写的一些说明啰。如果你使用 dmtsai 的身份下达这个指令： </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[dmtsai@www ~]$ <span class="built_in">echo</span> <span class="string">&quot;HaHa..&quot;</span> | mail -s <span class="string">&quot;from vbird&quot;</span> dmtsai</span><br></pre></td></tr></table></figure><p>然后将自己的信箱内容叫出来，如下所示：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[dmtsai@www ~]$ cat /var/spool/mail/dmtsai</span><br><span class="line">From dmtsai@www.centos.vbird Mon Aug 8 18:53:32 2011 &lt;==发信者的email</span><br><span class="line">Return-Path: &lt;dmtsai@www.centos.vbird&gt; &lt;==这封信的来源</span><br><span class="line">X-Original-To: dmtsai</span><br><span class="line">Delivered-To: dmtsai@www.centos.vbird</span><br><span class="line">Received: by www.centos.vbird (Postfix, from userid 2007)</span><br><span class="line">id 6D1C8366A; Mon, 8 Aug 2011 18:53:32 +0800 (CST) &lt;==邮件ID</span><br><span class="line"><span class="comment"># 这部份主要在讲这封 email 的来源与目标收件者 MTA 在哪里的信息～</span></span><br><span class="line">Date: Mon, 08 Aug 2011 18:53:32 +0800 &lt;==收到信件的日期</span><br><span class="line">To: dmtsai@www.centos.vbird &lt;==收件者是谁啊！</span><br><span class="line">Subject: from vbird &lt;==就是信件标题</span><br><span class="line">User-Agent: Heirloom mailx 12.4 7/29/08</span><br><span class="line">MIME-Version: 1.0</span><br><span class="line">Content-Type: text/plain; charset=us-ascii</span><br><span class="line">Content-Transfer-Encoding: 7bit</span><br><span class="line">Message-Id: &lt;20110808105332.6D1C8366A@www.centos.vbird&gt; &lt;==给机器看的邮件 ID</span><br><span class="line">From: dmtsai@www.centos.vbird &lt;==发信者是谁啊！</span><br><span class="line">HaHa..</span><br></pre></td></tr></table></figure><p>由原本的信件内容我们可以看到 email 确实是两部份，在标头部分记录了比较详细的收、发件者数据， 以及相关的来源、目标之 MTA 信息等等。但你要注意的是，那个 『Received:…』那一行资料是『会变动的』， 如同前面谈到的 MX 标志，如果一封信由 MUA 传送到 MTA 在由 MTA 传送到 MX 主机后，才传送到最终的 MTA 时， 那么这个 Received: 的数据将会记录每一部经手过的 MTA 信息喔！所以你可以借着这个记录数据慢慢的找回这封信的传递方向呢！</p><p>此外，这个邮件的标头以及内容的分析部分，你还可以藉由某些分析软件来进行过 滤， 这部份我们将在后头再慢慢的介绍给大家了解喔！ ^_^！您先知道一封邮件至少 有这些数据，以后咱们再慢慢的解释啰！</p><h4 id="MTA-服务器：-Postfix-基础设定"><a href="#MTA-服务器：-Postfix-基础设定" class="headerlink" title="MTA 服务器： Postfix 基础设定"></a>MTA 服务器： Postfix 基础设定</h4><p>可达成 MTA 的服务器软件非常多，例如我们的 CentOS 预设就提供了数十年老牌 子的 sendmail (<a href="http://www.sendmail.org/">http://www.sendmail.org</a>) 以及近期以来很热门的 Postfix (<a href="http://www.postfix.org).虽然/">http://www.postfix.org)。虽然</a> sendmail 曾是最为广泛使用的 mail server 软件， 但由于 sendmail 的配置文件太过于难懂，以及早期的程序漏洞问题导致的主机安全性 缺失；加上 sendmail 将所有的功能都统合在 /usr/sbin/sendmail 这个程序当中，导 致程序太大可能会有效能方面的疑虑等等， 所以新版的 CentOS 已经将预设的 mail server 调整为 postfix 啰！我们这里也主要介绍 postfix。当然啦，原理方面都一样， 您也可以自己玩玩其他的 mail server。</p><h5 id="Postfix-的开发"><a href="#Postfix-的开发" class="headerlink" title="Postfix 的开发"></a>Postfix 的开发</h5><p>​        Postfix 是由 Wietse Zweitze Venema 先生(<a href="http://www.porcupine.org/wietse">http://www.porcupine.org/wietse</a>) 所发展的。早期的 mail server 都是使用 sendmail 架设的，还真的是『仅此一家， 绝无分号』！不过，Venema 博士觉得 sendmail 虽然很好用，但是毕竟不够安全，尤 其效能上面并不十分的理想，最大的困扰是…sendmail 的配置文件 sendmail.cf 真 的是太难懂了！对于网管人员来说，要设定好 sendmail.cf 这个档案，真不是人作的 工作。</p><p>​        为了改善这些问题， Venema 博士就在 1998 年利用他老大在 IBM 公司的第一个休假年进行一个计划：『 设计一个可以取代 sendmail 的软件套件，可以提供网站管理员一个更快速、 更安全、而且完全兼容于 sendmail 的 mail server 软件！』这个计划还真的成功了！ 而且也成功的使用在 IBM 内部，在 IBM 内可以说是完全取代了 sendmail 这个邮件服务器！在这个计划成功之后， Venema 博士也在1998 年首次释出这个自行发展的邮件服务器，并定名为 VMailer。</p><p>​        不过，IBM 的律师却发现一件事，那就是 VMailer 这个名字与其他已注册的商标很类似， 这样可能会引起一些注册上面的困扰。为了避免这个问题，所以 Venema 博士就将这个邮件软件名称改为 Postfix ！</p><p>『Post 有在什么什么之后』的意思，『fix 则 是修订』的意思，所以 postfix 有 『在修订之后』的意思。</p><p>​        鸟哥个人认为， Venema 先生最早的构想并不是想要『创造一个全新的 Mail server 软件，而是想要制造一个可以完全兼容于 sendmail 的软件』，所以，Venema 先 生认为他自行发展的软件应该是『改良 sendmail 的缺失』，所以才称为 Postfix 吧！ 取其意为： 『改良了 sendmail 之后的邮件服务器软件！』</p><p>​        所以啦，Postfix设计的理念上面，主要是针对『想要完全兼容于sendmail』所设计出来的一款『内在部分完全新颖』的一个邮件服务器软件。就是由于这个理念，因此Postfix改善了sendmail安全性上面的问题，改良了mailserver的工作效率，且让配置文件内容更具亲和力！因此，你可以轻易的由sendmail转换到Postfix上面！这也是当初Venema博士的最初构想啊！</p><p>​        就是基于这个构想，所以Postfix在外部配置文件案的支持度，与sendmail几乎没有两样，同样的支持aliases这个档案，同样的支持~/.forward这个档案，也同样的支持SASL的SMTP邮件认证功能等等！所以，呵呵！赶紧来学一学怎样架设Postfix这个相当出色的邮件服务器吧！^_^</p><h5 id="所需要的软件与软件结构"><a href="#所需要的软件与软件结构" class="headerlink" title="所需要的软件与软件结构"></a>所需要的软件与软件结构</h5><p>由于CentOS6.x预设就是提供postfix的！所以根本无须调整啥咚咚～直接来使用吧！那么postfix有哪些重要的配置文件呢？他主要的配置文件都在/etc/postfix/当中，详细的档案内容就让我们来谈谈：</p><ul><li>/etc/postfix/main.cf</li></ul><p>这就是主要的postfix配置文件啰，几乎所有的设定参数都是在这个档案内规范的！这个档案预设就是一个完整的说明档了，你可以参考这个档案的内容就设定好属于你的postfixMTA呢！只要修改过这个档案，记得要重新启动postfix喔！</p><ul><li>/etc/postfix/master.cf</li></ul><p>主要规定了postfix每个程序的运作参数，也是很重要的一个配置文件。不过这个档案预设已经很OK了，通常不需要更改他。</p><ul><li>/etc/postfix/access (利用 postmap 处理)</li></ul><p>可以设定开放Relay或拒绝联机的来源或目标地址等信息的外部配置文件，不过这个档案要生效还需要在/etc/postfix/main.cf启动这个档案的用途才行。且设定完毕后需要以postmap来处理成为数据库档案呢！</p><ul><li>/etc/aliases (利用 postalias 或 newaliases 均可)</li></ul><p>做为邮件别名的用途，也可以作为邮件群组的设定喔！ 至于常见的执行档则有底下这些：</p><ul><li>/usr/sbin/postconf (查阅 postfix 的设定数据)</li></ul><p>这个指令可以列出目前你的 postfix 的详细设定数据，包括系统默认值也会被列出来， 所以数据量相当的庞大！如果你在 main.cf 里面曾经修改过某些预设 参数的话，想要仅列出非默认值的设定数据， 则可以使用『postconf -n』这个 选项即可。</p><ul><li>/usr/sbin/postfix (主要的 daemon 指令)</li></ul><p>此为 postfix 的主要执行档，你可以简单的使用他来启动或重新读取配置文件： </p><p>[root@www ~]# postfix check &lt;==检查 postfix 相关的档案、权限等是否正确！ </p><p>[root@www ~]# postfix start &lt;==开始 postfix 的执行 </p><p>[root@www ~]# postfix stop &lt;==关闭 postfix </p><p>[root@www ~]# postfix flush &lt;==强制将目前正在邮件队列的邮件寄出！ </p><p>[root@www ~]# postfix reload &lt;==重新读入配置文件，也就是</p><ul><li>/etc/postfix/main.cf</li></ul><p>要注意的是，每次更动过 main.cf 后，务必重新启动 postfix，可简单的使用 『postfix reload』即可。不过老实说，鸟哥还是习惯使用 /etc/init.d/postfix reload..</p><ul><li>/usr/sbin/postalias</li></ul><p>设定别名数据库的指令，因为 MTA 读取数据库格式的档案效能较佳，所以我们 都会将 ASCII 格式的档案重建为数据库。 在 postfix 当中，这个指令主要在 转换 /etc/aliases 成为 /etc/aliases.db 啰！用法为：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@www ~]<span class="comment"># postalias hash:/etc/aliases</span></span><br><span class="line"><span class="comment"># hash 为一种数据库的格式，然后那个 /etc/aliases.db 就会自动被更新啰！</span></span><br></pre></td></tr></table></figure><ul><li>/usr/sbin/postcat</li></ul><p>主要用在检查放在queue(队列)当中的信件内容。由于队列当中的信件内容是给MTA看的，所以格式并不是一般我们人类看的懂的文字数据。所以这个时候你得要用postcat才可以看出该信件的内容。在/var/spool/postfix内有相当多的目录，假设内有一个文件名为/deferred/abcfile，那你可以利用底下的方式来查询该档案的内容喔：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@www ~]<span class="comment"># postcat /var/spool/postfix/deferred/abcfile</span></span><br></pre></td></tr></table></figure><ul><li>/usr/sbin/postmap</li></ul><p>这个指令的用法与 postalias 类似，不过他主要在转换 access 这个档案的数据库啦！用法为：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@www ~]<span class="comment"># postmap hash:/etc/postfix/access</span></span><br></pre></td></tr></table></figure><ul><li>/usr/sbin/postqueue</li></ul><p>类似mailq的输出结果，例如你可以输入『postqueue-p』看看就知道了！整个postfix的软件结构大致上是这个样子的，接下来让我们先来简单的处理一下postfix的收发信件功能吧！</p><h5 id="一个邮件服务器的设定案例"><a href="#一个邮件服务器的设定案例" class="headerlink" title="一个邮件服务器的设定案例"></a>一个邮件服务器的设定案例</h5><p>前面谈到mailserver与DNS系统有很大的相关性，所以如果你想要架设一部可以连上Internet的邮件服务器时，你必需要已经取得合法的A与MX主机名，而且最好反解也已经向您的ISP申请修改设定了，这可是个大前提！不要忽略他！在底下的练习当中以之前DNS内的设定为依据，主要的参数是这样的：</p><p>邮件服务器的主要名称为：<a href="http://www.centos.vbird/">www.centos.vbird</a><br>邮件服务器尚有别名为linux.centos.vbird及ftp.centos.vbird也可以收发信件；<br>此邮件服务器已有MX设定，直接指向自己(<a href="http://www.centos.vbird/">www.centos.vbird</a>)<br>这个<a href="http://www.centos.vbird有个a的标志指向192.168.100.254./">www.centos.vbird有个A的标志指向192.168.100.254。</a></p><p>在实际的邮件服务器设定当中，上述的几个标志是很重要的，请自行参考DNS章节的介绍吧！底下就让我们来实际设定postfix服务器啰！</p><h5 id="让-Postfix-可监听-Internet-来收发信件"><a href="#让-Postfix-可监听-Internet-来收发信件" class="headerlink" title="让 Postfix 可监听 Internet 来收发信件"></a>让 Postfix 可监听 Internet 来收发信件</h5><p>在预设的情况下，CentOS6.x的MTA仅针对本机进行监听，不相信吗？测测看：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@www ~]<span class="comment"># netstat -tlnp | grep :25 </span></span><br><span class="line">Proto Recv-Q Send-Q Local Address Foreign Address State</span><br><span class="line">PID/Program name tcp 0 0 127.0.0.1:25 0.0.0.0:* LISTEN </span><br><span class="line">3167/master</span><br></pre></td></tr></table></figure><p>所以如果你要对整个Internet开放的话，就得要努力的搞定几个简单的设定啰！而几乎所有的设定你都可已经由/etc/postfix/main.cf这个档案搞定！修改前你需要注意的项目有：</p><p>『#』符号是批注的意思；</p><ul><li><p>所有设定值以类似『变量』的设定方法来处理，例如myhostname=<a href="http://www.centos.vbird,请注意等号的两边要给予空格符喔,且第一个字符不可以是空白,亦即『my..』要由行首写起;/">www.centos.vbird，请注意等号的两边要给予空格符喔，且第一个字符不可以是空白，亦即『my..』要由行首写起；</a></p></li><li><p>可以使用『$』来延伸使用变量设定，例如myorigin=$myhostname，会等于myorigin=<a href="http://www.centos.vbird;/">www.centos.vbird；</a></p></li><li><p>如果该变量支持两个以上的数据，则使用空格符来分隔，不过建议使用逗号加空格符『,』来处理。例如：mydestination=$myhostname,$mydomain,linux.centos.vbird，意指mydestination支持三个数据内容之意。</p></li><li><p>可使用多行来表示同一个设定值，只要在第一行最后有逗号，且第二行开头为空格符，即可将数据延伸到第二行继续书写(所以刚刚第二点才说，开头不能留白！)；</p></li><li><p>若重复设定某一项目，则以较晚出现的设定值为准！</p></li></ul><p>要让你的 postfix 可以收发信件时，你必需要启动的设定数据有底下这些喔：</p><ul><li><p>myhostname：设定主机名，需使用FQDN喔这个项目在于设定你的主机名，且这个设定值会被后续很多其他的参数所引用，所以必须要设定正确才行。你应该要设定成为完整的主机名。在的这个练习当中，应该设定为：myhostname=<a href="http://www.centos.vbird才对.除了这个设定值之外,还有一个mydomain的设定项目,这个项目默认会取$myhostname第一个『.』之后的名称.举例来说上头设定完毕后,预设的mydomain就是centos.vbird啰!你也可以自行设定他./">www.centos.vbird才对。除了这个设定值之外，还有一个mydomain的设定项目，这个项目默认会取$myhostname第一个『.』之后的名称。举例来说上头设定完毕后，预设的mydomain就是centos.vbird啰！你也可以自行设定他。</a></p></li><li><p>myorigin：发信时所显示的『发信源主机』项目这个项目在设定『邮件头上面的mailfrom的那个地址』，也就是代表本MTA传出去的信件将以此设定值为准喔！如果你在本机寄信时忘记加上Mailfrom字样的话，那么就以此值为准了。默认这个项目以$myhostname为主的，例如：myorigin=$myhostname</p></li><li><p>inet_interfaces：设定postfix的监听接口(极重要)在预设的情况下你的Postfix只会监听本机接口的lo(127.0.0.1)而已，如果你想要监听整个Internet的话，请开放成为对外的接口，或者是开放给全部的接口，常见的设定方法为：inet_interfaces=all才对！由于如果有重复设定项目时，会以最晚出现的设定值为准，所以最好只保留一组inet_interfaces的设定喔！</p></li><li><p>inet_protocols：设定postfix的监听IP协议 预设CentOS的postfix会去同时监听IPv4,IPv6两个版本的IP，如果你的网络环境里面仅有IPv4时，那可以直接指定inet_protocols=ipv4就会避免看到:::1之类的IP出现呦！</p></li><li><p>mydestination：设定『能够收信的主机名』(极重要) </p><p>这个设定项目很重要喔！因为我们的主机有非常多的名字，那么对方填写的 mail to 到底要写哪个主机名字我们才能将该信件收下？ 就是在这里规范的！也就是 说，你的许多主机名当中，仅有写入这个设定值的名称才能作为 email 的主机 地址。 在我们这个练习当中这部主机有三个名字，所以写法为： mydestination = $myhostname, localhost, linux.centos.vbird, ftp.centos.vbird 如果你想要将此设定值移动到外部档案，那可以使用类似底下的作法： mydestination = /etc/postfix/local-host-names ，然后在 local-host-names 里面将可收信的主机名写入即可。一般来说，不建议你额外建立local-host-names这个档案啦，直接写入main.cf即可说！特别留意的是，如果你的DNS里头的设定有MX标志的话，那么请将MX指向的那个主机名一定要写在这个mydestination内，否则很容易出现错误讯息喔！一般来说，使用者最常发生错误的地方就在这个设定里头呢！</p></li><li><p>mynetworks_style：设定『信任网域』的一项指标这个设定值在规定『与主机在同一个网域的可信任客户端』的意思！举例来说，我的主机IP是192.168.100.254，如果我相信整个局域网络内(192.168.100.0/24)的用户的话，那我可规定此设定值为『subnet』吶！不过，一般来说，因为底下的mynetworks会取代这个设定值，所以不设定也没有关系喔！如果要设定的话，最好设定成为host即可(亦即仅信任这部MTA主机而已)。</p></li><li><p>mynetworks ：规定信任的客户端 (极重要)</p><p>你的MTA能不能帮忙进行Relay与这个设定值最有关系！举例来说，我要开放本机与内部网域的IP时，就可以这样进行设定：mynetworks=127.0.0.0/8,192.168.100.0/24。如果你想要以  /etc/postfix/access这个档案来控制relay的用户时，那可以建议你将上述的数据改写成这样：mynetworks=127.0.0.0/8,192.168.100.0/24,hash:/etc/postfix/access然后你只要再建立access之后重整成数据库后，嘿嘿！就能够设定Relay的用户啰！</p></li><li><p>relay_domains：规范可以帮忙relay的下一部MTA主机地址相对于mynetworks是针对『信任的客户端』而设定的，这个relay_domains则可以视为『针对下游MTA服务器』而设定的。举例来说，如果你这部主机是<br><a href="http://www.niki.centos.vbird的mx主机时,那你就得要在relay_domains设定针对整个niki.centos.vbird这个领域的目标信件进行转递才行.在预设的情况下,这个设定值是$mydestination而已啦./">www.niki.centos.vbird的MX主机时，那你就得要在relay_domains设定针对整个niki.centos.vbird这个领域的目标信件进行转递才行。在预设的情况下，这个设定值是$mydestination而已啦。</a></p><p>你必需要注意的『Postfix 预设并不会转递 MX 主机的信件』，意思就是说：如 果你有两部主机，一部是上游的 MTAup ，一部是下游的MTAdown ，而 MTAdown 规范的 MX 主机是 MTAup，由 22.1.2 谈到的 DNS 的 MX 设定值与信件传递方 向，我们知道任何想要寄给 MTAdown 主机的信件， 都会先经过 MTAup 来转递 才行！此时如果那部 MTAup 没有开启帮 MTAdown 进行 relay 的权限时， 那么 任何传给 MTAdown 的信件将『全部都被 MTAup 所退回』！从此 MTAdown 就无 法收到任何信件了。 上一段的说明请您特别再想一想，因为如果你在大公司服务而且你的公司上、下 游均有 mail server 时， 并且也有设定 MX 的状况下，嘿嘿！这个 relay_domains 就很重要啦！上游的 MTA 主机必需要启动这个设定。 一般来说 除非你是某部 MTA 主机的 MX 源头，否则这个设定项目可以忽略不设定他。 而 如果你想要帮你的客户端转递信件到某部特定的 MTA 主机时，这个设定项目也 是可以设定的啦。 默认请您保留默认值即可。</p></li><li><p>alias_maps ：设定邮件别名</p><p>就是设定邮件别名的设定项目，只要指定到正确的档案去即可，这个设定值可以保留默认值啊：</p><p>在了解上述的设定后，以范例来看的话，鸟哥有更动过或注明重要的设定值 以及相关档案是这样处理的：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@www ~]<span class="comment"># vim /etc/postfix/main.cf</span></span><br><span class="line">myhostname = www.centos.vbird &lt;==约在第 77 行</span><br><span class="line">myorigin = <span class="variable">$myhostname</span> &lt;==约在第 99 行</span><br><span class="line">inet_interfaces = all &lt;==约在第 114 行，117 行要批注掉</span><br><span class="line">inet_protocols = ipv4 &lt;==约在第 120 行</span><br><span class="line">mydestination = <span class="variable">$myhostname</span>, localhost.<span class="variable">$mydomain</span>, localhost,</span><br><span class="line">linux.centos.vbird, ftp.centos.vbird &lt;==约在第 165,166 行</span><br><span class="line">mynetworks = 127.0.0.0/8, 192.168.100.0/24, <span class="built_in">hash</span>:/etc/postfix/access &lt;==约在 269 行</span><br><span class="line">relay_domains = <span class="variable">$mydestination</span> &lt;==约在第 299 行</span><br><span class="line">alias_maps = <span class="built_in">hash</span>:/etc/aliases</span><br><span class="line">alias_database = <span class="built_in">hash</span>:/etc/aliases &lt;==约在第 389, 400 行</span><br><span class="line"><span class="comment"># 其他的设定值就先保留默认值即可啊！</span></span><br><span class="line">[root@www ~]<span class="comment"># postmap hash:/etc/postfix/access</span></span><br><span class="line">[root@www ~]<span class="comment"># postalias hash:/etc/aliases</span></span><br></pre></td></tr></table></figure><p>因为 main.cf 当中我们有额外加入两个外部配置文件 (mynetworks 及 alias_maps) ，所以才会额外进行 postmap 及 postalias。然后准备来启动啦！你可以这样处理喔：</p></li></ul><ol><li><p>先检查配置文件的语法是否有错误</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@www ~]<span class="comment"># /etc/init.d/postfix check &lt;==没有讯息，表示没有问题。</span></span><br></pre></td></tr></table></figure></li><li><p>启动与观察 port number</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@www ~]<span class="comment"># /etc/init.d/postfix restart</span></span><br><span class="line">[root@www ~]<span class="comment"># netstat -tlunp | grep &#x27;:25&#x27;</span></span><br><span class="line">Proto Recv-Q Send-Q Local Address Foreign Address State</span><br><span class="line">PID/Program name</span><br><span class="line">tcp 0 0 0.0.0.0:25 0.0.0.0:* LISTEN</span><br><span class="line">13697/master</span><br></pre></td></tr></table></figure><p>很简单吧！这样就设定妥当了。假设你的防火墙已经处理完毕，那你的Postfix已经可以开放客户端进行转递，并且也可以收受信件啰！不过，到底在预设的情况下我们的postfix可以收下哪些信件？又可以针对哪些设定值的内容进行转递呢？这就得要参考下一小节的说明了。</p></li></ol><h5 id="信件传送流程与收信、relay-等重要观念"><a href="#信件传送流程与收信、relay-等重要观念" class="headerlink" title="信件传送流程与收信、relay 等重要观念"></a>信件传送流程与收信、relay 等重要观念</h5><p>我想，您对于MTA的设定与收发信件应该有一定程度的概念了，不过要妥善设定好你的MTA时，尤其是想要了解到整部MTA是如何收、发信件时，你最好还是要知道『我这部MTA如何接受来源主机所传来的信件，以及将信件转递到下一部主机去』的整个流程啊。一般来说一封邮件传送会经过许多的流程为：</p><ol><li><p>送信端与收信端两部主机间会先经过一个握手 (ehlo) 的阶段，此时送信端 被记录为发信来源(而不是 mail from)。 通过握手后就可以进行信件标头 (header) 的传送；</p></li><li><p>此时收信端主机会分析标头的信息，若信件之Mailto:主机名为收信端主机，且该名称符合mydestination的设定，则该信件会开始被收下至队列，并进一步送到mailbox当中；若不符合mydestination的设定，则终止联机且不会进行信件内容(body)的传送；</p></li><li><p>若Mailto:主机名非为收信端本身，则开始进行转递(relay)的分析。</p></li><li><p>转递过程首先分析该信件的来源是否符合信任的客户端(这个客户端为步骤1所记录的发信主机喔)，亦即来源是否符合mynetworks的设定值，若符合则开始收下信件至队列中，并等待MDA将信件再转递出去，若不符mynetworks则继续下一步；</p></li><li><p>分析信件来源或目标是否符合 relay_domains 的设定，若符合则信件将被收下至队列，并等待 MDA 将信件再转递出去；</p></li><li><p>若这封信的标头数据都不合乎上述的规范，则终止联机，并不会接受信件的内容数据的。</p></li></ol><p>整个流程有点像底下这样：</p><p><a href="https://imgtu.com/i/Icj5Hf"><img src="https://z3.ax1x.com/2021/11/14/Icj5Hf.png" alt="Icj5Hf.png"></a></p><p>也就是说标头分析通过后，你的信件内容才会开始上传到主机的队列，然后透过MDA来处理该信件的流向。而不是将信件完整的传送到主机后才开始分析的喔！这个得要特别注意吶！而透过上述的流程后，在暂不考虑access以及MDA的分析机制中，一部MTA想要正确的收、发信件时，电子邮件必需要符合：</p><p>收信方面：必需符合底下需求：</p><ol><li><p>发信端必需符合 $inet_interfaces 的设定；</p></li><li><p>信件标头之收件者主机名必需符合 $mydestination 的设定， 或者收件主机名需要符合 $virtual_maps (与虚拟主机有关) 的设定；</p></li></ol><p>转递方面 (Relay)：必需符合底下需求：</p><ol><li><p>发信端必需符合 $inet_interfaces 的设定；</p></li><li><p>发信端来源必需为 $mynetworks 的设定；发信端来源或信件标头之收件者主机名符合 $relay_domains 之设定内容。 同样的原理与想法你可以将他用在 sendmail 的设定当中喔！ ^_^！不过很多垃圾信却是藉由这个预设的收发管道来发送， 怎么说呢？请看底下的分析：</p></li></ol><p>例题： 在我的主机上面竟然发现这样的广告信，那就是『利用我的主机发送广告信给我自己！』为什么这样也可以呢？ </p><p>答： 首先，你必需要熟悉一下上述的流程，在第 2 个步骤当中我们知道，当主机收到一封信且这封信的目标是自己，并且也符合mydestination 的设定 时，该信件就会被收下来而不必验证客户端是否来自于mynetworks 了。所以说，任何人都可以用这个流程来寄信给你啊。不过，你的 MTA 并不是 open relay 啦，不会帮人家发送广告信的，不用担心。</p><p>例题：我的主机明明没有Openrelay，但很多其他的MTA管理员发信给我，说我的主机的某个账号持续发送广告信，但是我的主机明明没有那个账号啊！这是怎么回事？</p><p>答： 仔细看一下流程的步骤 1 与 2 ，确认该封信能否被收下来与发信端及收信端主机名有关。而我们知道在邮件的 header 里面还有一个 mail from 的标头设定项目，这个标头设定是我们在查阅邮件时看到的『回邮地址』，这个数据是可以伪造的！而且他与收发信件的数据无关！所以，您应该要告知对方MTA管理员，请他提供详细的log数据，才能够判断该封信是否由你的主机所发送出去的。<br>一般来说，目前的广告业者很多都是利用这种欺敌的方式来处理的，所以您必需要请对方提供详细的logfile数据以供查验才行喔！</p><h5 id="设定邮件主机权限与过滤机制-etc-postfix-access"><a href="#设定邮件主机权限与过滤机制-etc-postfix-access" class="headerlink" title="设定邮件主机权限与过滤机制 /etc/postfix/access"></a>设定邮件主机权限与过滤机制 /etc/postfix/access</h5><p>基本上，指定了Postfix的mynetworks的信任来源就能够让使用者relay了，不过如果你依照鸟哥上述的方式来设定你的mynetworks的话，那么我们还可以利用access这个档案来额外管理我们的信件过滤呢！基本的access语法为：</p><p>规范的范围或规则 Postfix 的动作 (范例如下) </p><p>IP/部分 IP/主机名/Email 等 OK/REJECT </p><p>假设你想要让 120.114.141.60 还有 .edu.tw 可以使用这部 MTA 来转递信件，且不许 </p><p>av.com 以及 192.168.2.0/24 这个网域的使用时，可以这样做： </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@www ~]<span class="comment"># vim /etc/postfix/access </span></span><br><span class="line">120.114.141.60 </span><br><span class="line">OK</span><br><span class="line">.edu.tw </span><br><span class="line">OK</span><br><span class="line">av.com </span><br><span class="line">REJECT </span><br><span class="line">192.168.2. </span><br><span class="line">REJECT</span><br><span class="line"><span class="comment"># OK 表示可接受，而 REJECT 则表示拒绝。 </span></span><br><span class="line">[root@www ~]<span class="comment"># postmap hash:/etc/postfix/access </span></span><br><span class="line">[root@www ~]<span class="comment"># ls -l /etc/postfix/access* </span></span><br><span class="line">-rw-r--r--. 1 root root 19648 2011-08-09 14:05 /etc/postfix/access </span><br><span class="line">-rw-r--r--. 1 root root 12288 2011-08-09 14:08 /etc/postfix/access.db </span><br><span class="line"><span class="comment"># 你会发现有个 access.db 的档案才会同步更新！</span></span><br></pre></td></tr></table></figure><p>这才是 postfix 实际读取的！</p><p>​        用这个档案设定最大的好处是，你不必重新启动 postfix，只要将数据库建立好， 立刻就生效了！这个档案还有其它的进阶功能，你可以自行进入该档案查阅就知道了。但是进阶设定还需要 main.cf 内的其他参数有设定才行！如果只有之前 $mynetworks 的设定值时，你只能利用 access.db 的方式来开放 relay 的能力而已。不过，至少他可以让我们的设定简化啰！ ^_^ </p><h5 id="设定邮件别名：-etc-aliases-forward"><a href="#设定邮件别名：-etc-aliases-forward" class="headerlink" title="设定邮件别名： /etc/aliases, ~/.forward"></a>设定邮件别名： /etc/aliases, ~/.forward</h5><p>​        想一想，你的主机里面不是有很多系统账号吗？例如named,apache,mysql…，那么以这些账号执行的程序若有讯息发生时，他会将该讯息以email的方式传给谁？应该就是传给named,apache…等账号自己吧。不过，你会发现其实这些系统账号的信息都是丢给root！这是因为其他的系统账号并没有密码可登入，自然也就无法接收任何邮件了，所以若有邮件就给系统管理员啰。不过，咱们的MTA怎么知道这些信件要传给root？这就得要aliases这个邮件别名配置文件来处理啦！</p><p>​        邮件别名配置文件： /etc/aliases 在你的 /etc/aliases 档案内，你会发现类似底下的字样： </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@www ~]<span class="comment"># vim /etc/aliases</span></span><br><span class="line">mailer-daemon: postmaster </span><br><span class="line">postmaster: root </span><br><span class="line">bin: root </span><br><span class="line">daemon: root </span><br><span class="line">....(底下省略)....</span><br></pre></td></tr></table></figure><p>左边是『别名』右边是『实际存在的使用者账号或者是 email address』！ 就是透过这个设定值，所以让我们可以将所有系统账号所属的信件通通丢给 root 啊！好，我现在将他扩大化，假如你的 MTA 内有一个实际的账号名称为 dmtsai ，这个使用者还想要使用 dermintsai 这个名称来收他的信件， 那么你可以这样做：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@www ~]<span class="comment"># vim /etc/aliases </span></span><br><span class="line">dermintsai: dmtsai</span><br><span class="line"><span class="comment"># 左边是你额外所设定的，右边则是实际接收这封信的账号！ </span></span><br><span class="line">[root@www ~]<span class="comment"># postalias hash:/etc/aliases </span></span><br><span class="line">[root@www ~]<span class="comment"># ll /etc/aliases* </span></span><br><span class="line">-rw-r--r--. 1 root root 1535 2011-08-09 14:10 /etc/aliases </span><br><span class="line">-rw-r--r--. 1 root root 12288 2011-08-09 14:10 /etc/aliases.db</span><br></pre></td></tr></table></figure><p>从此之后不论是 <a href="mailto:&#x64;&#109;&#x74;&#x73;&#x61;&#x69;&#x40;&#119;&#119;&#119;&#46;&#99;&#x65;&#x6e;&#x74;&#111;&#115;&#x2e;&#118;&#x62;&#105;&#x72;&#x64;">&#x64;&#109;&#x74;&#x73;&#x61;&#x69;&#x40;&#119;&#119;&#119;&#46;&#99;&#x65;&#x6e;&#x74;&#111;&#115;&#x2e;&#118;&#x62;&#105;&#x72;&#x64;</a> 还是 <a href="mailto:&#x64;&#101;&#114;&#x6d;&#x69;&#110;&#116;&#x73;&#x61;&#x69;&#64;&#x77;&#119;&#x77;&#x2e;&#99;&#x65;&#x6e;&#116;&#x6f;&#115;&#46;&#118;&#98;&#105;&#114;&#x64;">&#x64;&#101;&#114;&#x6d;&#x69;&#110;&#116;&#x73;&#x61;&#x69;&#64;&#x77;&#119;&#x77;&#x2e;&#99;&#x65;&#x6e;&#116;&#x6f;&#115;&#46;&#118;&#98;&#105;&#114;&#x64;</a> 都会将信件丢到 /var/spool/mail/dmtsai 这个信箱当中喔！很方便吧！</p><ul><li><p>/etc/aliases 实际应用一：</p><p>让一般账号可接收 root 的信，假设你是系统管理员，而你常用的一般账号为 dmtsai，但是系统出错时的重要信件都是寄给 root 啊， 偏偏 root 的信件不能被直接读取….所以说，如果能够将『给 root 的信也转寄一份给 dmtsai 』的话， 那就太好了！可以达到吗？当然可以！你可以这样做：</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@www ~]<span class="comment"># vim /etc/aliases </span></span><br><span class="line">root: root,dmtsai &lt;==鸟哥建议这种写法！ </span><br><span class="line"><span class="comment"># 信件会传给 root 与 dmtsai 这两个账号！ </span></span><br><span class="line">root: dmtsai &lt;==如果 </span><br><span class="line">dmtsai 不再是管理员怎办？ </span><br><span class="line"><span class="comment"># 从此 root 收不到信了，都由 dmtsai 来接受！</span></span><br><span class="line">[root@www ~]<span class="comment"># postalias hash:/etc/aliases</span></span><br></pre></td></tr></table></figure><p>上面那两行你可以择一使用，看看root要不要保留他的信件都可以的！鸟哥建议使用第一种方式，因为这样一       来，你的dmtsai可以收到root的信，且root自己也可以『备份』一份在他的信箱内，比较安全啦！</p><ul><li><p>/etc/aliases 实际应用二：</p><p>发送群组寄信功能 想象一个情况，如果你是学校的老师，你虽然只带一班导生，但是『每年都一班』时，如果有一天你要将信发给所有的学生，那在写email的标头时，可能就会头昏昏的了(因为联络人名单太多了)！这个时候你可以这样做：(假设主机上学生的账号为std001,std002…)</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@www ~]<span class="comment"># vim /etc/aliases </span></span><br><span class="line">student2011: </span><br><span class="line">std001,std002,std003,std004... </span><br><span class="line">[root@www ~]<span class="comment"># postalias hash:/etc/aliases</span></span><br></pre></td></tr></table></figure><p>如此一来只要寄信到这部主机的student2011这个不存在的账号时，该封信就会被分别存到各个账号里头去，管理上面是否很方便啊！^_^！事实上，邮件别名除了填写自己主机上面的实体用户之外，其实你可以填写外部主机的email喔！例如你要将本机的dermintsai那个不存在的用户的信件除了传给dmtsai之外，还要外传到<a href="mailto:&#100;&#x6d;&#116;&#x73;&#97;&#x69;&#64;&#109;&#97;&#x69;&#108;&#x2e;&#110;&#x69;&#107;&#105;&#x2e;&#99;&#x65;&#110;&#116;&#111;&#115;&#x2e;&#118;&#98;&#105;&#114;&#x64;">&#100;&#x6d;&#116;&#x73;&#97;&#x69;&#64;&#109;&#97;&#x69;&#108;&#x2e;&#110;&#x69;&#107;&#105;&#x2e;&#99;&#x65;&#110;&#116;&#111;&#115;&#x2e;&#118;&#98;&#105;&#114;&#x64;</a>时，可以这样做：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@www ~]<span class="comment"># vim /etc/aliases </span></span><br><span class="line">dermintasi: dmtsai,dmtsai@mail.niki.centos.vbird </span><br><span class="line">[root@www ~]<span class="comment"># postalias hash:/etc/aliases</span></span><br></pre></td></tr></table></figure><p>很方便吧！更多的功能就期待您自行发掘啰！ </p><p><strong>Tips:</strong> 在这本书里面，dmtai的家目录并非在正规的/home底下，而是放置于/winhome当中(参考第十六章的练习)，所以实际操作mail指令会出错！这是因为SELinux的关系！请参考/var/log/messages底下的建议动作去处理即可！</p><p>个人化的邮件转递：~/.forward虽然/etc/aliases可以帮我们达到邮件别名设定的好处，不过/etc/aliases是只有root才能修改的档案权限，那我们一般使用者如果也想要进行邮件转递时，该如何是好？没关系，可以透过自己家目录下的.forward这个档案喔！举例来说，我的dmtsai这个账号所接收到的信件除了自己要保留一份之外，还要传给本机上的vbird以及<a href="mailto:&#100;&#x6d;&#x74;&#x73;&#97;&#x69;&#64;&#x6d;&#x61;&#x69;&#x6c;&#46;&#x6e;&#x69;&#x6b;&#105;&#46;&#99;&#101;&#x6e;&#116;&#x6f;&#115;&#46;&#x76;&#x62;&#105;&#114;&#x64;">&#100;&#x6d;&#x74;&#x73;&#97;&#x69;&#64;&#x6d;&#x61;&#x69;&#x6c;&#46;&#x6e;&#x69;&#x6b;&#105;&#46;&#99;&#101;&#x6e;&#116;&#x6f;&#115;&#46;&#x76;&#x62;&#105;&#114;&#x64;</a>时，那你可以这样做设定：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[dmtsai@www ~]$ vim .forward</span><br><span class="line"><span class="comment"># 注意！我现在的身份现在是 dmtsai 这个一般身份，而且在他的家目录下！</span></span><br><span class="line">dmtsai </span><br><span class="line">vbird </span><br><span class="line">dmtsai@mail.niki.centos.vbird </span><br><span class="line">[dmtsai@www ~]$ chmod 644 .forward</span><br></pre></td></tr></table></figure><p>记得这个档案内容是一行一个账号(或email)，而且权限方面非常重要：该档案所在用户家目录权限，其group、other不可以有写入权限。.forward档案权限，其group、other不可以有写入权限。如此一来这封信就会开始转递啰！有趣吧！^_^</p><h5 id="察看信件队列信息：-postqueue-mailq"><a href="#察看信件队列信息：-postqueue-mailq" class="headerlink" title="察看信件队列信息： postqueue, mailq"></a>察看信件队列信息： postqueue, mailq</h5><p>​        说实话，设定到此为止咱们的postfix应该可以应付一般小型企业之mailserver的用途了！不过，有的时候毕竟因为网络的问题或者是对方主机的问题，可能导致某些信件无法送出而被暂存在队列中，那我们如何了解队列当中有哪些邮件呢？还有，在队列当中等待送出的信件是如何送出的呢？</p><p>​        如果该封信在五分钟之内无法寄出，则通常系统会发出一封『警告信』给原发信者，告知该封邮件尚无法被寄送出去，不过，系统仍会持续的尝试寄出该封邮件；</p><p>​        如果在四小时候仍无法寄出，系统会再次的发出警告信给原发信者；</p><p>​        如果持续进行五天都无法将信件送出，那么该封邮件就会退回给原发信者了！当然啦，某些MTA已经取消了警告信的寄发，不过原则上，如果信件无法实时寄出去的话MTA还是会努力尝试5天的，如果接下来的5天都无法送出时，才会将原信件退回给发信者。一般来说，如果MTA设定正确且网络没有问题时，应该是不可能会有信件被放在队列当中而传不出去的，所以如果发现有信件在队列时，细的瞧一瞧啰！检查队列内容的方法可以使用mailq，也可以使用postqueue-p来检查的：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@www ~]<span class="comment"># postqueue -p </span></span><br><span class="line">Mail queue is empty</span><br></pre></td></tr></table></figure><p>若您的邮件如此显示时，恭喜您，没有什么问题邮件在队列当中。不过如果你将postfix关闭，并尝试发一封信给任何人，那就可能会出现如下的画面啦：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@www ~]<span class="comment"># /etc/init.d/postfix stop </span></span><br><span class="line">[root@www ~]<span class="comment"># echo &quot;test&quot; | mail -s &quot;testing queue&quot; root </span></span><br><span class="line">[root@www ~]<span class="comment"># postqueue -p </span></span><br><span class="line">postqueue: warning: Mail system is down -- accessing queue directly </span><br><span class="line">-Queue ID- --Size-- ----Arrival Time---- -Sender/Recipient------- </span><br><span class="line">5CFBB21DB 284 Tue Aug 9 06:21:58 root </span><br><span class="line">root </span><br><span class="line">-- 0 Kbytes <span class="keyword">in</span> 1 Request.</span><br><span class="line"><span class="comment"># 第一行就说明了无法寄出的原因为 Mail system is down 啦！ </span></span><br><span class="line"><span class="comment"># 然后才出现无法寄出的信件信息！包括来源与目标喔！</span></span><br></pre></td></tr></table></figure><p>输出的信息主要为： </p><ul><li><p>Queue ID：表示此封邮件队列的代表号 (ID)，这个号码是给 MTA 看的，我们看不懂不要紧； </p></li><li><p>Size ：这封信有多大容量 (bytes) 的意思； </p></li><li><p>Arrival Time：这封信什么时候进入队列的，并且可能会说明无法立即传送出去的原因； </p></li><li><p>Sender/Recipient：送信与收信者的电子邮件啰！ </p></li></ul><p>事实上这封信是放置在 /var/spool/postfix 里面，由于信件内容已经编码为给MTA 看的资料排列， 所以你可以使用 postcat 来读出原信件的内容喔！例如这样做(注意看档名与 Queue ID 的对应！)：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@www ~]<span class="comment"># cd /var/spool/postfix/maildrop </span></span><br><span class="line">[root@www maildrop]<span class="comment"># postcat 5CFBB21DB &lt;==这个档名就是 Queue ID </span></span><br><span class="line">*** ENVELOPE RECORDS 5CFBB21DB *** &lt;==说明队列的编号啊 </span><br><span class="line">message_arrival_time: Tue Aug 9 14:21:58 2011 </span><br><span class="line">named_attribute: rewrite_context=<span class="built_in">local</span> &lt;==分析 named (DNS) 的特性来自本机 </span><br><span class="line">sender_fullname: root &lt;==发信者的大名与 email </span><br><span class="line">sender: root recipient: root &lt;==就是收件者啰！</span><br><span class="line">*** MESSAGE CONTENTS 5CFBB21DB *** &lt;==底下则是信件的实际内容啊！</span><br><span class="line">Date: Tue, 09 Aug 2011 14:21:58 +0800 </span><br><span class="line">To: root </span><br><span class="line">Subject: testing queue </span><br><span class="line">User-Agent: Heirloom mailx 12.4 7/29/08 </span><br><span class="line">MIME-Version: 1.0 </span><br><span class="line">Content-Type: text/plain; charset=us-ascii </span><br><span class="line">Content-Transfer-Encoding: 7bit </span><br><span class="line"><span class="built_in">test</span></span><br><span class="line">*** HEADER EXTRACTED 5CFBB21DB *** </span><br><span class="line">*** MESSAGE FILE END 5CFBB21DB ***</span><br></pre></td></tr></table></figure><p>如此一来你就知道目前我们的MTA主机有多少未送出的信件，还有未送出信件的内容你也可以追踪的到了！很不错，对吧！不过，如果你想要我们的postfix立刻尝试将这些在队列当中的信件寄出去，那又该如何是好？你有几个作法啦，可以重新启动postfix，也可以透过postfix的动作来处理，例如： </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@www ~]<span class="comment"># /etc/init.d/postfix restart </span></span><br><span class="line">[root@www ~]<span class="comment"># postfix flush</span></span><br></pre></td></tr></table></figure><p>鸟哥个人比较建议使用postfixflush啰！自行参考看看先！^_^！接下来，让我们先来处理一下收信的MRA服务器，搞定后再来处理客户端的用户接口吧！</p><h5 id="防火墙设置"><a href="#防火墙设置" class="headerlink" title="防火墙设置"></a>防火墙设置</h5><p>因为整个MTA主要是透过SMTP(port25)进行信件传送的任务，因此，针对postfix来说，只要放行port25即可呦！修改一下iptables.rule吧！</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@www ~]<span class="comment"># vim /usr/local/virus/iptables/iptables.rule</span></span><br><span class="line"><span class="comment"># 找到底下这一行，并且将它批注拿掉！ </span></span><br><span class="line">iptables -A INPUT -p TCP -i <span class="variable">$EXTIF</span> --dport 25 --sport 1024:65534 -j ACCEPT </span><br><span class="line">[root@www ~]<span class="comment"># /usr/local/virus/iptables/iptables.rule</span></span><br></pre></td></tr></table></figure><p>这样就放行整个 Internet 对您服务器的 port 25 的读取啰！简单！搞定！</p><h4 id="MRA-服务器：-dovecot-设定"><a href="#MRA-服务器：-dovecot-设定" class="headerlink" title="MRA 服务器： dovecot 设定"></a>MRA 服务器： dovecot 设定</h4><p>除非你想要架设webmail在你的MTA上头，否则，你的MTA收下了信件，你总得连上MTA去收信吧？那么收信要用的是哪个通讯协议？就是22.1.4里面谈到的pop3以及imap啰！这就是所谓的MRA服务器！我们的CentOS6.x使用的是dovecot这个软件来达成MRA的相关通讯协议的！但由于pop3/imap还有数据加密的版本，底下我们就依据是否加密(SSL)来设定dovecot吧！</p><h5 id="基础的-POP3-IMAP-设定"><a href="#基础的-POP3-IMAP-设定" class="headerlink" title="基础的 POP3/IMAP 设定"></a>基础的 POP3/IMAP 设定</h5><p>启动单纯的pop3/imap是很简单的啦，你得要先确定已经安装了dovecot这个软件。而这个软件的配置文件只有一个，就是/etc/dovecot/dovecot.conf。我们仅要启动pop3/imap而已，所以可以这样设定即可：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@www ~]<span class="comment"># yum install dovecot </span></span><br><span class="line">[root@www ~]<span class="comment"># vim /etc/dovecot/dovecot.conf </span></span><br><span class="line"><span class="comment"># 找到底下这一行，大约是在第 25 行左右的地方，复制新增一行内容如下： </span></span><br><span class="line"><span class="comment">#protocols = imap pop3 lmtp </span></span><br><span class="line">protocols = imap pop3 </span><br><span class="line">[root@www ~]<span class="comment"># vim /etc/dovecot/conf.d/10-ssl.conf </span></span><br><span class="line">ssl = no &lt;==将第 6 行改成这样！</span><br></pre></td></tr></table></figure><p>改完之后你就可以启动dovecot啰！并且检查看看port110/143(pop3/imap)有没有启动啊？</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@www ~]<span class="comment"># /etc/init.d/dovecot start </span></span><br><span class="line">[root@www ~]<span class="comment"># chkconfig dovecot on </span></span><br><span class="line">[root@www ~]<span class="comment"># netstat -tlnp | grep dovecot </span></span><br><span class="line">Proto Recv-Q Send-Q Local Address Foreign Address State PID/Program name </span><br><span class="line">tcp 0 0 :::110 :::* LISTEN </span><br><span class="line">14343/dovecot </span><br><span class="line">tcp 0 0 :::143 :::* LISTEN </span><br><span class="line">14343/dovecot</span><br></pre></td></tr></table></figure><p>耶！搞定！这样就可以提供使用者来收信件啦！真是不错啊！不过记得喔，这里只提供基本的明码pop3/imap传输而已，如果想要启动其他如pop3s(传输加密机制)协议时，就得要额外的设定啰！</p><h5 id="加密的-POP3s-IMAPs-设定"><a href="#加密的-POP3s-IMAPs-设定" class="headerlink" title="加密的 POP3s/IMAPs 设定"></a>加密的 POP3s/IMAPs 设定</h5><p>如果担心数据在传输过程会被窃取，或者是你的登入信息(账号与密码)在使用pop3/imap时会被窃听，那么这个pop3s/imaps就显的重要啦！与之前的Apache相似的，其实我们都是透过openssl这个软件提供的SSL加密机制来进行数据的加密传输。方式很简单呢！预设的情况下，CentOS已经提供了SSL凭证范例文件给我们使用了。如果你一点都不想要使用预设的凭证，那么我们就来自己建一个吧！</p><h6 id="建立凭证："><a href="#建立凭证：" class="headerlink" title="建立凭证："></a>建立凭证：</h6><p>到系统提供的/etc/pki/tls/certs/目录下建立所需要的pem凭证档：建立凭证：到系统提供的/etc/pki/tls/certs/目录下建立所需要的pem凭证档：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@www ~]<span class="comment"># cd /etc/pki/tls/certs/ </span></span><br><span class="line">[root@www certs]<span class="comment"># make vbirddovecot.pem </span></span><br><span class="line">....(前面省略).... </span><br><span class="line">Country Name (2 letter code) [XX]:TW </span><br><span class="line">State or Province Name (full name) []:Taiwan </span><br><span class="line">Locality Name (eg, city) [Default City]:Tainan </span><br><span class="line">Organization Name (eg, company) [Default Company Ltd]:KSU </span><br><span class="line">Organizational Unit Name (eg, section) []:DIC Common Name (eg, your name or your server<span class="string">&#x27;s hostname) []:www.centos.vbird </span></span><br><span class="line"><span class="string">Email Address []:dmtsai@www.centos.vbird</span></span><br></pre></td></tr></table></figure><h6 id="因为担心-SELinux-的问题，所以建议将-pem-档案放置到系统默认的目录去较佳！"><a href="#因为担心-SELinux-的问题，所以建议将-pem-档案放置到系统默认的目录去较佳！" class="headerlink" title="因为担心 SELinux 的问题，所以建议将 pem 档案放置到系统默认的目录去较佳！"></a>因为担心 SELinux 的问题，所以建议将 pem 档案放置到系统默认的目录去较佳！</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@www certs]<span class="comment"># mv vbirddovecot.pem ../../dovecot/ </span></span><br><span class="line">[root@www certs]<span class="comment"># restorecon -Rv ../../dovecot</span></span><br></pre></td></tr></table></figure><h6 id="开始处理-dovecot-conf，只要-pop3s-imaps-不要明码传输的咯！"><a href="#开始处理-dovecot-conf，只要-pop3s-imaps-不要明码传输的咯！" class="headerlink" title="开始处理 dovecot.conf，只要 pop3s, imaps 不要明码传输的咯！"></a>开始处理 dovecot.conf，只要 pop3s, imaps 不要明码传输的咯！</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@www certs]<span class="comment"># vim /etc/dovecot/conf.d/10-auth.conf </span></span><br><span class="line">disable_plaintext_auth = yes &lt;==第 9 行改成这样！取消批注！ </span><br><span class="line">[root@www certs]<span class="comment"># vim /etc/dovecot/conf.d/10-ssl.conf </span></span><br><span class="line">ssl = required &lt;==第 6 行改成这样 </span><br><span class="line">ssl_cert = &lt;/etc/pki/dovecot/vbirddovecot.pem &lt;==12, 13 行变这样 </span><br><span class="line">ssl_key = &lt;/etc/pki/dovecot/vbirddovecot.pem </span><br><span class="line">[root@www certs]<span class="comment"># vim /etc/dovecot/conf.d/10-master.conf </span></span><br><span class="line">inet_listener imap &#123; </span><br><span class="line">port = 0 &lt;== 15 行改成这样 </span><br><span class="line">&#125;</span><br><span class="line">inet_listener pop3 &#123;</span><br><span class="line">port = 0 &lt;== 36 行改成这样 </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h6 id="处理额外的-mail-location-设定值！很重要！否则网络收信会失败："><a href="#处理额外的-mail-location-设定值！很重要！否则网络收信会失败：" class="headerlink" title="处理额外的 mail_location 设定值！很重要！否则网络收信会失败："></a>处理额外的 mail_location 设定值！很重要！否则网络收信会失败：</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@www certs]<span class="comment"># vim /etc/dovecot/conf.d/10-mail.conf </span></span><br><span class="line">mail_location = mbox:~/mail:INBOX=/var/mail/%u &lt;==第 30 行改这样</span><br></pre></td></tr></table></figure><h6 id="重新启动-dovecot-并且观察-port-的变化："><a href="#重新启动-dovecot-并且观察-port-的变化：" class="headerlink" title="重新启动 dovecot 并且观察 port 的变化："></a>重新启动 dovecot 并且观察 port 的变化：</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@www certs]<span class="comment"># /etc/init.d/dovecot restart </span></span><br><span class="line">[root@www certs]<span class="comment"># netstat -tlnp | grep dovecot </span></span><br><span class="line">Proto Recv-Q Send-Q Local Address Foreign Address State PID/Program name </span><br><span class="line">tcp 0 0 :::993 :::* LISTEN 14527/dovecot </span><br><span class="line">tcp 0 0 :::995 :::* LISTEN 14527/dovecot</span><br></pre></td></tr></table></figure><p>最终你看到的993是imaps而995则是pop3s啰！这样一来，你收信的时候，输入的账号密码就不怕被窃听了！反正是加密后的资料啰！很简单吧！</p><h5 id="防火墙设置-1"><a href="#防火墙设置-1" class="headerlink" title="防火墙设置"></a>防火墙设置</h5><p>因为上面的练习中，我们将pop3/imap关闭，转而打开pop3s/imaps了，因此防火墙启动的端口会不一样！请依据您实际的案例来设定你所需要的防火墙才好。我们这里主要是开放993,995两个端口呦！</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@www ~]<span class="comment"># vim /usr/local/virus/iptables/iptables.rule </span></span><br><span class="line"><span class="comment"># 大约在 180 行左右，新增底下两行去！ </span></span><br><span class="line">iptables -A INPUT -p TCP -i <span class="variable">$EXTIF</span> --dport 993 --sport 1024:65534 -j ACCEPT </span><br><span class="line">iptables -A INPUT -p TCP -i <span class="variable">$EXTIF</span> --dport 995 --sport 1024:65534 -j ACCEPT </span><br><span class="line">[root@www ~]<span class="comment"># /usr/local/virus/iptables/iptables.rule</span></span><br></pre></td></tr></table></figure><p>如果你的pop3/imap还是决定不加密的话，请将上面的993/995改成143/110即可！</p>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;/assets/css/APlayer.min.css&quot;&gt;&lt;script src=&quot;/assets/js/APlayer.min.js&quot; cla</summary>
      
    
    
    
    <category term="Linux" scheme="https://www.hnswxx.cn/categories/Linux/"/>
    
    
    <category term="鸟哥的Linux私房菜" scheme="https://www.hnswxx.cn/tags/%E9%B8%9F%E5%93%A5%E7%9A%84Linux%E7%A7%81%E6%88%BF%E8%8F%9C/"/>
    
    <category term="postfix" scheme="https://www.hnswxx.cn/tags/postfix/"/>
    
    <category term="邮件" scheme="https://www.hnswxx.cn/tags/%E9%82%AE%E4%BB%B6/"/>
    
  </entry>
  
  <entry>
    <title>Active Directory 域服务概述</title>
    <link href="https://www.hnswxx.cn/2021/11/11/active-directory-domain-services-overview/"/>
    <id>https://www.hnswxx.cn/2021/11/11/active-directory-domain-services-overview/</id>
    <published>2021-11-11T14:11:05.000Z</published>
    <updated>2021-11-19T03:54:10.216Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h4 id="Active-Directory域服务的适用范围（Scope）"><a href="#Active-Directory域服务的适用范围（Scope）" class="headerlink" title="Active Directory域服务的适用范围（Scope）"></a>Active Directory域服务的适用范围（Scope）</h4><p>AD DS的适用范围非常广泛，它可以用在一台计算机、一个小型局域网络（LAN）或数个广域网（WAN）结合的环境中。它包含此范围中的所有对象，例如文件、打印机、应用程序、服务器、域控制器和用户账户等。</p><h4 id="名称空间（Namespace）"><a href="#名称空间（Namespace）" class="headerlink" title="名称空间（Namespace）"></a>名称空间（Namespace）</h4><p>​    <strong>名称空间</strong>是一个界定好的区域（bounded area），在此区域内，我们可以利用某个名称找到与此名称有关的信息。例如一本电话薄就是一个<strong>名称空间</strong>，在这本电话薄内（界定好的区域内），我们可以利用姓名来找到此人的电话、地址与生日等数据。又例如Windows操作系统的NTFS文件系统也是一个<strong>名称空间</strong>，在这个文件系统内，我们可以利用文件名来找到此文件的大小、修改日期与文件内容等数据。</p><p>​    <strong>Active Directory域服务（AD DS）</strong>也是一个<strong>名称空间</strong>。利用AD DS，我们可以通过对象名称来找到与此对象有关的所有信息。</p><p>​    在TCP/IP网络环境下利用Domain Name System（DNS）来解析主机名与IP地址的对应关系，例如利用DNS来得知主机的IP地址。AD DS也与DNS紧密地集成在一起，它的域名<strong>空间</strong>也是采用DNS架构，因此域名是采用DNS格式来命名的，例如可以将AD DS的域名命名为sayms.local</p><h4 id="对象（Object）与属性（Attribute）"><a href="#对象（Object）与属性（Attribute）" class="headerlink" title="对象（Object）与属性（Attribute）"></a>对象（Object）与属性（Attribute）</h4><p>​    AD DS内的资源以对象的形式存在，例如用户、计算机等都是对象，而对象是通过<strong>属性</strong>来描述其特征的，也就是对象本身是一些属性的集合。例如若要为使用者<strong>王乔治</strong>建立一个账户，则需要新建一个对象类型（object class）为<strong>用户</strong>的对象（也就是用户账户），然后在此对象内输入<strong>王乔治</strong>的姓、名、登录名与地址等，其中的用户账户就是对象，而姓、名与登录名等就是该对象的属性（参考表1-1）。另外图1-1中的<strong>王乔治</strong>就是对象类型为用户（user）的对象。</p><p>表1-1</p><table><thead><tr><th>对象（object）</th><th>属性（attributes）</th></tr></thead><tbody><tr><td>用户（user）</td><td>姓名登录名地址…</td></tr></tbody></table><p><a href="https://imgtu.com/i/IB0eyj"><img src="https://z3.ax1x.com/2021/11/12/IB0eyj.md.png" alt="IB0eyj.md.png"></a></p><p>图1-1</p><h4 id="容器（Container-与组织单位（Organization-Units，OU）"><a href="#容器（Container-与组织单位（Organization-Units，OU）" class="headerlink" title="容器（Container) 与组织单位（Organization Units，OU）"></a>容器（Container) 与组织单位（Organization Units，OU）</h4><p>​    容器与对象类似，它也有自己的名称，也是一些属性的集合，不过容器内可以包含其他对象（例如<strong>用户</strong>、<strong>计算机</strong>等），也可以包含其他容器。而组织单位是一个比较特殊的容器，其内除了可以包含其他对象与组织单位之外，还可以为组织单位添加<strong>组策略</strong>（group policy）的功能。图1-2所示就是一个名为业务部的组织单位，其中包含多个对象，其中两个为<strong>用户</strong>对象、两个为<strong>计算机</strong>对象，两个本手也是组织单位的对象。</p><p><a href="https://imgtu.com/i/IBrRB9"><img src="https://z3.ax1x.com/2021/11/12/IBrRB9.png" alt="IBrRB9.png"></a></p><p>图1-2</p><p>​    AD DS以层次式架构（hierarchical）将对象、容器与i组织单位等组合在一起，并将其存储到AD DS数据库内。</p><h4 id="域树（Domain-Tree）"><a href="#域树（Domain-Tree）" class="headerlink" title="域树（Domain Tree）"></a>域树（Domain Tree）</h4><p>​    您可以架设包含多个域的网络，而且是以域树（domain tree）的形式存在，例如图1-3就是一个域树，其中最上层的域名为sayms.local，它是此域树的根域（root domain)；根域之下还有两个子域（sales.sayms.local与mkt.sayms.local)，之下还有三个子域。</p><p>​    图中域树符合DNS域名空间的命名原则，而且是具有连续性的，也就是子域的域名包含其父域的域名，例如域sales.sayms.local的后缀中包含其上一层（父域）的域名sayms.local；而nor.sales.sayms.local的后缀中包含其上一层的域名sales.sayms.local。</p><p><a href="https://imgtu.com/i/IBDVqs"><img src="https://z3.ax1x.com/2021/11/12/IBDVqs.png" alt="IBDVqs.png"></a></p><p>​    在域树内所有域共享一个AD DS，也就是在此域树之下只有一个AD DS，不过其数据是分散存储在各个域中的，每一个域中只存储隶属与该域的数据，例如该域内的用户账户（存储在域控制器内）。</p><h4 id="信任（Trust）"><a href="#信任（Trust）" class="headerlink" title="信任（Trust）"></a>信任（Trust）</h4><p>​    两个域之间必须拥有信任关系（trust relationship)，才可以访问对方域内的资源。而任何一个新的AD DS域被加入到域树后，这个域会自动信任其上一层的父域，同时父域也会自动信任此新子域，而且这些信任关系具有双向传递性（two-way transitive）。由于此信任工作是通过Kerberos security protocol来完成的，因此也被称为Kerberos trust。</p><ul><li>域A的用户登录到其所隶属的域后，这个用户是否能够访问域B的资源呢？</li><li>只要域B信任域A就没有问题。</li></ul><p>我们以图1-4为例来解释双向传递性，图中域A信任域B（箭头由A指向B）、域B又信任域C，因此域A会自动信任域C；另外域C信任域B（箭头由C指向B）、域B又信任域A，因此域C会自动信任域A。结果是域A和域C之间也就自动地建立起双向的信任关系。</p><p>所以当任何一个新域加入到域树后，它会自动双向信任这个域树内所有的域，因此只要拥有适当权限，这个新域内的用户便可以访问其他域内的资源，同理其他域内的用户也可以访问这个新域内的资源。</p><p><a href="https://imgtu.com/i/IBD3M4"><img src="https://z3.ax1x.com/2021/11/12/IBD3M4.png" alt="IBD3M4.png"></a></p><h4 id="林（Forest"><a href="#林（Forest" class="headerlink" title="林（Forest)"></a>林（Forest)</h4><p>​    林由一个或多个域树组成，每一个域树都有自己唯一的名称空间，如图1-5所示，其中一个域树内的每一个域名都以sayms.local结尾，而另一个则都以saytmg.local结尾。</p><p>​    第一个域树的根域，就是整个林的根域（forest root domain)，同时其域名就是林的林名称。例如图1-5中的sayms.local是第一个域树的根域，它就是整个林的根域，而林名称就是sayms.local。</p><p>​    在建立林时，每一个域树的根域与林根域之间双向的、可传递的信任关系都会自动地被建立起来，因此每一个域树中的每一个域内的用户，只要拥有权限，就可以访问其他任何一个域树内的资源，也可以到其他任何一个域树内的成员计算机登录。</p><p><a href="https://imgtu.com/i/IBDYZR"><img src="https://z3.ax1x.com/2021/11/12/IBDYZR.png" alt="IBDYZR.png"></a></p><h4 id="架构（Schema）"><a href="#架构（Schema）" class="headerlink" title="架构（Schema）"></a>架构（Schema）</h4><p>​    AD DS对象类型与属性数据是定义在<strong>架构</strong>内的，例如它定义了用户对象类型内包含哪些属性（姓、名、电话等）、每一个属性的数据类型等信息。</p><p>​    隶属于Schema Admins组的用户可以修改<strong>架构</strong>内的数据，应用程序也可以自行在<strong>架构</strong>内添加其所需的对象类型或属性。在一个林内的所有域树共享相同的架构。</p><h4 id="域控制器（Domain-Controller"><a href="#域控制器（Domain-Controller" class="headerlink" title="域控制器（Domain Controller)"></a>域控制器（Domain Controller)</h4><p>​    <strong>Active Directory域服务</strong>（AD DS）的目录数据是存储在域控制器内的。一个域内可以有多台域控制器，每一个域控制器的地位（几乎）是平等的，它们各自存储着一份相同的AD DS数据库。当您在任何一台域控制器内添加一个用户账户后，此账户默认被建立在此域控制器的AD DS数据库中，之后会自动被复制（replicate）到其他域控制器的AD DS数据库（如图1-6），以便让所有域控制器内的AD DS数据库都能够同步（synchronize）。</p><p><a href="https://imgtu.com/i/IBDNIx"><img src="https://z3.ax1x.com/2021/11/12/IBDNIx.png" alt="IBDNIx.png"></a></p><p>​    当用户在某台域成员计算机登录时，会由其中一台域控制器根据AD DS数据库内的账户数据，来验证该用户所输入的账户名称与密码是否正确。若输入正确，用户就可以成功登录；反之，会被拒绝登录、</p><p>​    多台域控制器可以提供容错功能，也就是即使由一台域控制器故障了，仍然能够由其他域控制器来提供服务。另外它也可以改善用户登录效率，因为多台域控制器可以分担验证用户登录身份（账户名称与密码）的负担。</p><p>​    域控制器是由服务器级别的计算机来承担的，例如Windows Server 2019（R2）、Windows Server 2019（R2）等。</p><h4 id="只读域控制器（RODC）"><a href="#只读域控制器（RODC）" class="headerlink" title="只读域控制器（RODC）"></a>只读域控制器（RODC）</h4><p>​    <strong>只读域控制器</strong>（Read-Only Domain Controller，RODC）的AD DS数据库只可以被读取，不可以被修改，也就是说用户或应用程序无法直接修改RODC的AD DS数据库。RODC的AD DS数据库内容只能够从其他<strong>可读写的域控制器</strong>复制过来。RODC主要是设计给远程分公司网络来使用的，因为一般来说远程分公司的网络规模比较小、用户人数比较少，此网络的安全措施或许并不如总公司完备，也可能缺乏IT技术人员，因此采用RODC可避免因其AD DS数据库被破坏而影响到整个AD DS环境。</p><ol><li><strong>RODC 的 AD DS 数据库内容</strong></li></ol><p>除了账户的密码之外，RODC的AD DS数据库内会存储AD DS域内所有对象与属性。远程分公司内的应用程序要读取到AD DS数据库内的对象时，可以通过RODC来快速获取。不过因为RODC并不存储用户账户密码，因此它在验证用户名称与密码时，仍然需将它们送到总公司的可写域控制器来验证。</p><p>由于RODC的AD DS数据库是只读的，因此远程分公司的应用程序如果要修改AD DS数据库的对象或用户要修改密码，这些变更请求都会被转发到总公司的可写域控制器来处理，总公司的可写域控制器再通过AD DS数据库的复制程序将这些变动数据复制到RODC。</p><ol start="2"><li><strong>单向复制（Unidirectional Replication）</strong></li></ol><p>总公司的可写域控制器的AD DS数据库有变动时，此变动数据会被复制到RODC。然而因为用户或应用程序无法直接修改RODC的AD DS数据库，故总公司的可写域控制器不会向RODC索取变动数据，因而可以降低网络的负担。</p><p>除此之外，可写域控制器通过DFS分布式文件系统将SYSVOL文件夹（用来存储与组策略有关等的设置）复制给RODC时，也采用单向复制。</p><ol start="3"><li><strong>认证缓存（Credential caching)</strong></li></ol><p>RODC在验证用户的密码时，仍然需要将它们送到总公司的可写域控制器来验证，若希望提高验证速度，可以选择将用户的密码存储到RODC的认证缓存区，您需要通过<strong>密码复制策略</strong>（Password Replication Policy）来选择可以被RODC缓存的账户。建议不要缓存太多账户，因为分公司的安全措施可能比较差，若RODC被入侵，则存储在缓存内的认证信息可能会外泄。</p><ol start="4"><li><strong>系统管理员角色隔离（Administrator Role Separation）</strong></li></ol><p>您可以通过<strong>系统管理角色隔离</strong>功能来将任何一位域用户指定为RODC的本机系统管理员，他可以在RODC这台域控制器上登录并执行管理工作，例如更新驱动程序等，但他却无法登录其他域控制器，也无法执行其他域管理工作。此功能让您可以将RODC的一般管理工作分配给用户，但却不会危害到域安全。</p><ol start="5"><li><strong>只读域名系统（Read-Only Domain Name System)</strong></li></ol><p>您可以在RODC上架设DNS服务器，RODC会复制DNS服务器的所有应用程序目录分区。客户端可向此台扮演RODC角色的DNS服务器提供DNS查询要求。</p><p>不过RODC的DNS服务器不支持客户端动态更新，因此客户端的更新记录请求，会被此DNS服务器转发到其他DNS服务器，让客户端转向该DNS服务器进行更新，而RODC的DNS服务器也会自动从这台DNS服务器复制该更新记录。</p><h4 id="可重新启动的AD-DS（Restartable-AD-DS）"><a href="#可重新启动的AD-DS（Restartable-AD-DS）" class="headerlink" title="可重新启动的AD DS（Restartable AD DS）"></a>可重新启动的AD DS（Restartable AD DS）</h4><p>​    在旧版Windows域控制器内，若要进行AD DS数据库维护工作（例如数据库脱机重整），就需要重新启动计算机，进入<strong>目录服务还原模式</strong>（Directory Service Restore Mode）来执行维护工作。若这台域控制器也同时提供其他网络服务，例如它同时也是DHCP服务器，则重新启动计算机将造成这些服务暂时中断。</p><p>​    除了进入<strong>目录服务还原模式</strong>之外，Windows Server 2019 （R2）等域控制器还提供<strong>可重新启动的AD DS</strong>功能，也就是说若要执行AD DS数据库维护工作，只需要将AD DS服务停止即可，不需要重新启动计算机来进入目录服务还原模式，这样不但可以让AD DS数据库的维护工作更容易、更快速地完成，而且其他服务也不会中断。完成维护工作后再重新启动AD DS服务即可。</p><p>​    在AD DS服务停止的情况下，只要还有其他域控制器在线，则仍然可以在这台AD DS服务停止的域控制器上利用域用户账户登录。若没有其他域控制器在线，则在这台AD DS服务已停止的域控制器上，默认只能够利用<strong>目录服务还原模式</strong>的系统管理员账户来进入<strong>目录服务还原模式</strong>。</p><h4 id="Active-Directory回收站"><a href="#Active-Directory回收站" class="headerlink" title="Active Directory回收站"></a>Active Directory回收站</h4><p>​    在旧版Windows系统中，系统管理员若不小心将AD DS对象删除，其恢复过程耗时耗力，例如误删组织单位，其内所有对象都会丢失，此时虽然系统管理员可以进行<strong>目录服务还原模式</strong>来恢复被误删的对象，不过比较耗费时间，而且在进入<strong>目录服务还原模式</strong>这段时间内，域控制器会暂时停止对客户端提供服务。Windows Server 2019（R2）具备<strong>Active Directory回收站</strong>功能，它让系统管理员不需要进入<strong>目录服务还原模式</strong>，就可以快速恢复被删除的对象。</p><h4 id="AD-DS的复制模式"><a href="#AD-DS的复制模式" class="headerlink" title="AD DS的复制模式"></a>AD DS的复制模式</h4><p>​    域控制器之间在复制AD DS数据库时，分为下面两种复制模式。</p><ol><li><strong>多主机复制模式（multi-master replication model）：</strong>AD DS数据库内的大部分数据是利用此模式进行复制操作的。在此模式下，您可以直接更新任何一台域控制器内的AD DS对象，之后这个更新过的对象会被自动复制到其他域控制器。例如您在任何一台域控制器的AD DS数据库内添加一个用户账户后，此账户会自动被复制到域内的其他域控制器。</li><li><strong>单主机复制模式（single-master replication model）：</strong>AD DS数据库内少部分数据是采用<strong>单主机复制模式</strong>进行复制的，在此模式下，当您提出修改对象数据的请求时，会由其中一台域控制器（被成为<strong>操作主机</strong>）负责接收与处理此请求，也就是说该对象是先在<strong>操作主机</strong>中被更新，再由<strong>操作主机</strong>将它复制给其他域控制器。例如添加或删除一个域时，此变动数据会先被写入到扮演<strong>域命名操作主机</strong>角色的域控制器内，再由它复制给其他域控制器。</li></ol><h4 id="域中的其他成员计算机"><a href="#域中的其他成员计算机" class="headerlink" title="域中的其他成员计算机"></a>域中的其他成员计算机</h4><p>​    若要充分管理网络内的计算机，请将它们加入域。用户在域成员计算机上才能利用AD DS数据库内的域用户账户来登录，在未加入域的计算机上只能够使用本机用户账户登录。域内的成员计算机如下。</p><p>成员计算机（member server），例如：</p><ul><li><p>Windows Server 2019 （R2）Datacenter/Standard</p></li><li><p>Windows Server 2016 （R2）Datacenter/Standard</p></li><li><p>Windows Server 2012 （R2）Datacenter/Standard</p></li></ul><p>上述服务器级别的计算机加入域后被称为<strong>成员服务器</strong>，但其并不存储AD DS数据库，它们也不负责验证AD DS域用户名称与密码，而是将其转发给域控制器来验证。未加入域的服务器被称为<strong>独立服务器</strong>或<strong>工作组服务器</strong>。但不论是独立或成员服务器都由<strong>本地安全账户数据库（SAM）</strong>，系统可以利用它来验证本地用户（非AD DS域成员）的身份。</p><p>其他常用的Windows计算机，例如：</p><ul><li>Windows 10 Enterprise</li><li>Windows 7 Professional</li></ul><p>在上述客户端计算机加入域以后，用户就可以在这些计算机上利用AD DS内的账户来登录，否则只能够利用本地账户来登录。</p><p>一些入门级的客户端计算机（例如Windows 8.1 Standard等）无法加入域。</p><p>您可以将Windows Server 2019（R2）、Windows Server 2016（R2）等独立或成员服务器生升级为域控制器，也可以将域控制器降级为独立或成员服务器。</p><h4 id="DNS服务器"><a href="#DNS服务器" class="headerlink" title="DNS服务器"></a>DNS服务器</h4><p>​    域控制器需要将自己登记到DNS服务器内，以便让其他计算机通过DNS服务器来找到这台域控制器，因此域环境需要有可支持AD DS的DNS服务器。此服务器最好支持<strong>动态更新</strong>（dynamic update）功能，以便当域控制器的角色发生变化或域成员计算机的IP地址等数据发生变化时，可以自动更新DNS服务器内的记录。</p><h4 id="轻型目录访问协议（LDAP）"><a href="#轻型目录访问协议（LDAP）" class="headerlink" title="轻型目录访问协议（LDAP）"></a>轻型目录访问协议（LDAP）</h4><p>​    LDAP（lightweight Directory Access Protocol）是一种用来查询与更新AD DS的目录服务通信协议。AD DS利用<strong>LDAP名称路径</strong>（LDAP naming path）来描述对象在AD DS内的位置，以便用它来访问AD DS对象。<strong>LDAP名称路径</strong>如下。</p><ul><li>Distinguished Name（DN）：它是对象在AD DS内的完整路径，例如图1-7中的用户账户名称为<strong>林小洋</strong>，其DN为：</li></ul><p>CN=林小洋，OU=业务一组，OU=业务部，DC=sayms，DC=local</p><p>其中的DC（Domain Component）表示DNS域名中的组件，例如sayms.local中的sayms与local；OU为组织单位；CN为Common Name。除了DC与OU之外，其他都利用CN来表示，例如用户与计算机对象都属于CN。上述DN表示法中的<strong>sayms.local</strong>为域名，<strong>业务部</strong>，<strong>业务一组</strong>都是组织单位。此DN表示账户<strong>林小洋</strong>存储在<strong>sayms.local\业务部\业务一组</strong>路径内</p><p><a href="https://imgtu.com/i/IBD0zD"><img src="https://z3.ax1x.com/2021/11/12/IBD0zD.png" alt="IBD0zD.png"></a></p><ul><li><strong>Relative Distinguished Name（RDN）：</strong>RND是用来代表DN完整路径中的部分路径，例如前述路径中，CN=林小洋与OU=业务一组等都是RDN。</li></ul><p>除了DN与RDN这两个对象名称外，还有以下名称。</p><ul><li><p>Global Unique Identifier（GUID）：系统会自动为每一个对象指定一个唯一的，128位数值的GUID。虽然可以改变对象名称，但其GUID永远不会改变。</p></li><li><p>User Principal Name（UPN）：每一个使用者还可以有一个比DN更短，更容易记忆的UPN，例如图1-7中的林小洋隶属于域sayms.local，则UPN可为<a href="mailto:&#98;&#x6f;&#98;&#x40;&#115;&#x61;&#x79;&#109;&#115;&#46;&#x6c;&#111;&#99;&#x61;&#108;">&#98;&#x6f;&#98;&#x40;&#115;&#x61;&#x79;&#109;&#115;&#46;&#x6c;&#111;&#99;&#x61;&#108;</a>。用户登录时所输入的账户名称最好使用UPN，因为无论此用户账户被移动到哪一个域，其UPN都不会变化，因此用户可以一直用同一个名称来登录。</p></li><li><p>Service Principal Name（SPN）：SPN是一个包含多重设定值的名称，它是根据DNS主机来建立的。SPN用来代表某台计算机所支持的服务，它让其他计算机都可以通过SPN来与这台计算机的服务进行交互。</p></li></ul><h4 id="全局编录（Global-Cacalog）"><a href="#全局编录（Global-Cacalog）" class="headerlink" title="全局编录（Global Cacalog）"></a>全局编录（Global Cacalog）</h4><p>​    虽然在域树内的所有域共享一个AD DS数据库，但其数据却分散在各个域内，而每一个域只存储该域本身的数据。为了让用户、应用程序能够快速找到位于其他域内的资源，因此在AD DS内设计了<strong>全局编录</strong>（global catalog）。一个林内的所有域树共享相同的<strong>全局编录</strong>。</p><p>​    全局编录的数据存储在域控制器内，这台域控制器可被称为<strong>全局编录服务器</strong>，它存储着林内所有域的AD DS数据库内的每一个对象，不过只存储对象的部分属性，这些属性都是常用的、用来对对象进行搜索的属性，例如用户的电话号码、登录账户名称等。<strong>全局编录</strong>让用户即使不知道对象位于哪一个域内，仍然可以很快速地找到所需对象。</p><p>​    用户登录时，<strong>全局编录服务器</strong>还负责提供该用户所隶属的<strong>通用组</strong>信息；用户利用UPN登录时，它也负责提供该用户隶属于哪一个域的信息。</p><h4 id="站点（Site）"><a href="#站点（Site）" class="headerlink" title="站点（Site）"></a>站点（Site）</h4><p>​    <strong>站点</strong>由一个或多个IP子网所组成，这些子网之间通过<strong>高速且可靠的链路</strong>连接在一起，也就是说这些子网之间的连接速度要够快且稳定、符合您的需求，否则您就应该将它们分别规划为不同的站点。</p><p>一般来说，一个LAN（局域网）之内的各个子网之间的连接都符合速度快且高可靠度的要求，因此可以将一个LAN规划为一个站点；而WAN（广域网）内的各个LAN之间的连接速度一般都不快，因此WAN之中的各个LAN应分别规划为不同的站点，如图1-8所示。</p><p>​    域是逻辑的（logical）分组，而站点则是实体的（physical）分组。在AD DS内每一个站点可能包含多个域；而一个域内的各个计算机也可能分布在不同的站点内。</p><p>​    若一个域的控制器分布在不同站点内，而站点之间是低速连接，由于不同站点的域控制器之间会互相复制AD DS数据库，因此需谨慎规划执行复制的时段，也就是尽量在非高峰时期才执行复制工作，同时复制频率不要太高，以避免复制时占用站点之间连接的带宽，影响站点之间其他数据的传输效率。</p><p><a href="https://imgtu.com/i/IBDsLd"><img src="https://z3.ax1x.com/2021/11/12/IBDsLd.png" alt="IBDsLd.png"></a></p><p>图1-8</p><p>​    同一个站点内的域控制器之间是通过快速链路连接在一起的，因此在复制AD DS数据时，可以快速复制。AD DS的默认设置会让同一个站点内、隶属于同一个域的域控制器之间自动执行复制工作，且默认的复制频率也比不同站点之间要搞。</p><p>​    不同站点之间在复制时数据会被压缩后再传输，以减少站点之间网络带宽的负担；但是同一个站点内的域控制器之间在复制时数据并不会压缩后传输。</p><h4 id="目录分区（Directory-Partition）"><a href="#目录分区（Directory-Partition）" class="headerlink" title="目录分区（Directory Partition）"></a>目录分区（Directory Partition）</h4><p>AD DS数据库被逻辑的分为下面4个目录分区</p><ul><li><strong>架构目录分区（Schema Directory Partition）</strong>：它存储着整个林中所有对象与属性的定义数据，也存储着如何建立新对象与属性的规则。整个林内所有域共享一份相同的架构目录分区，也存储着如何建立新对象与属性规则。整个林内所有域共享一份相同的<strong>架构目录分区</strong>，它会被复制到林中所有域的所有域控制器。</li><li><strong>配置目录分区（Configuration Directory Partition）</strong>：其内存储着整个AD DS的结构，例如有哪些域、哪些站点、哪些域控制器等数据。整个林共享一份相同的<strong>配置目录分区</strong>，它会被复制到林中所有域的所有域控制器。</li><li><strong>域目录分区（Domain Directory Partition）</strong>：每一个域各有一个<strong>域目录分区</strong>。，，其内存储着与该域有关的对象，例如用户，组与计算机等对象。每一个域各自拥有一份<strong>域目录分区</strong>，它只会被复制到该域内所有域控制器，但并不会被复制到其他域的域控制器。</li><li><strong>应用程序目录分区（Application Directory Partition）：</strong>一般来说，<strong>应用程序目录分区</strong>是由应用程序所建立的，其内存储着与该应用程序有关的数据。例如由WindowsServer2019 R2扮演的DNS服务器，若所建立的DNS区域为Active Directory<strong>集成区域</strong>的话，则它便会在AD DS数据库内建立<strong>应用程序目录分区</strong>，以便存储该区域的数据。<strong>应用程序目录分区</strong>会被复制到林中特定的域控制器中，而不是所有的域控制器。</li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;/assets/css/APlayer.min.css&quot;&gt;&lt;script src=&quot;/assets/js/APlayer.min.js&quot; cla</summary>
      
    
    
    
    <category term="Windows" scheme="https://www.hnswxx.cn/categories/Windows/"/>
    
    
    <category term="WindowServer2019" scheme="https://www.hnswxx.cn/tags/WindowServer2019/"/>
    
  </entry>
  
  <entry>
    <title>创建自签名证书</title>
    <link href="https://www.hnswxx.cn/2021/11/11/self-signed-certificate/"/>
    <id>https://www.hnswxx.cn/2021/11/11/self-signed-certificate/</id>
    <published>2021-11-11T13:42:31.000Z</published>
    <updated>2021-11-12T03:12:34.684Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h3 id="常规方式"><a href="#常规方式" class="headerlink" title="常规方式"></a>常规方式</h3><p><strong>生成私钥</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">openssl genrsa -out ca.key </span><br><span class="line">Generating RSA private key, 2048 bit long modulus (2 primes) .....................................................+++++ ................................................................................ </span><br><span class="line">...+++++ </span><br><span class="line">e is 65537 (0x010001)</span><br></pre></td></tr></table></figure><p><strong>生成证书请求文件</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">openssl req -new -key ca.key -out ca.csr </span><br><span class="line">You are about to be asked to enter information that will be incorporated</span><br><span class="line">into your certificate request. </span><br><span class="line">What you are about to enter is what is called a Distinguished Name or a DN.</span><br><span class="line">There are quite a few fields but you can leave some blank </span><br><span class="line">For some fields there will be a default value, </span><br><span class="line">If you enter &#x27;.&#x27;, the field will be left blank. </span><br><span class="line">----- </span><br><span class="line">Country Name (2 letter code) [XX]:CN </span><br><span class="line"><span class="meta">#</span><span class="bash">国家</span> </span><br><span class="line">State or Province Name (full name) []:Henan </span><br><span class="line"><span class="meta">#</span><span class="bash">省份</span> </span><br><span class="line">Locality Name (eg, city) [Default City]:ZhengZhou </span><br><span class="line"><span class="meta">#</span><span class="bash">城市</span> </span><br><span class="line">Organization Name (eg, company) [Default Company Ltd]:skills </span><br><span class="line"><span class="meta">#</span><span class="bash">组织</span> </span><br><span class="line">Organizational Unit Name (eg, section) []:skills #组织单位 </span><br><span class="line">Common Name (eg, your name or your server&#x27;s hostname) []:www.test.com </span><br><span class="line"><span class="meta">#</span><span class="bash">域名</span> </span><br><span class="line">Email Address []: </span><br><span class="line">Please enter the following &#x27;extra&#x27; attributes</span><br><span class="line">to be sent with your certificate request </span><br><span class="line">A challenge password []:</span><br><span class="line">An optional company name []:</span><br></pre></td></tr></table></figure><p><strong>生成自我签署的证书文件</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">openssl x509 -req -days 365 -in ca.csr -signkey ca.key -out ca.crt</span><br><span class="line">Signature ok </span><br><span class="line">subject=C = CN, ST = Henan, L = ZhengZhou, O = skills, OU = skills, CN = www.test.com </span><br><span class="line">Getting Private key</span><br></pre></td></tr></table></figure><p><strong>查看证书信息</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">查看证书信息</span> </span><br><span class="line">openssl x509 -in ca.crt -noout -text </span><br><span class="line">Certificate: </span><br><span class="line">Data:</span><br><span class="line">Version: 1 (0x0) </span><br><span class="line">Serial Number: </span><br><span class="line">08:31:4f:7e:3f:fa:93:00:b5:bc:14:e9:a4:d9:ce:3b:f0:f2:44:af </span><br><span class="line">Signature Algorithm: sha256WithRSAEncryption </span><br><span class="line">Issuer: C = CN, ST = Henan, L = ZhengZhou, O = skills, OU = skills, CN = www.test.com </span><br><span class="line">Validity </span><br><span class="line">Not Before: Mar 23 01:29:34 2021 GMT </span><br><span class="line">Not After : Mar 23 01:29:34 2022 GMT </span><br><span class="line">Subject: C = CN, ST = Henan, L = ZhengZhou, O = skills, OU = skills, CN = www.test.com </span><br><span class="line">Subject Public Key Info: </span><br><span class="line">Public Key Algorithm: rsaEncryption </span><br><span class="line">RSA Public-Key: (2048 bit) </span><br><span class="line">Modulus: </span><br><span class="line">00:ba:f8:ea:26:e3:19:42:8c:f0:a7:f6:f8:b6:f9:</span><br><span class="line">eb:20:39:f0:02:86:5d:f1:e1:ba:db:bc:f8:ed:68: </span><br><span class="line">98:42:52:0a:9d:a5:8e:52:04:10:83:a7:70:bb:ea: </span><br><span class="line">b8:79:dc:b7:15:99:7e:90:09:5b:e8:b0:03:2c:4c: </span><br><span class="line">7d:a2:e6:b9:85:c1:2b:48:c9:7b:68:3b:28:83:88: </span><br><span class="line">d4:c2:37:ee:c8:89:f9:70:ad:91:84:bf:3c:d8:83: </span><br><span class="line">60:be:62:92:7d:81:e3:5d:cd:36:d0:ef:5e:ca:e0: </span><br><span class="line">44:fc:96:5c:11:e1:4d:fe:af:ff:4d:2b:d1:99:4a: </span><br><span class="line">9f:fc:2c:0b:57:03:fe:44:72:16:cf:3a:65:4d:05: </span><br><span class="line">c2:75:31:f8:9d:ca:9a:bc:93:75:8c:21:36:d6:39: </span><br><span class="line">b2:69:4f:d3:8c:0d:cd:1a:f6:c4:b4:a6:15:a3:95: </span><br><span class="line">91:a0:13:f5:46:36:d0:bb:30:fc:11:fc:f9:e8:88: </span><br><span class="line">13:41:b3:97:d9:71:35:43:7c:1f:19:cb:06:88:74: </span><br><span class="line">bf:c7:3b:fe:1c:1a:8e:92:a3:9c:d1:11:54:0e:fb: </span><br><span class="line">b0:f1:61:ae:46:ee:f0:b2:11:03:26:05:f7:13:78: </span><br><span class="line">d8:52:25:8f:97:cc:4c:04:9f:00:73:70:83:2a:75: </span><br><span class="line">07:54:8d:42:78:ea:85:f8:2a:72:f9:15:94:04:7b: 8e:65 </span><br><span class="line">Exponent: 65537 (0x10001) </span><br><span class="line">Signature Algorithm: sha256WithRSAEncryption </span><br><span class="line">6c:ee:9b:7b:b3:dd:1a:96:29:ab:65:25:fd:27:31:19:57:4c:</span><br><span class="line">d3:7c:94:22:f1:12:b8:8f:14:e3:7e:69:7e:a9:e1:08:fc:24:</span><br><span class="line">3f:ae:69:d9:79:dd:86:b0:f1:3f:1f:fe:51:e4:e2:91:70:08:</span><br><span class="line">f2:2c:b2:91:41:f0:63:83:2b:54:e2:90:53:15:6e:84:9c:f4:</span><br><span class="line">32:cd:f6:0d:08:c7:90:ef:b4:0c:6d:fb:99:62:6f:73:f7:fb:</span><br><span class="line">c8:62:cd:39:ce:71:d4:34:54:65:88:bb:b6:92:9d:b0:df:35:</span><br><span class="line">b0:17:45:c9:77:f4:f0:1d:3e:f3:a8:e8:53:d0:fe:70:fb:79:</span><br><span class="line">b9:51:ae:c4:ba:2e:96:54:bc:d3:a5:1c:f1:d0:7e:17:56:7d:</span><br><span class="line">9b:90:d6:b2:7d:59:ec:37:09:5d:6c:0a:9c:99:03:96:ed:8a:</span><br><span class="line">8e:79:e9:2f:05:e3:92:45:49:7a:50:de:0e:48:32:64:11:1a:</span><br><span class="line">b6:fd:d2:84:8e:44:c2:98:e4:e5:a3:92:3b:f0:32:63:94:a9:</span><br><span class="line">9f:c1:ba:31:09:e9:02:86:f6:2a:8b:1a:26:88:8b:40:c2:ec:</span><br><span class="line">af:61:c6:46:67:db:c2:6c:48:b0:a5:d6:4f:5f:2e:8f:5e:6c:</span><br><span class="line">cd:16:78:dc:64:53:de:81:1b:21:b3:77:59:b5:80:1f:7e:8b: </span><br><span class="line">6a:bf:75:53</span><br></pre></td></tr></table></figure><h3 id="centos7一键生成方式"><a href="#centos7一键生成方式" class="headerlink" title="centos7一键生成方式"></a>centos7一键生成方式</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">进入该目录 执行make命令一键生出带密码的公钥和私钥</span> </span><br><span class="line">/etc/pki/tls/certs </span><br><span class="line">make ca.crt </span><br><span class="line">umask 77 ; \ </span><br><span class="line">/usr/bin/openssl genrsa -aes128 2048 &gt; ca.key </span><br><span class="line">Generating RSA private key, 2048 bit long modulus </span><br><span class="line">...+++ </span><br><span class="line">.........+++ </span><br><span class="line">e is 65537 (0x10001) </span><br><span class="line">Enter pass phrase: </span><br><span class="line"><span class="meta">#</span><span class="bash">密码</span> </span><br><span class="line">Verifying - Enter pass phrase: </span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">密码</span> </span><br><span class="line">umask 77 ; \ </span><br><span class="line">/usr/bin/openssl req -utf8 -new -key ca.key -x509 -days 365 -out ca.crt </span><br><span class="line">Enter pass phrase for ca.key: </span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">密码</span> </span><br><span class="line">You are about to be asked to enter information that will be incorporated </span><br><span class="line">into your certificate request. </span><br><span class="line">What you are about to enter is what is called a Distinguished Name or a DN. </span><br><span class="line">There are quite a few fields but you can leave some blank </span><br><span class="line">For some fields there will be a default value, </span><br><span class="line">If you enter &#x27;.&#x27;, the field will be left blank. </span><br><span class="line">\----- </span><br><span class="line">Country Name (2 letter code) [XX]:CN </span><br><span class="line">State or Province Name (full name) []:Henan </span><br><span class="line">Locality Name (eg, city) [Default City]:Zhengzhou </span><br><span class="line">Organization Name (eg, company) [Default Company Ltd]:skills </span><br><span class="line">Organizational Unit Name (eg, section) []:skills </span><br><span class="line">Common Name (eg, your name or your server&#x27;s hostname) []:www.test.com </span><br><span class="line">Email Address []: </span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">取消私钥密码</span> </span><br><span class="line">openssl rsa -in ca.key -out ca.key1 </span><br><span class="line">Enter pass phrase for ca.key: </span><br><span class="line">writing RSA key </span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">查看证书信息</span> </span><br><span class="line">openssl x509 -in ca.crt -noout -text </span><br><span class="line">Certificate: </span><br><span class="line">Data:</span><br><span class="line">Version: 3 (0x2) </span><br><span class="line">Serial Number: </span><br><span class="line">ff:aa:92:0b:bb:ff:a4:06 </span><br><span class="line">Signature Algorithm: sha256WithRSAEncryption </span><br><span class="line">Issuer: C=CN, ST=Henan, L=Zhengzhou, O=skills, OU=skills, </span><br><span class="line">CN=www.test.com </span><br><span class="line">Validity </span><br><span class="line">Not Before: Mar 23 09:49:47 2021 GMT </span><br><span class="line">Not After : Mar 23 09:49:47 2022 GMT </span><br><span class="line">Subject: C=CN, ST=Henan, L=Zhengzhou, O=skills, OU=skills, </span><br><span class="line">CN=www.test.com </span><br><span class="line">Subject Public Key Info: </span><br><span class="line">Public Key Algorithm: rsaEncryption </span><br><span class="line">Public-Key: (2048 bit</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;/assets/css/APlayer.min.css&quot;&gt;&lt;script src=&quot;/assets/js/APlayer.min.js&quot; cla</summary>
      
    
    
    
    <category term="Linux" scheme="https://www.hnswxx.cn/categories/Linux/"/>
    
    
    <category term="证书" scheme="https://www.hnswxx.cn/tags/%E8%AF%81%E4%B9%A6/"/>
    
  </entry>
  
  <entry>
    <title>Hello World</title>
    <link href="https://www.hnswxx.cn/2021/11/11/hello-world/"/>
    <id>https://www.hnswxx.cn/2021/11/11/hello-world/</id>
    <published>2021-11-11T10:01:53.100Z</published>
    <updated>2021-11-11T11:24:32.095Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;/assets/css/APlayer.min.css&quot;&gt;&lt;script src=&quot;/assets/js/APlayer.min.js&quot; cla</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>数字签名是什么？</title>
    <link href="https://www.hnswxx.cn/2021/11/11/what-is-a-digital-signature/"/>
    <id>https://www.hnswxx.cn/2021/11/11/what-is-a-digital-signature/</id>
    <published>2021-11-10T23:29:08.000Z</published>
    <updated>2021-11-11T12:38:07.165Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>鲍勃有两把钥匙，一把是公钥，另一把是私钥。<br><a href="https://imgtu.com/i/I0Nuzn"><img src="https://z3.ax1x.com/2021/11/11/I0Nuzn.png" alt="I0Nuzn.png"></a></p><p>鲍勃把公钥送给他的朋友们—-帕蒂、道格、苏珊—-每人一把。<br><a href="https://imgtu.com/i/I0NYi4"><img src="https://z3.ax1x.com/2021/11/11/I0NYi4.png" alt="I0NYi4.png"></a></p><p>苏珊要给鲍勃写一封保密的信。她写完后用鲍勃的公钥加密，就可以达到保密的效果。<br><a href="https://imgtu.com/i/I0NdQ1"><img src="https://z3.ax1x.com/2021/11/11/I0NdQ1.png" alt="I0NdQ1.png"></a></p><p>鲍勃收信后，用私钥解密，就看到了信件内容。这里要强调的是，只要鲍勃的私钥不泄露，这封信就是安全的，即使落在别人手里，也无法解密。<br><a href="https://imgtu.com/i/I0UKte"><img src="https://z3.ax1x.com/2021/11/11/I0UKte.png" alt="I0UKte.png"></a></p><p>鲍勃给苏珊回信，决定采用”数字签名”。他写完后先用Hash函数，生成信件的摘要（digest）。<br><a href="https://imgtu.com/i/I0U36I"><img src="https://z3.ax1x.com/2021/11/11/I0U36I.png" alt="I0U36I.png"></a></p><p>然后，鲍勃使用私钥，对这个摘要加密，生成”数字签名”（signature）。<br><a href="https://imgtu.com/i/I0UY0f"><img src="https://z3.ax1x.com/2021/11/11/I0UY0f.png" alt="I0UY0f.png"></a></p><p>鲍勃将这个签名，附在信件下面，一起发给苏珊。<br><a href="https://imgtu.com/i/I0Uatg"><img src="https://z3.ax1x.com/2021/11/11/I0Uatg.png" alt="I0Uatg.png"></a></p><p>苏珊收信后，取下数字签名，用鲍勃的公钥解密，得到信件的摘要。由此证明，这封信确实是鲍勃发出的。<br><a href="https://imgtu.com/i/I0UB1s"><img src="https://z3.ax1x.com/2021/11/11/I0UB1s.png" alt="I0UB1s.png"></a></p><p>苏珊再对信件本身使用Hash函数，将得到的结果，与上一步得到的摘要进行对比。如果两者一致，就证明这封信未被修改过。<br><a href="https://imgtu.com/i/I0Uyn0"><img src="https://z3.ax1x.com/2021/11/11/I0Uyn0.png" alt="I0Uyn0.png"></a></p><p>复杂的情况出现了。道格想欺骗苏珊，他偷偷使用了苏珊的电脑，用自己的公钥换走了鲍勃的公钥。此时，苏珊实际拥有的是道格的公钥，但是还以为这是鲍勃的公钥。因此，道格就可以冒充鲍勃，用自己的私钥做成”数字签名”，写信给苏珊，让苏珊用假的鲍勃公钥进行解密。<br><a href="https://imgtu.com/i/I0U2AU"><img src="https://z3.ax1x.com/2021/11/11/I0U2AU.png" alt="I0U2AU.png"></a></p><p>后来，苏珊感觉不对劲，发现自己无法确定公钥是否真的属于鲍勃。她想到了一个办法，要求鲍勃去找”证书中心”（certificate authority，简称CA），为公钥做认证。证书中心用自己的私钥，对鲍勃的公钥和一些相关信息一起加密，生成”数字证书”（Digital Certificate）。<br><a href="https://imgtu.com/i/I0URNF"><img src="https://z3.ax1x.com/2021/11/11/I0URNF.png" alt="I0URNF.png"></a></p><p>鲍勃拿到数字证书以后，就可以放心了。以后再给苏珊写信，只要在签名的同时，再附上数字证书就行了。<br><a href="https://imgtu.com/i/I0Uh9J"><img src="https://z3.ax1x.com/2021/11/11/I0Uh9J.png" alt="I0Uh9J.png"></a></p><p>苏珊收信后，用CA的公钥解开数字证书，就可以拿到鲍勃真实的公钥了，然后就能证明”数字签名”是否真的是鲍勃签的。<br><a href="https://imgtu.com/i/I0UHHK"><img src="https://z3.ax1x.com/2021/11/11/I0UHHK.png" alt="I0UHHK.png"></a></p><p>下面，我们看一个应用”数字证书”的实例：https协议。这个协议主要用于网页加密。<br><a href="https://imgtu.com/i/I0UzjI"><img src="https://z3.ax1x.com/2021/11/11/I0UzjI.png" alt="I0UzjI.png"></a></p><p>首先，客户端向服务器发出加密请求。<br><a href="https://imgtu.com/i/I0aCHf"><img src="https://z3.ax1x.com/2021/11/11/I0aCHf.png" alt="I0aCHf.png"></a></p><p>服务器用自己的私钥加密网页以后，连同本身的数字证书，一起发送给客户端。<br><a href="https://imgtu.com/i/I0aECQ"><img src="https://z3.ax1x.com/2021/11/11/I0aECQ.png" alt="I0aECQ.png"></a></p><p>客户端（浏览器）的”证书管理器”，有”受信任的根证书颁发机构”列表。客户端会根据这张列表，查看解开数字证书的公钥是否在列表之内。<br><a href="https://imgtu.com/i/I0anuq"><img src="https://z3.ax1x.com/2021/11/11/I0anuq.png" alt="I0anuq.png"></a></p><p>如果数字证书记载的网址，与你正在浏览的网址不一致，就说明这张证书可能被冒用，浏览器会发出警告。<br><a href="https://imgtu.com/i/I0auD0"><img src="https://z3.ax1x.com/2021/11/11/I0auD0.png" alt="I0auD0.png"></a></p><p>如果这张数字证书不是由受信任的机构颁发的，浏览器会发出另一种警告。<br><a href="https://imgtu.com/i/I0a6xA"><img src="https://z3.ax1x.com/2021/11/11/I0a6xA.png" alt="I0a6xA.png"></a></p><p>如果数字证书是可靠的，客户端就可以使用证书中的服务器公钥，对信息进行加密，然后与服务器交换加密信息。<br><a href="https://imgtu.com/i/I0agKI"><img src="https://z3.ax1x.com/2021/11/11/I0agKI.png" alt="I0agKI.png"></a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;/assets/css/APlayer.min.css&quot;&gt;&lt;script src=&quot;/assets/js/APlayer.min.js&quot; cla</summary>
      
    
    
    
    
    <category term="证书" scheme="https://www.hnswxx.cn/tags/%E8%AF%81%E4%B9%A6/"/>
    
  </entry>
  
</feed>
